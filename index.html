<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TKOH A&OT/IDSS E-training System</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;font-size:18px}
    .container{background:#fff;padding:60px;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,.2);max-width:1300px;width:100%;min-height:700px}
    .title{color:#2c3e50;font-size:42px;font-weight:bold;margin-bottom:25px;text-align:center}
    .subtitle{color:#7f8c8d;font-size:24px;margin-bottom:30px;text-align:center}
    .page{display:none}
    .page.active{display:block}
    .form-group{margin-bottom:18px;text-align:left;max-width:450px;margin-left:auto;margin-right:auto}
    .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:#2c3e50;font-size:18px}
    .form-group input,.form-group select{width:100%;padding:14px;border:2px solid #ecf0f1;border-radius:10px;font-size:18px;transition:border-color .3s;background:#fff}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:#3498db}
    .login-actions{display:flex;justify-content:center}
    .login-btn,.btn{padding:16px 28px;background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:transform .15s;margin:10px}
    .login-btn:hover,.btn:hover{transform:translateY(-2px)}
    .back-btn{padding:16px 28px;background:#636e72;color:#fff;border:none;border-radius:12px;font-size:18px;cursor:pointer;transition:background .3s;margin-top:15px}
    .back-btn:hover{background:#2d3436}
    .logout-btn{background:#e17055}
    .logout-btn:hover{background:#d63031}
    .error-msg{color:#e74c3c;font-size:16px;margin-top:10px;text-align:center}
    .toolbar{display:flex;gap:12px;justify-content:center;margin:10px 0 20px}
    .hidden{display:none!important}
    .grade-buttons{display:flex;gap:20px;justify-content:center;flex-wrap:wrap;margin:20px 0 30px}
    .grade-btn{padding:28px 32px;background:linear-gradient(135deg,#00b894,#00a085);color:#fff;border:none;border-radius:16px;font-size:22px;font-weight:700;cursor:pointer;transition:all .25s;min-width:180px;box-shadow:0 6px 20px rgba(0,0,0,.1)}
    .grade-btn:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .section-title{color:#2c3e50;font-size:28px;font-weight:800;margin:20px 0 18px;border-bottom:4px solid #ecf0f1;padding-bottom:12px;text-align:center}
    .staff-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin:10px 0 25px}
    .staff-btn{padding:28px;background:linear-gradient(135deg,#fd79a8,#e84393);color:#fff;border:none;border-radius:16px;font-size:22px;font-weight:700;cursor:pointer;transition:all .25s;box-shadow:0 6px 20px rgba(0,0,0,.1)}
    .staff-btn:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .staff-info{background:linear-gradient(135deg,#f8f9fa,#e9ecef);padding:26px;border-radius:16px;margin-bottom:20px;border-left:8px solid #00b894}
    .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;text-align:left}
    .info-item{display:flex;align-items:center}
    .info-label{font-weight:700;color:#2c3e50;width:140px;font-size:18px}
    .info-value{color:#34495e;font-size:18px;flex:1}
    .training-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:22px;margin-bottom:20px}
    .training-card{background:#fff;border-radius:18px;padding:26px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,.1);transition:all .25s;cursor:pointer;border:3px solid transparent;position:relative}
    .training-card:hover{transform:translateY(-6px);box-shadow:0 15px 40px rgba(0,0,0,.15);border-color:#00b894}
    .training-card.completed{background:linear-gradient(135deg,#00b894,#00a085);color:#fff}
    .training-icon{font-size:42px;margin-bottom:14px;display:block}
    .training-name{font-size:20px;font-weight:800;color:#2c3e50;margin-bottom:16px}
    .training-card.completed .training-name{color:#fff}
    .progress-circle{position:relative;width:120px;height:120px;margin:0 auto 12px}
    .progress-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;font-weight:800;color:#2c3e50}
    .training-card.completed .progress-text{color:#fff}
    .progress-info{font-size:16px;color:#7f8c8d;margin-top:8px}
    .training-card.completed .progress-info{color:rgba(255,255,255,.9)}
    .completed-badge{position:absolute;top:14px;right:14px;background:#00b894;color:#fff;padding:8px 12px;border-radius:18px;font-size:12px;font-weight:800}
    .records-grid{display:grid;gap:18px;text-align:left}
    .record-item{background:#fff;border:2px solid #ecf0f1;border-radius:14px;padding:22px;transition:all .25s;position:relative;cursor:pointer}
    .record-item:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.1)}
    .record-item.completed{border-color:#00b894;background:linear-gradient(135deg,#00b894,#00a085);color:#fff}
    .record-item.pending{border-color:#ffeaa7;background:linear-gradient(135deg,#ffeaa7,#fdcb6e)}
    .record-item.failed{border-color:#e74c3c;background:linear-gradient(135deg,#ffebee,#ffcdd2);color:#c62828}
    .record-status{position:absolute;top:14px;right:42px;padding:8px 14px;border-radius:18px;font-size:12px;font-weight:800}
    .record-status.completed{background:rgba(255,255,255,.2);color:#fff}
    .record-status.pending{background:rgba(0,0,0,.1);color:#2c3e50}
    .record-status.failed{background:#e74c3c;color:#fff}
    .record-name{font-size:20px;font-weight:800;margin-bottom:8px;padding-right:100px}
    .record-date{font-size:16px;opacity:.85}
    .assessment-section{background:linear-gradient(135deg,#fff3cd,#ffeaa7);padding:24px;border-radius:16px;margin-bottom:20px;border-left:8px solid #f39c12}
    .assessment-title{color:#e67e22;font-size:22px;font-weight:800;margin-bottom:15px;text-align:center;display:flex;align-items:center;justify-content:center;gap:12px}
    .assessment-grid{display:grid;gap:14px}
    .assessment-item{background:#fff;padding:18px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:space-between;transition:all .25s}
    .assessment-info{flex:1}
    .assessment-name{font-size:18px;font-weight:800;color:#2c3e50;margin-bottom:4px}
    .assessment-deadline{font-size:14px;color:#7f8c8d}
    .status-badge{padding:6px 12px;border-radius:16px;font-size:12px;font-weight:800;white-space:nowrap}
    .status-overdue{background:#e74c3c;color:#fff}
    .status-due-soon{background:#f39c12;color:#fff}
    .status-completed{background:#00b894;color:#fff}
    .status-pending{background:#95a5a6;color:#fff}
    .assessment-failed{border-left:6px solid #e74c3c;background:linear-gradient(135deg,#ffebee,#ffcdd2)!important;border:2px solid #e74c3c!important}
    .user-list{display:grid;gap:16px;margin-bottom:24px}
    .user-item{background:#fff;border:2px solid #ecf0f1;border-radius:14px;padding:20px;display:flex;align-items:center;justify-content:space-between;transition:all .25s}
    .user-item:hover{box-shadow:0 8px 25px rgba(0,0,0,.1)}
    .user-info{text-align:left;flex:1}
    .user-name{font-size:18px;font-weight:800;color:#2c3e50;margin-bottom:4px}
    .user-role{font-size:14px;color:#7f8c8d}
    .admin-controls{background:linear-gradient(135deg,#74b9ff,#0984e3);color:#fff;padding:22px;border-radius:14px;margin-bottom:24px}
    .admin-title{font-size:20px;font-weight:800;margin-bottom:12px}
    .admin-buttons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .admin-btn{padding:12px 20px;background:rgba(255,255,255,.2);color:#fff;border:2px solid rgba(255,255,255,.3);border-radius:10px;font-size:14px;font-weight:800;cursor:pointer;transition:all .25s}
    .admin-btn:hover{background:rgba(255,255,255,.3);border-color:#fff}
    .delete-btn{padding:10px 18px;background:#e74c3c;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:800;cursor:pointer;transition:all .25s;margin-left:10px}
    .delete-btn:hover{background:#c0392b;transform:translateY(-2px)}
    .edit-btn{padding:8px 14px;background:#f39c12;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:800;cursor:pointer;transition:all .25s}
    .edit-btn:hover{background:#e67e22}
    .item-actions{display:flex;gap:8px;align-items:center}
    .confirm-dialog{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:10000;display:flex;align-items:center;justify-content:center}
    .confirm-content{background:#fff;border-radius:18px;padding:26px;max-width:560px;width:90%;text-align:center}
    .confirm-title{font-size:20px;font-weight:800;color:#e74c3c;margin-bottom:10px}
    .confirm-message{font-size:16px;color:#2c3e50;margin:8px 0 18px;line-height:1.5}
    .confirm-buttons{display:flex;gap:10px;justify-content:center}
    .confirm-btn{padding:12px 20px;border:none;border-radius:10px;font-size:14px;font-weight:800;cursor:pointer;transition:all .25s}
    .confirm-yes{background:#e74c3c;color:#fff}
    .confirm-no{background:#95a5a6;color:#fff}
    .manage-layout{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:#fff;border:2px solid #ecf0f1;border-radius:14px;padding:18px}
    .card-title{font-size:18px;font-weight:800;margin-bottom:10px;color:#2c3e50}
    .list{display:grid;gap:10px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#f9fbfd;border:1px solid #ecf0f1;border-radius:10px;padding:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#eaf5ff;border:1px solid #cfe5ff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:800;color:#2c3e50}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#e8f5e9;border:1px solid #c8e6c9;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:800;color:#2c3e50}
    .danger{background:#ffebee;border-color:#ffcdd2}
    .mini-btn{padding:8px 12px;border:none;border-radius:8px;font-size:12px;font-weight:800;cursor:pointer}
    .mini-btn.add{background:#00b894;color:#fff}
    .mini-btn.del{background:#e74c3c;color:#fff}
    .mini-btn.neutral{background:#95a5a6;color:#fff}
    @media (max-width:768px){
      .container{padding:40px 24px}
      .title{font-size:32px}
      .grade-buttons{flex-direction:column}
      .training-grid,.staff-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ç™»å…¥ -->
    <div id="loginPage" class="page active">
      <div class="title">ğŸ¥ TKOH A&OT/IDSS<br/>E-training System</div>
      <div class="subtitle">åŸ¹è¨“ç®¡ç†ç³»çµ±</div>
      <div class="form-group">
        <label>Login ID</label>
        <input id="loginId" type="text" placeholder="è«‹è¼¸å…¥ç™»å…¥ID"/>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input id="password" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"/>
      </div>
      <div class="login-actions">
        <button class="login-btn" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
      </div>
      <div id="errorMsg" class="error-msg" style="display:none"></div>
      <div style="text-align:center;margin-top:16px;font-size:14px;color:#95a5a6">Created by Leung Nok Man Jeffrey (10/2025)</div>
    </div>

    <!-- ä¸»é¸å–® -->
    <div id="mainMenu" class="page">
      <div class="title">ğŸ¥ TKOH A&OT/IDSS E-training System</div>
      <div class="toolbar">
        <button id="btnGoManage" class="btn" onclick="showManagePage()">ğŸ› ï¸ æ›´æ”¹åŸ¹è¨“é …ç›®</button>
        <button id="btnUserMgmt" class="btn" onclick="showUserManagement()">ğŸ‘¥ å¸³æˆ¶ç®¡ç†</button>
        <button class="btn logout-btn" onclick="logout()">ğŸšª ç™»å‡º</button>
      </div>
      <div class="section-title">ğŸ‘¥ é¸æ“‡å“¡å·¥è·ç´š</div>
      <div class="grade-buttons">
        <button class="grade-btn" onclick="showStaffList('PCA1')">ğŸ©º<br/>PCA1</button>
        <button class="grade-btn" onclick="showStaffList('PCA2')">ğŸ¥<br/>PCA2</button>
        <button class="grade-btn" onclick="showStaffList('PCA3')">âš•ï¸<br/>PCA3</button>
        <button class="grade-btn" onclick="showStaffList('OTA')" style="background:linear-gradient(135deg,#a29bfe,#6c5ce7)">ğŸ”§<br/>OTA</button>
      </div>
    </div>

    <!-- å“¡å·¥åˆ—è¡¨ -->
    <div id="staffListPage" class="page">
      <div class="title">ğŸ‘¥ å“¡å·¥åˆ—è¡¨</div>
      <div class="subtitle" id="gradeInfo"></div>
      <div id="staffCount" class="subtitle" style="font-size:18px;color:#95a5a6;margin-top:-10px"></div>
      <div id="staffGrid" class="staff-grid"></div>
      <div style="text-align:center">
        <button class="back-btn" onclick="showMainMenu()">â† è¿”å›ä¸»é¸å–®</button>
      </div>
    </div>

    <!-- å“¡å·¥è©³æƒ… -->
    <div id="staffDetailsPage" class="page">
      <div class="title">ğŸ“‹ å“¡å·¥åŸ¹è¨“è¨˜éŒ„</div>
      <div id="staffInfoSection" class="staff-info"></div>
      <div class="assessment-section">
        <div class="assessment-title">ğŸ“… å„è©•ä¼°æ™‚é–“è¡¨</div>
        <div id="assessmentGrid" class="assessment-grid"></div>
      </div>
      <div class="section-title">ğŸ“ åŸ¹è¨“é …ç›®é€²åº¦</div>
      <div class="training-grid" id="trainingGrid"></div>
      <div style="text-align:center">
        <button class="back-btn" onclick="goBackToStaffList()">â† è¿”å›å“¡å·¥åˆ—è¡¨</button>
      </div>
    </div>

    <!-- åŸ¹è¨“è©³æƒ… -->
    <div id="trainingDetailsPage" class="page">
      <div class="title">ğŸ“š åŸ¹è¨“è©³æƒ…</div>
      <div id="trainingDetailContent"></div>
      <div style="text-align:center">
        <button class="back-btn" onclick="goBackToStaffDetails()">â† è¿”å›å“¡å·¥è¨˜éŒ„</button>
      </div>
    </div>

    <!-- å¸³æˆ¶ç®¡ç† -->
    <div id="userManagementPage" class="page">
      <div class="title">ğŸ‘¥ å¸³æˆ¶ç®¡ç†ç³»çµ±</div>
      <div class="subtitle">ç®¡ç†ç”¨æˆ¶å¸³æˆ¶å’Œæ¬Šé™</div>
      <div class="admin-controls">
        <div class="admin-title">ğŸ“Š ç®¡ç†å“¡æ§åˆ¶å°</div>
        <div class="admin-buttons">
          <button class="admin-btn" onclick="showAddUserModal()">â• æ–°å¢ç”¨æˆ¶</button>
          <button class="admin-btn" onclick="exportUserData()">ğŸ“¤ å°å‡ºç”¨æˆ¶è³‡æ–™</button>
        </div>
      </div>
      <div class="section-title">ğŸ‘¤ ç¾æœ‰ç”¨æˆ¶åˆ—è¡¨</div>
      <div id="userList" class="user-list"></div>
      <div style="text-align:center">
        <button class="back-btn" onclick="showMainMenu()">â† è¿”å›ä¸»é¸å–®</button>
      </div>
    </div>

    <!-- æ›´æ”¹åŸ¹è¨“é …ç›®ä»‹é¢ -->
    <div id="managePage" class="page">
      <div class="title">ğŸ› ï¸ æ›´æ”¹åŸ¹è¨“é …ç›®</div>
      <div class="toolbar" style="margin-top:-6px">
        <button class="btn" onclick="openAddAssessmentConfig()">â• æ–°å¢è©•ä¼°é …ç›®</button>
        <button class="btn" onclick="openAddTrainingCategory()">â• æ–°å¢åŸ¹è¨“é …ç›®</button>
        <button class="btn logout-btn" onclick="showMainMenu()">â¬…ï¸ è¿”å›ä¸»é¸å–®</button>
      </div>
      <div class="manage-layout">
        <div class="card">
          <div class="card-title">ğŸ“… è©•ä¼°é …ç›®ï¼ˆå…¨åŸŸå¥—ç”¨ï¼‰</div>
          <div id="manageAssessList" class="list"></div>
        </div>
        <div class="card">
          <div class="card-title">ğŸ“š åŸ¹è¨“é …ç›®ï¼ˆå°è±¡ï¼šPCA / OTAï¼‰</div>
          <div style="font-size:14px;color:#7f8c8d;margin-bottom:10px">èªªæ˜ï¼šæ¯å€‹åŸ¹è¨“é …ç›®éœ€æŒ‡å®šé©ç”¨å°è±¡ï¼ˆPCA æˆ– OTAï¼›å¯å¤šé¸ï¼‰ã€‚å»ºç«‹/åˆªé™¤å°‡åŒæ­¥æ‰€æœ‰å“¡å·¥ã€‚</div>
          <div id="manageCategoryList" class="list"></div>
        </div>
        <div class="card">
          <div class="card-title">ğŸ“‹ åŸ¹è¨“è¨˜éŒ„æ¨¡æ¿ï¼ˆé¸æ“‡ä¸Šæ–¹æŸåŸ¹è¨“é …ç›®ä»¥ç®¡ç†ï¼‰</div>
          <div id="selectedCategoryInfo" style="margin-bottom:8px;color:#2c3e50;font-weight:800">æœªé¸æ“‡</div>
          <div class="toolbar" style="justify-content:flex-start">
            <button id="btnAddTemplateRecord" class="btn" onclick="openAddTemplateRecord()" disabled>â• æ–°å¢åŸ¹è¨“è¨˜éŒ„</button>
          </div>
          <div id="manageRecordTemplateList" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const userAccounts = {
      'tkohot': { username:'tkohot', password:'A123456*#', role:'admin', name:'ç³»çµ±ç®¡ç†å“¡', email:'admin@tkoh.hk', createdDate:'01/01/2024' }
    };
    const staffDatabase = { 'PCA1': [], 'PCA2': [], 'PCA3': [], 'OTA': [] };
    const staffData = {};
    let assessmentConfig = [
      { id:'safety_001', name:'è·å®‰å¥ç°¡ä»‹åŠæ¸¬è©¦', weeksDeadline:1, type:'safety' },
      { id:'written_001', name:'ç­†è©¦', weeksDeadline:20, type:'written' },
      { id:'training_001', name:'å®ŒæˆåŸ¹è¨“é …ç›®', weeksDeadline:24, type:'training' }
    ];
    let trainingTemplates = {};
    let currentUser = null;
    let currentUserRole = null;
    let currentGrade = '';
    let currentStaffId = '';
    let currentCategory = '';
    let currentRecordIndex = -1;
    let selectedTemplateKey = null;

    function getCurrentDate(){
      const d=new Date(); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function addWeeksToDate(dateStr, weeks){
      const [dd,mm,yy]=dateStr.split('/').map(x=>parseInt(x,10));
      const d=new Date(yy, mm-1, dd); d.setDate(d.getDate()+weeks*7);
      const nd=String(d.getDate()).padStart(2,'0'), nm=String(d.getMonth()+1).padStart(2,'0'), ny=d.getFullYear();
      return `${nd}/${nm}/${ny}`;
    }
    function daysBetweenDates(a,b){
      const [d1,m1,y1]=a.split('/').map(n=>parseInt(n,10));
      const [d2,m2,y2]=b.split('/').map(n=>parseInt(n,10));
      const A=new Date(y1,m1-1,d1), B=new Date(y2,m2-1,d2);
      return Math.ceil((B-A)/(1000*60*60*24));
    }
    function showToast(icon,msg,color){
      const el=document.createElement('div');
      el.style.cssText=`position:fixed;top:20px;right:20px;z-index:9999;background:${color};color:#fff;padding:12px 18px;border-radius:10px;font-weight:800;box-shadow:0 4px 15px rgba(0,0,0,.2);font-size:14px`;
      el.textContent=`${icon} ${msg}`; document.body.appendChild(el); setTimeout(()=>el.remove(),2200);
    }
    function showError(msg){ const e=document.getElementById('errorMsg'); e.textContent=msg; e.style.display='block'; }
    function clearLoginForm(){ document.getElementById('loginId').value=''; document.getElementById('password').value=''; document.getElementById('errorMsg').style.display='none'; }
    function hideAll(){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); }
    function showMainMenu(){ hideAll(); document.getElementById('mainMenu').classList.add('active'); applyRoleVisibility(); }
    function goBackToStaffList(){ hideAll(); document.getElementById('staffListPage').classList.add('active'); }
    function goBackToStaffDetails(){ hideAll(); document.getElementById('staffDetailsPage').classList.add('active'); }
    function applyRoleVisibility(){
      const isAdmin = currentUserRole==='admin';
      const isSupervisor = currentUserRole==='supervisor';
      document.getElementById('btnUserMgmt')?.classList.toggle('hidden', !isAdmin);
      document.getElementById('btnGoManage')?.classList.toggle('hidden', !(isAdmin||isSupervisor));
    }

    function syncTemplatesToAllStaff(){
      Object.keys(staffData).forEach(staffId=>{
        const staff = staffData[staffId];
        if (!staff.assessments) staff.assessments = {};
        assessmentConfig.forEach(a=>{ if (!staff.assessments[a.type]) staff.assessments[a.type] = {passed:false, failed:false}; });
        if (!staff.trainingCategories) staff.trainingCategories = {};
        Object.entries(trainingTemplates).forEach(([key, tpl])=>{
          const targetMatch = (staff.grade==='OTA') ? tpl.target?.ota : tpl.target?.pca;
          if (targetMatch){
            if (!staff.trainingCategories[key]){
              staff.trainingCategories[key] = {
                name: tpl.name, icon: tpl.icon, total: (tpl.recordsTemplate?.length||0),
                completed: 0, records: (tpl.recordsTemplate||[]).map(r=>({
                  name: r.name, type: r.type || 'simple', completed:false, failed:false, date:null,
                  assessmentItems: r.assessmentItems ? r.assessmentItems.map((t)=>({name:t.name, isCritical:!!t.isCritical, passed:false, failed:false})) : null,
                  totalItems: r.assessmentItems ? r.assessmentItems.length : undefined,
                  completedItems: 0, failedItems: 0, passMark: r.passMark || (r.type==='assessment'||r.type==='checklist'?50:undefined)
                }))
              };
            } else {
              const cat = staff.trainingCategories[key];
              const existingNames = new Set(cat.records.map(r=>r.name));
              (tpl.recordsTemplate||[]).forEach(r=>{
                if (!existingNames.has(r.name)){
                  cat.records.push({
                    name:r.name, type:r.type||'simple', completed:false, failed:false, date:null,
                    assessmentItems: r.assessmentItems ? r.assessmentItems.map((t)=>({name:t.name, isCritical:!!t.isCritical, passed:false, failed:false})) : null,
                    totalItems: r.assessmentItems ? r.assessmentItems.length : undefined,
                    completedItems: 0, failedItems: 0, passMark: r.passMark || (r.type==='assessment'||r.type==='checklist'?50:undefined)
                  });
                }
              });
              cat.total = cat.records.length;
              cat.completed = cat.records.filter(r=>r.completed && !r.failed).length;
              cat.name = tpl.name;
              cat.icon = tpl.icon;
            }
          } else {
            if (staff.trainingCategories[key]) delete staff.trainingCategories[key];
          }
        });
      });
    }

    async function handleLogin(){
      const loginId=document.getElementById('loginId').value.trim();
      const password=document.getElementById('password').value.trim();
      if (!loginId || !password){ showError('è«‹è¼¸å…¥Login IDå’ŒPassword'); return; }
      const user=userAccounts[loginId];
      if (!user || user.password!==password){ showError('Login IDæˆ–PasswordéŒ¯èª¤'); return; }
      currentUser=user; currentUserRole=user.role;
      hideAll();
      if (currentUserRole==='admin' || currentUserRole==='supervisor'){ document.getElementById('mainMenu').classList.add('active'); }
      else { showError('æœ¬ç³»çµ±ç›®å‰åªé–‹æ”¾ç³»çµ±ç®¡ç†å“¡/ä¸»ç®¡ç™»å…¥'); document.getElementById('loginPage').classList.add('active'); return; }
      showToast('âœ…', `æ­¡è¿ï¼Œ${user.name}ï¼`, '#00b894');
      clearLoginForm(); applyRoleVisibility();
    }

    function logout(){
      if (confirm('ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ')){
        currentUser=null; currentUserRole=null;
        hideAll(); document.getElementById('loginPage').classList.add('active');
        clearLoginForm();
      }
    }

    function showStaffList(grade){
      if (!(currentUserRole==='admin' || currentUserRole==='supervisor')){ alert('âŒ æ¬Šé™ä¸è¶³ï¼'); return; }
      currentGrade=grade;
      hideAll(); document.getElementById('staffListPage').classList.add('active');
      document.getElementById('gradeInfo').textContent = `è·ç´šï¼š${grade}`;
      const list = staffDatabase[grade] || [];
      document.getElementById('staffCount').textContent = `å…± ${list.length} ä½å“¡å·¥`;
      const grid=document.getElementById('staffGrid');
      grid.innerHTML = list.length===0 ? `<div class="subtitle" style="font-size:18px;color:#95a5a6">æ­¤è·ç´šç›®å‰æ²’æœ‰å“¡å·¥</div>` :
        list.map(s=>`<button class="staff-btn" onclick="showStaffDetails('${s.id}')">ğŸ‘¤ ${s.name}</button>`).join('');
    }

    function calcAssessmentStatus(joinDate, weeksDeadline, assessments, type){
      const deadline = addWeeksToDate(joinDate, weeksDeadline);
      const now = getCurrentDate();
      const d = daysBetweenDates(now, deadline);
      const a = assessments[type] || {passed:false,failed:false};
      if (a.passed) return {status:'completed',deadline,d,badge:'âœ… åˆæ ¼'};
      if (a.failed) return {status:'completed',deadline,d,badge:'âŒ ä¸åˆæ ¼'};
      if (d<0) return {status:'overdue',deadline,d,badge:`âš ï¸ é€¾æœŸ ${Math.abs(d)} å¤©`};
      if (d<=7) return {status:'due-soon',deadline,d,badge:`ğŸ”” ${d} å¤©å¾Œåˆ°æœŸ`};
      return {status:'pending',deadline,d,badge:`ğŸ“… ${d} å¤©å¾Œåˆ°æœŸ`};
    }

    function showStaffDetails(staffId){
      currentStaffId = staffId;
      const staff = staffData[staffId];
      if (!staff){ alert('æ‰¾ä¸åˆ°å“¡å·¥è³‡æ–™'); return; }
      if (!staff.assessments) staff.assessments = {};
      assessmentConfig.forEach(a=>{ if (!staff.assessments[a.type]) staff.assessments[a.type] = {passed:false,failed:false}; });
      syncTemplatesToAllStaff();
      hideAll(); document.getElementById('staffDetailsPage').classList.add('active');

      document.getElementById('staffInfoSection').innerHTML = `
        <div class="info-grid">
          <div class="info-item"><div class="info-label">ğŸ‘¤ å§“åï¼š</div><div class="info-value">${staff.name}</div></div>
          <div class="info-item"><div class="info-label">ğŸ†” å“¡å·¥ç·¨è™Ÿï¼š</div><div class="info-value">${staff.employeeId}</div></div>
          <div class="info-item"><div class="info-label">ğŸ¥ è·ç´šï¼š</div><div class="info-value">${staff.grade}</div></div>
          <div class="info-item"><div class="info-label">ğŸ“… å…¥è·æ—¥æœŸï¼š</div><div class="info-value">${staff.joinDate}</div></div>
        </div>
      `;

      const aGrid=document.getElementById('assessmentGrid');
      aGrid.innerHTML = assessmentConfig.map(a=>{
        const s=calcAssessmentStatus(staff.joinDate,a.weeksDeadline,staff.assessments,a.type);
        const failed = staff.assessments[a.type]?.failed;
        return `
          <div class="assessment-item ${failed?'assessment-failed':s.status}">
            <div class="assessment-info">
              <div class="assessment-name">${a.name}</div>
              <div class="assessment-deadline">æˆªæ­¢æ—¥æœŸï¼š${s.deadline} ${s.d>=0?`(å…¥è·å¾Œ ${a.weeksDeadline} é€±)`: `(å·²é€¾æœŸ ${Math.abs(s.d)} å¤©)`}</div>
            </div>
            <div><span class="status-badge status-${s.status}">${s.badge}</span></div>
          </div>
        `;
      }).join('');

      const tGrid=document.getElementById('trainingGrid');
      const cats = staff.trainingCategories || {};
      tGrid.innerHTML = Object.entries(cats).map(([key,cat])=>{
        const pct = cat.total>0 ? Math.round((cat.completed/cat.total)*100) : 0;
        const done = pct===100;
        return `
          <div class="training-card ${done?'completed':''}" onclick="showTrainingDetails('${key}')">
            ${done?'<div class="completed-badge">âœ… å®Œæˆ</div>':''}
            <div class="training-icon">${cat.icon||'ğŸ“š'}</div>
            <div class="training-name">${cat.name}</div>
            <div class="progress-circle">
              <svg width="120" height="120" viewBox="0 0 140 140">
                <circle cx="70" cy="70" r="60" fill="none" stroke="${done?'rgba(255,255,255,.3)':'#ecf0f1'}" stroke-width="12"></circle>
                <circle cx="70" cy="70" r="60" fill="none" stroke="${done?'#fff': (pct>0?'#74b9ff':'#ecf0f1')}" stroke-width="12"
                  stroke-dasharray="${2*Math.PI*60}" stroke-dashoffset="${2*Math.PI*60*(1-pct/100)}"
                  transform="rotate(-90 70 70)" stroke-linecap="round"></circle>
              </svg>
              <div class="progress-text">${pct}%</div>
            </div>
            <div class="progress-info">${cat.completed}/${cat.total} é …ç›®å®Œæˆ ${done?'<br/>ğŸ‰ å…¨éƒ¨å®Œæˆï¼':''}</div>
          </div>
        `;
      }).join('') || `<div class="subtitle" style="font-size:18px;color:#95a5a6">æ­¤å“¡å·¥æš«ç„¡åŸ¹è¨“é …ç›®</div>`;
    }

    function showTrainingDetails(categoryKey){
      currentCategory=categoryKey;
      const staff=staffData[currentStaffId];
      const cat=staff.trainingCategories[categoryKey];
      if (!cat){ alert('æ‰¾ä¸åˆ°åŸ¹è¨“è³‡æ–™'); return; }
      hideAll(); document.getElementById('trainingDetailsPage').classList.add('active');

      const pct = cat.total>0? Math.round((cat.completed/cat.total)*100) : 0;
      const done = pct===100;
      const color = done?'#00b894':'#74b9ff';

      const content=document.getElementById('trainingDetailContent');
      content.innerHTML = `
        <div class="staff-info" style="margin-bottom:16px">ğŸ‘¤ ${staff.name} (${staff.employeeId})</div>
        <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px">
          <div class="training-icon" style="font-size:48px">${cat.icon||'ğŸ“š'}</div>
          <div class="training-name" style="margin:0">${cat.name}</div>
        </div>
        <div class="card" style="margin-bottom:16px">
          <div class="card-title" style="text-align:center">é€²åº¦</div>
          <div style="display:flex;justify-content:center">
            <svg width="170" height="170" viewBox="0 0 170 170">
              <circle cx="85" cy="85" r="75" fill="none" stroke="#ecf0f1" stroke-width="14"></circle>
              <circle cx="85" cy="85" r="75" fill="none" stroke="${color}" stroke-width="14"
                stroke-dasharray="${2*Math.PI*75}" stroke-dashoffset="${2*Math.PI*75*(1-pct/100)}"
                transform="rotate(-90 85 85)" stroke-linecap="round"></circle>
            </svg>
          </div>
          <div style="display:flex;justify-content:center;gap:24px;margin-top:12px;flex-wrap:wrap">
            <div><div style="color:#00b894;font-weight:800;font-size:22px;text-align:center">${cat.completed}</div><div style="font-size:13px;color:#7f8c8d">å·²å®Œæˆ</div></div>
            <div><div style="color:#fd79a8;font-weight:800;font-size:22px;text-align:center">${cat.total - cat.completed}</div><div style="font-size:13px;color:#7f8c8d">å¾…å®Œæˆ</div></div>
            <div><div style="color:#2c3e50;font-weight:800;font-size:22px;text-align:center">${cat.total}</div><div style="font-size:13px;color:#7f8c8d">ç¸½é …ç›®</div></div>
          </div>
          ${done?'<div style="margin-top:14px;font-size:18px;color:#00b894;font-weight:800;text-align:center">ğŸ‰ æ­å–œï¼æ‰€æœ‰åŸ¹è¨“é …ç›®å·²å®Œæˆ</div>':''}
        </div>
        <div class="section-title">ğŸ“‹ åŸ¹è¨“è¨˜éŒ„æ˜ç´°</div>
        <div id="recordsGrid" class="records-grid"></div>
      `;
      const grid=document.getElementById('recordsGrid');
      grid.innerHTML = cat.records.map((r,idx)=>{
        const statusClass = r.failed ? 'failed' : (r.completed ? 'completed' : 'pending');
        const statusText = r.failed ? 'âŒ ä¸åˆæ ¼éœ€é‡åš' : (r.completed ? 'âœ… å·²å®Œæˆ' : 'â³ å¾…å®Œæˆ');
        const dateText = r.failed ? `è©•æ ¸æ—¥æœŸï¼š${r.date||'-'} | ç‹€æ…‹ï¼šéœ€è¦é‡æ–°è©•æ ¸` : (r.completed ? `å®Œæˆæ—¥æœŸï¼š${r.date||'-'}` : 'å°šæœªå®Œæˆ');
        return `
          <div class="record-item ${statusClass}" onclick="openRecord(${idx})">
            <div class="record-status ${statusClass}">${statusText}</div>
            <div class="record-name">${r.name}</div>
            <div class="record-date">${dateText}</div>
            ${(r.type==='assessment'||r.type==='checklist') && r.assessmentItems ? `
              <div style="margin-top:8px;font-size:13px;opacity:.85">ğŸ“‹ ${r.type==='assessment'?'è©•æ ¸é …ç›®':'æª¢æŸ¥æ¸…å–®'} (${r.completedItems||0}/${r.totalItems} é€šé${r.failedItems?`, ${r.failedItems} ä¸åˆæ ¼`:''})</div>
            `:''}
          </div>
        `;
      }).join('') || `<div class="subtitle" style="font-size:18px;color:#95a5a6">æ­¤åˆ†é¡å°šç„¡è¨˜éŒ„</div>`;
    }

    async function openRecord(index){
      const staff=staffData[currentStaffId];
      const cat=staff.trainingCategories[currentCategory];
      const rec=cat.records[index];
      currentRecordIndex=index;

      if (rec.type==='assessment' || rec.type==='checklist'){
        openAssessmentModal(rec);
      } else {
        if (currentUserRole==='admin' || currentUserRole==='supervisor'){
          rec.completed = !rec.completed;
          rec.date = rec.completed ? getCurrentDate() : null;
          cat.completed = cat.records.filter(r=>r.completed && !r.failed).length;
          
          try {
            if (!window.firebaseReady) {
              showToast('âš ï¸', 'Firebase æœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œé‡è©¦', '#f39c12');
              return;
            }
            if (window.saveTrainingProgressToFirebase) {
              await window.saveTrainingProgressToFirebase(currentStaffId, currentCategory, index, rec.completed, false);
            }
          } catch (e) {
            console.error('âŒ å„²å­˜å¤±æ•—:', e);
            showToast('âŒ', 'å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', '#e74c3c');
            rec.completed = !rec.completed; // å›æ»¾ç‹€æ…‹
            rec.date = rec.completed ? getCurrentDate() : null;
            cat.completed = cat.records.filter(r=>r.completed && !r.failed).length;
            return;
          }
          
          showTrainingDetails(currentCategory);
          showToast(rec.completed?'âœ…':'â³', `ã€Œ${rec.name}ã€å·²${rec.completed?'å®Œæˆ':'å–æ¶ˆå®Œæˆ'}ï¼`, rec.completed?'#00b894':'#f39c12');
        }
      }
    }

    function openAssessmentModal(record){
      validateAssessmentItems(record);
      const roleCan = (currentUserRole==='admin'||currentUserRole==='supervisor');
      const modal=document.createElement('div');
      modal.className='confirm-dialog';
      const completedItems = record.assessmentItems? record.assessmentItems.filter(i=>i.passed).length : 0;
      const totalItems = record.assessmentItems? record.assessmentItems.length : 0;
      const pct = totalItems>0? Math.round((completedItems/totalItems)*100):0;

      modal.innerHTML = `
        <div class="confirm-content" style="max-width:720px;text-align:left">
          <div class="card-title">ğŸ“‹ ${record.name}</div>
          <div style="font-size:14px;color:#2c3e50;font-weight:800;margin-bottom:8px">é€²åº¦ï¼š${completedItems}/${totalItems} (${pct}%) ${record.passMark?`| åˆæ ¼åˆ†æ•¸: ${record.passMark}`:''}</div>
          <div class="list" style="max-height:50vh;overflow:auto">
            ${record.assessmentItems? record.assessmentItems.map((it,idx)=>`
              <div class="row" id="assRow${idx}">
                <div style="flex:1">
                  ${it.isCritical?'<span class="pill danger" style="margin-right:6px;color:#c62828;border-color:#ffcdd2;background:#ffebee">CRITICAL</span>':''}
                  <span>${it.name}</span>
                </div>
                <div>
                  <button class="mini-btn" style="background:#00b894;color:#fff" ${roleCan?`onclick="setItemResult(${idx},'pass')"`:'disabled'}>${roleCan?'âœ… é€šé':'ğŸ”’ ç„¡æ¬Šé™'}</button>
                  <button class="mini-btn" style="background:#e74c3c;color:#fff" ${roleCan?`onclick="setItemResult(${idx},'fail')"`:'disabled'}>${roleCan?'âŒ ä¸åˆæ ¼':'ğŸ”’ ç„¡æ¬Šé™'}</button>
                  <button class="mini-btn neutral" ${roleCan?`onclick="setItemResult(${idx},'reset')"`:'disabled'}>${roleCan?'ğŸ”„ é‡è¨­':'ğŸ”’ ç„¡æ¬Šé™'}</button>
                </div>
              </div>
            `).join('') : '<div>æ²’æœ‰è©•æ ¸é …ç›®</div>'}
          </div>
          <div class="confirm-buttons" style="margin-top:12px">
            <button class="confirm-btn confirm-no" onclick="closeAnyDialog()">é—œé–‰</button>
            ${roleCan?'<button class="confirm-btn confirm-yes" onclick="finishAssessment()">å®Œæˆè©•æ ¸</button>':''}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      window.currentConfirmDialog = modal;
      if (record.assessmentItems){
        record.assessmentItems.forEach((it,idx)=>{
          const row=document.getElementById(`assRow${idx}`);
          if (row){
            if (it.passed) row.style.background='linear-gradient(135deg,#d4edda,#c3e6cb)';
            else if (it.failed) row.style.background='linear-gradient(135deg,#f8d7da,#f5c6cb)';
          }
        });
      }
    }

    function closeAnyDialog(){ if (window.currentConfirmDialog){ document.body.removeChild(window.currentConfirmDialog); window.currentConfirmDialog=null; } }

    function validateAssessmentItems(record){
      if (!record.assessmentItems) return;
      record.assessmentItems.forEach((i,k)=>{
        if (i.isCritical===undefined) i.isCritical=false;
        if (i.passed===undefined) i.passed=false;
        if (i.failed===undefined) i.failed=false;
        if (!i.name) i.name=`é …ç›®${k+1}`;
        i.isCritical=!!i.isCritical; i.passed=!!i.passed; i.failed=!!i.failed; i.name=String(i.name);
      });
    }

    async function setItemResult(idx, result){
      const staff=staffData[currentStaffId];
      const cat=staff.trainingCategories[currentCategory];
      const rec=cat.records[currentRecordIndex];
      const item=rec.assessmentItems[idx];
      
      if (!(currentUserRole==='admin'||currentUserRole==='supervisor')) return;
      
      item.passed=false; item.failed=false;
      if (result==='pass') item.passed=true;
      if (result==='fail') item.failed=true;
      
      const row=document.getElementById(`assRow${idx}`);
      if (row){
        row.style.background = item.passed? 'linear-gradient(135deg,#d4edda,#c3e6cb)' :
                             item.failed? 'linear-gradient(135deg,#f8d7da,#f5c6cb)' : '#f9fbfd';
      }
      
      // æ”¹é€²å˜…å„²å­˜é‚è¼¯
      try {
        if (!window.firebaseReady) {
          throw new Error('Firebase æœªæº–å‚™å¥½');
        }
        if (window.saveTrainingProgressToFirebase) {
          await window.saveTrainingProgressToFirebase(currentStaffId, currentCategory, currentRecordIndex);
          console.log('âœ… Item result saved');
        }
      } catch (e) {
        console.error('âŒ Failed to save:', e);
        showToast('âŒ', 'å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', '#e74c3c');
      }
    }

    async function finishAssessment(){
      const staff=staffData[currentStaffId];
      const cat=staff.trainingCategories[currentCategory];
      const rec=cat.records[currentRecordIndex];
      const passed = rec.assessmentItems? rec.assessmentItems.filter(i=>i.passed).length : 0;
      const failed = rec.assessmentItems? rec.assessmentItems.filter(i=>i.failed).length : 0;
      const total  = rec.assessmentItems? rec.assessmentItems.length : 0;

      if (!rec.assessmentItems || total===0 || (passed===0 && failed===0)){
        rec.completed=false; rec.failed=false; rec.date=null; rec.status='pending';
        cat.completed = cat.records.filter(r=>r.completed && !r.failed).length;
        
        try {
          if (!window.firebaseReady) {
            throw new Error('Firebase æœªæº–å‚™å¥½');
          }
          if (window.saveTrainingProgressToFirebase) {
            await window.saveTrainingProgressToFirebase(currentStaffId, currentCategory, currentRecordIndex, false, false);
          }
        } catch (e) {
          console.error('âŒ å„²å­˜å¤±æ•—:', e);
          showToast('âŒ', 'å„²å­˜å¤±æ•—: ' + e.message, '#e74c3c');
          return; // å””é—œé–‰ dialogï¼Œç­‰ç”¨æˆ¶å¯ä»¥é‡è©¦
        }
        
        showToast('â³','å·²é‡è¨­ç‚ºå¾…å®Œæˆ','#f39c12');
        closeAnyDialog(); showTrainingDetails(currentCategory); return;
      }

      const critical = rec.assessmentItems.filter(i=>i.isCritical);
      const criticalPassed = critical.filter(i=>i.passed).length;
      const totalCritical = critical.length;
      const score = Math.round((passed/total)*100);
      const passMark = rec.passMark || 50;
      const okCritical = totalCritical===0 || (criticalPassed===totalCritical);
      const okScore = score>=passMark;

      if (!okCritical || !okScore){
        rec.completed=false; rec.failed=true; rec.date=getCurrentDate(); rec.status='failed';
        showToast('âŒ', `ä¸åˆæ ¼ï¼${!okCritical?`Critical ${criticalPassed}/${totalCritical} æœªå…¨é€šé`:''} ${!okScore?` åˆ†æ•¸ ${score}/${passMark}`:''}`, '#e74c3c');
      } else {
        rec.completed=true; rec.failed=false; rec.date=getCurrentDate(); rec.status='completed';
        showToast('ğŸ‰', `è©•æ ¸å®Œæˆï¼åˆ†æ•¸ ${score}/100`, '#00b894');
      }
      
      cat.completed = cat.records.filter(r=>r.completed && !r.failed).length;
      
      try {
        if (!window.firebaseReady) {
          throw new Error('Firebase æœªæº–å‚™å¥½');
        }
        if (window.saveTrainingProgressToFirebase) {
          await window.saveTrainingProgressToFirebase(currentStaffId, currentCategory, currentRecordIndex, rec.completed, rec.failed);
        }
      } catch (e) {
        console.error('âŒ å„²å­˜å¤±æ•—:', e);
        showToast('âŒ', 'å„²å­˜å¤±æ•—: ' + e.message, '#e74c3c');
        return; // å””é—œé–‰ dialogï¼Œç­‰ç”¨æˆ¶å¯ä»¥é‡è©¦
      }
      
      closeAnyDialog(); 
      showTrainingDetails(currentCategory);
    }

    function showManagePage(){
      if (!(currentUserRole==='admin' || currentUserRole==='supervisor')){ alert('âŒ æ¬Šé™ä¸è¶³ï¼'); return; }
      hideAll(); document.getElementById('managePage').classList.add('active');
      renderManageAssessments(); renderManageCategories(); renderTemplateRecords();
    }

    function renderManageAssessments(){
      const box=document.getElementById('manageAssessList');
      box.innerHTML = assessmentConfig.map(a=>`
        <div class="row">
          <div style="display:flex;flex-direction:column;gap:4px">
            <div style="font-weight:800">${a.name}</div>
            <div style="font-size:12px;color:#7f8c8d">å…¥è·å¾Œ ${a.weeksDeadline} é€± | key: ${a.type}</div>
          </div>
          ${currentUserRole==='admin'? `<button class="mini-btn del" onclick="deleteAssessmentConfig('${a.id}','${a.type}','${a.name}')">åˆªé™¤</button>`:''}
        </div>
      `).join('') || `<div class="row"><div>å°šæœªæ–°å¢ä»»ä½•è©•ä¼°é …ç›®</div></div>`;
    }

    function openAddAssessmentConfig(){
      if (currentUserRole!=='admin'){ alert('åƒ…ç³»çµ±ç®¡ç†å“¡å¯æ–°å¢'); return; }
      const dlg=document.createElement('div'); dlg.className='confirm-dialog';
      dlg.innerHTML = `
        <div class="confirm-content" style="max-width:520px">
          <div class="card-title">â• æ–°å¢è©•ä¼°é …ç›®</div>
          <div class="form-group" style="margin:auto">
            <label>åç¨±</label>
            <input id="assName" type="text" placeholder="ä¾‹å¦‚ï¼šå¯¦ç¿’æœŸè©•ä¼°">
          </div>
          <div class="form-group" style="margin:auto">
            <label>æ™‚é–“é™åˆ¶ï¼ˆé€±ï¼‰</label>
            <input id="assWeeks" type="number" min="1" max="52" value="4">
          </div>
          <div class="confirm-buttons" style="margin-top:8px">
            <button class="confirm-btn confirm-no" onclick="closeAnyDialog()">å–æ¶ˆ</button>
            <button class="confirm-btn confirm-yes" onclick="addAssessmentConfig()">æ–°å¢</button>
          </div>
        </div>
      `;
      document.body.appendChild(dlg); window.currentConfirmDialog=dlg;
    }

    async function addAssessmentConfig(){
      const name=document.getElementById('assName').value.trim();
      const weeks=parseInt(document.getElementById('assWeeks').value,10);
      if (!name || !weeks || weeks<1){ alert('è«‹è¼¸å…¥æœ‰æ•ˆåç¨±èˆ‡é€±æ•¸'); return; }
      const item={ id:`assessment_${Date.now()}`, name, weeksDeadline:weeks, type:`custom_${Date.now()}` };
      assessmentConfig.push(item);
      Object.keys(staffData).forEach(sid=>{
        const s=staffData[sid];
        if (!s.assessments) s.assessments = {};
        if (!s.assessments[item.type]) s.assessments[item.type] = {passed:false, failed:false};
      });
      try{ if (window.saveAssessmentConfigToFirebase) await window.saveAssessmentConfigToFirebase(item); showToast('âœ…','å·²æ–°å¢è©•ä¼°é …ç›®','#f39c12'); }catch(e){ console.error(e); showToast('âŒ','å„²å­˜å¤±æ•—','#e74c3c'); }
      closeAnyDialog(); renderManageAssessments();
    }

    async function deleteAssessmentConfig(id,type,name){
      if (currentUserRole!=='admin'){ alert('åƒ…ç³»çµ±ç®¡ç†å“¡å¯åˆªé™¤'); return; }
      if (!confirm(`åˆªé™¤è©•ä¼°é …ç›®ã€Œ${name}ã€ï¼Ÿæ­¤æ“ä½œæœƒå½±éŸ¿æ‰€æœ‰å“¡å·¥ã€‚`)) return;
      const idx=assessmentConfig.findIndex(x=>x.id===id);
      if (idx>-1) assessmentConfig.splice(idx,1);
      Object.keys(staffData).forEach(sid=>{
        if (staffData[sid].assessments && staffData[sid].assessments[type]) delete staffData[sid].assessments[type];
      });
      try{
        if (window.deleteAssessmentConfigFromFirebase) await window.deleteAssessmentConfigFromFirebase(id);
        showToast('ğŸ—‘ï¸','å·²åˆªé™¤è©•ä¼°é …ç›®','#e74c3c');
      }catch(e){ console.error(e); showToast('âŒ','åˆªé™¤å¤±æ•—','#e74c3c'); }
      renderManageAssessments();
    }

    function renderManageCategories(){
      const box=document.getElementById('manageCategoryList');
      const entries = Object.entries(trainingTemplates);
      if (entries.length===0){ box.innerHTML = `<div class="row"><div>å°šæœªæ–°å¢ä»»ä½•åŸ¹è¨“é …ç›®</div></div>`; return; }
      box.innerHTML = entries.map(([key, tpl])=>`
        <div class="row">
          <div style="display:flex;flex-direction:column;gap:4px;cursor:pointer" onclick="selectTemplate('${key}')">
            <div style="font-weight:800">${tpl.icon||'ğŸ“š'} ${tpl.name}</div>
            <div style="font-size:12px;color:#7f8c8d">key: ${key} | å°è±¡ï¼š${tpl.target?.pca?'PCA':''}${tpl.target?.pca && tpl.target?.ota ? ' / ':''}${tpl.target?.ota?'OTA':''} | è¨˜éŒ„æ•¸ï¼š${(tpl.recordsTemplate||[]).length}</div>
          </div>
          ${currentUserRole==='admin'? `
            <div>
              <button class="mini-btn neutral" onclick="editTemplateTarget('${key}')">å°è±¡</button>
              <button class="mini-btn del" onclick="deleteTrainingTemplate('${key}')">åˆªé™¤</button>
            </div>
          `:''}
        </div>
      `).join('');
    }

    function selectTemplate(key){
      selectedTemplateKey=key;
      document.getElementById('selectedCategoryInfo').textContent = `å·²é¸æ“‡ï¼š${trainingTemplates[key].name}ï¼ˆkey: ${key}ï¼‰`;
      document.getElementById('btnAddTemplateRecord').disabled = !(currentUserRole==='admin');
      renderTemplateRecords();
    }

    function editTemplateTarget(key){
      if (currentUserRole!=='admin'){ alert('åƒ…ç³»çµ±ç®¡ç†å“¡å¯ä¿®æ”¹'); return; }
      const tpl=trainingTemplates[key];
      const dlg=document.createElement('div'); dlg.className='confirm-dialog';
      dlg.innerHTML = `
        <div class="confirm-content">
          <div class="card-title">é©ç”¨å°è±¡</div>
          <div style="margin:10px 0">
            <label style="margin-right:10px"><input id="chkPCA" type="checkbox" ${tpl.target?.pca?'checked':''}> PCA</label>
            <label><input id="chkOTA" type="checkbox" ${tpl.target?.ota?'checked':''}> OTA</label>
          </div>
          <div class="confirm-buttons">
            <button class="confirm-btn confirm-no" onclick="closeAnyDialog()">å–æ¶ˆ</button>
            <button class="confirm-btn confirm-yes" onclick="saveTemplateTarget('${key}')">å„²å­˜</button>
          </div>
        </div>
      `;
      document.body.appendChild(dlg); window.currentConfirmDialog=dlg;
    }

    async function saveTemplateTarget(key){
      const pca = document.getElementById('chkPCA').checked;
      const ota = document.getElementById('chkOTA').checked;
      if (!pca && !ota){ alert('è‡³å°‘é¸æ“‡ä¸€å€‹å°è±¡'); return; }
      trainingTemplates[key].target = {pca, ota};
      try{ if (window.saveTrainingTemplateToFirebase) await window.saveTrainingTemplateToFirebase(key, trainingTemplates[key]); showToast('âœ…','å·²æ›´æ–°å°è±¡','#00b894'); }catch(e){ console.error(e); showToast('âŒ','å„²å­˜å¤±æ•—','#e74c3c'); }
      closeAnyDialog(); syncTemplatesToAllStaff(); renderManageCategories();
    }

    function openAddTrainingCategory(){
      if (currentUserRole!=='admin'){ alert('åƒ…ç³»çµ±ç®¡ç†å“¡å¯æ–°å¢'); return; }
      const dlg=document.createElement('div'); dlg.className='confirm-dialog';
      dlg.innerHTML = `
        <div class="confirm-content" style="max-width:560px">
          <div class="card-title">â• æ–°å¢åŸ¹è¨“é …ç›®</div>
          <div class="form-group" style="margin:auto">
            <label>åç¨±</label>
            <input id="tplName" type="text" placeholder="ä¾‹å¦‚ï¼šEndoscope åŸºç¤">
          </div>
          <div class="form-group" style="margin:auto">
            <label>åœ–æ¨™ï¼ˆEmojiï¼‰</label>
            <input id="tplIcon" type="text" value="ğŸ“š">
            <div style="font-size:12px;color:#7f8c8d;margin:8px 0 6px">å¸¸ç”¨åœ–æ¨™</div>
            <div id="emojiQuick" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:flex-start">
              ${['ğŸ“š','ğŸ“˜','ğŸ§ª','ğŸ§¬','ğŸ©º','ğŸ¥','âš•ï¸','ğŸ§¼','ğŸ§¯','ğŸ§¤','ğŸ©¹','ğŸ’‰','ğŸ”¬','ğŸ”§','ğŸ›¡ï¸','âœ…','âŒ','â³','ğŸ””','ğŸ“…','ğŸ“','ğŸ—‚ï¸','ğŸ§­','ğŸ§°','ğŸ“','ğŸ“ˆ','ğŸ“‰'].map(e=>`<button type="button" class="mini-btn" style="background:#eaf5ff;color:#2c3e50" data-emoji="${e}">${e}</button>`).join('')}
            </div>
            <div style="font-size:12px;color:#7f8c8d;margin:10px 0 6px">é†«è­·/è¨­å‚™/é€²åº¦</div>
            <div id="emojiSets" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:flex-start">
              ${['ğŸ©º','ğŸ¥','âš•ï¸','ğŸ’Š','ğŸ§«','ğŸ§ª','ğŸ§¬','ğŸ§´','ğŸ§¼','ğŸ§¯','ğŸ§¤','ğŸ©¹','ğŸ’‰','ğŸ§ ','ğŸ«','ğŸ«€','ğŸ¦´','ğŸ”¬','ğŸ”§','ğŸ§°','ğŸ›¡ï¸','âœ…','âŒ','â³','ğŸ””','ğŸ“…','ğŸ“ˆ','ğŸ“‰','ğŸ“','ğŸ“š','ğŸ“˜','ğŸ“'].map(e=>`<button type="button" class="mini-btn" style="background:#eefaf3;color:#2c3e50" data-emoji="${e}">${e}</button>`).join('')}
            </div>
          </div>
          <div class="form-group" style="margin:auto">
            <label>é©ç”¨å°è±¡ï¼ˆå¯å¤šé¸ï¼‰</label>
            <div>
              <label style="margin-right:10px"><input id="tplPCA" type="checkbox" checked> PCA</label>
              <label><input id="tplOTA" type="checkbox"> OTA</label>
            </div>
          </div>
          <div class="confirm-buttons">
            <button class="confirm-btn confirm-no" onclick="closeAnyDialog()">å–æ¶ˆ</button>
            <button class="confirm-btn confirm-yes" onclick="addTrainingTemplate()">æ–°å¢</button>
          </div>
        </div>
      `;
      document.body.appendChild(dlg); window.currentConfirmDialog=dlg;
      Array.from(dlg.querySelectorAll('#emojiQuick button, #emojiSets button')).forEach(btn=>{
        btn.addEventListener('click', ()=>{ dlg.querySelector('#tplIcon').value = btn.getAttribute('data-emoji'); });
      });
    }

    async function addTrainingTemplate(){
      const name=document.getElementById('tplName').value.trim();
      const icon=document.getElementById('tplIcon').value.trim()||'ğŸ“š';
      const pca=document.getElementById('tplPCA').checked;
      const ota=document.getElementById('tplOTA').checked;
      if (!name || (!pca && !ota)){ alert('è«‹è¼¸å…¥åç¨±èˆ‡è‡³å°‘ä¸€å€‹å°è±¡'); return; }
      const key = `${name.replace(/\s+/g,'_').toLowerCase()}_${Date.now()}`;
      trainingTemplates[key] = { name, icon, target:{pca,ota}, recordsTemplate:[] };
      try{ if (window.saveTrainingTemplateToFirebase) await window.saveTrainingTemplateToFirebase(key, trainingTemplates[key]); showToast('âœ…','å·²æ–°å¢åŸ¹è¨“é …ç›®','#00b894'); }catch(e){ console.error(e); showToast('âŒ','å„²å­˜å¤±æ•—','#e74c3c'); }
      closeAnyDialog(); syncTemplatesToAllStaff(); renderManageCategories(); selectTemplate(key); renderManageAssessments();
    }

    async function deleteTrainingTemplate(key){
      if (currentUserRole!=='admin'){ alert('åƒ…ç³»çµ±ç®¡ç†å“¡å¯åˆªé™¤'); return; }
      if (!confirm(`åˆªé™¤åŸ¹è¨“é …ç›®ã€Œ${trainingTemplates[key].name}ã€ï¼Ÿæ­¤æ“ä½œæœƒåŒæ­¥ç§»é™¤æ‰€æœ‰å“¡å·¥è©²åˆ†é¡ã€‚`)) return;
      const name = trainingTemplates[key].name;
      delete trainingTemplates[key];
      Object.keys(staffData).forEach(sid=>{
        if (staffData[sid].trainingCategories && staffData[sid].trainingCategories[key]) delete staffData[sid].trainingCategories[key];
      });
      try{ if (window.deleteTrainingTemplateFromFirebase) await window.deleteTrainingTemplateFromFirebase(key); showToast('ğŸ—‘ï¸','å·²åˆªé™¤åŸ¹è¨“é …ç›®','#e74c3c'); }catch(e){ console.error(e); showToast('âŒ','åˆªé™¤å¤±æ•—','#e74c3c'); }
      if (selectedTemplateKey===key){ selectedTemplateKey=null; document.getElementById('selectedCategoryInfo').textContent='æœªé¸æ“‡'; document.getElementById('btnAddTemplateRecord').disabled=true; }
      renderManageCategories(); renderTemplateRecords();
    }

    function renderTemplateRecords(){
      const box=document.getElementById('manageRecordTemplateList');
      if (!selectedTemplateKey){ box.innerHTML='<div class="row"><div>è«‹å…ˆæ–¼ä¸Šæ–¹é¸æ“‡ä¸€å€‹åŸ¹è¨“é …ç›®</div></div>'; return; }
      const tpl=trainingTemplates[selectedTemplateKey];
      const arr=tpl.recordsTemplate||[];
      if (arr.length===0){ box.innerHTML='<div class="row"><div>å°šæœªæ–°å¢ä»»ä½•åŸ¹è¨“è¨˜éŒ„æ¨¡æ¿</div></div>'; return; }
      box.innerHTML = arr.map((r,idx)=>`
        <div class="row">
          <div style="display:flex;flex-direction:column;gap:4px">
            <div style="font-weight:800">${r.name}</div>
            <div style="font-size:12px;color:#7f8c8d">é¡å‹ï¼š${r.type||'simple'} ${r.passMark?`| åˆæ ¼åˆ†æ•¸ï¼š${r.passMark}`:''} ${r.assessmentItems?`| é …ç›®æ•¸ï¼š${r.assessmentItems.length}`:''}</div>
          </div>
          ${currentUserRole==='admin'? `<button class="mini-btn del" onclick="deleteTemplateRecord(${idx})">åˆªé™¤</button>`:''}
        </div>
      `).join('');
    }

    function openAddTemplateRecord(){
      if (currentUserRole!=='admin'){ alert('åƒ…ç³»çµ±ç®¡ç†å“¡å¯æ–°å¢'); return; }
      if (!selectedTemplateKey){ alert('è«‹å…ˆé¸æ“‡åŸ¹è¨“é …ç›®'); return; }
      const dlg=document.createElement('div'); dlg.className='confirm-dialog';
      dlg.innerHTML = `
        <div class="confirm-content" style="max-width:720px">
          <div class="card-title">â• æ–°å¢åŸ¹è¨“è¨˜éŒ„æ¨¡æ¿</div>
          <div class="form-group" style="margin:auto">
            <label>åç¨±</label>
            <input id="recName" type="text" placeholder="è¨˜éŒ„åç¨±">
          </div>
          <div class="form-group" style="margin:auto">
            <label>é¡å‹</label>
            <select id="recType">
              <option value="simple">ç°¡å–®è¨˜éŒ„ (å®Œæˆ/æœªå®Œæˆ)</option>
              <option value="assessment">è©•æ ¸é …ç›®</option>
              <option value="checklist">æª¢æŸ¥æ¸…å–®</option>
            </select>
          </div>
          <div id="wrapPass" class="form-group" style="margin:auto;display:none">
            <label>åˆæ ¼åˆ†æ•¸ï¼ˆ0-100ï¼‰</label>
            <input id="recPass" type="number" min="0" max="100" value="50">
          </div>
          <div id="wrapItems" class="form-group" style="margin:auto;display:none">
            <label>è©•æ ¸é …ç›®ï¼ˆæ¯è¡Œä¸€é …ï¼›åœ¨é—œéµé …ç›®å¾ŒåŠ  [CRITICAL]ï¼‰</label>
            <textarea id="recItems" style="width:100%;height:140px;padding:12px;border:2px solid #ecf0f1;border-radius:10px;font-size:14px;resize:vertical" placeholder="ä¾‹å¦‚ï¼š&#10;æº–å‚™è¨­å‚™ [CRITICAL]&#10;æ“ä½œæµç¨‹&#10;å®‰å…¨æª¢æŸ¥"></textarea>
          </div>
          <div class="confirm-buttons">
            <button class="confirm-btn confirm-no" onclick="closeAnyDialog()">å–æ¶ˆ</button>
            <button class="confirm-btn confirm-yes" onclick="addTemplateRecord()">æ–°å¢</button>
          </div>
        </div>
      `;
      document.body.appendChild(dlg); window.currentConfirmDialog=dlg;
      const sel=dlg.querySelector('#recType');
      sel.addEventListener('change',function(){
        const adv = (this.value==='assessment'||this.value==='checklist');
        document.getElementById('wrapPass').style.display = adv? 'block':'none';
        document.getElementById('wrapItems').style.display = adv? 'block':'none';
      });
    }

    async function addTemplateRecord(){
      const name=document.getElementById('recName').value.trim();
      const type=document.getElementById('recType').value;
      const tpl=trainingTemplates[selectedTemplateKey];
      if (!name){ alert('è«‹è¼¸å…¥åç¨±'); return; }
      const rec = { name, type };
      if (type==='assessment' || type==='checklist'){
        const pass=parseInt(document.getElementById('recPass').value||'50',10);
        const lines=(document.getElementById('recItems').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
        if (lines.length===0){ alert('è«‹è¼¸å…¥è©•æ ¸é …ç›®'); return; }
        rec.passMark = pass;
        rec.assessmentItems = lines.map(s=>({ name:s.replace(/\[CRITICAL\]/gi,'').trim(), isCritical:/\[CRITICAL\]/i.test(s) }));
      }
      tpl.recordsTemplate = tpl.recordsTemplate || [];
      tpl.recordsTemplate.push(rec);
      try{ if (window.saveTemplateRecordToFirebase) await window.saveTemplateRecordToFirebase(selectedTemplateKey, rec); showToast('âœ…','å·²æ–°å¢åŸ¹è¨“è¨˜éŒ„æ¨¡æ¿','#00b894'); }catch(e){ console.error(e); showToast('âŒ','å„²å­˜å¤±æ•—','#e74c3c'); }
      closeAnyDialog(); syncTemplatesToAllStaff(); renderTemplateRecords();
    }

    async function deleteTemplateRecord(idx){
      if (currentUserRole!=='admin'){ alert('åƒ…ç³»çµ±ç®¡ç†å“¡å¯åˆªé™¤'); return; }
      const tpl=trainingTemplates[selectedTemplateKey];
      const rec=tpl.recordsTemplate[idx];
      if (!confirm(`åˆªé™¤è¨˜éŒ„æ¨¡æ¿ã€Œ${rec.name}ã€ï¼Ÿå°‡åŒæ­¥å¾æ‰€æœ‰å“¡å·¥çš„æ­¤åˆ†é¡ä¸­ç§»é™¤ç›¸åŒåç¨±çš„è¨˜éŒ„ã€‚`)) return;
      tpl.recordsTemplate.splice(idx,1);
      Object.keys(staffData).forEach(sid=>{
        const cat = staffData[sid].trainingCategories?.[selectedTemplateKey];
        if (cat){
          const i = cat.records.findIndex(r=>r.name===rec.name);
          if (i>-1){ cat.records.splice(i,1); cat.total = cat.records.length; cat.completed = cat.records.filter(r=>r.completed && !r.failed).length; }
        }
      });
      try{ if (window.saveTrainingTemplateToFirebase) await window.saveTrainingTemplateToFirebase(selectedTemplateKey, trainingTemplates[selectedTemplateKey]); showToast('ğŸ—‘ï¸','å·²åˆªé™¤è¨˜éŒ„æ¨¡æ¿','#e74c3c'); }catch(e){ console.error(e); showToast('âŒ','åˆªé™¤è¨˜éŒ„å„²å­˜å¤±æ•—','#e74c3c'); }
      renderTemplateRecords();
    }

    function showUserManagement(){
      if (currentUserRole!=='admin'){ alert('âŒ æ¬Šé™ä¸è¶³ï¼åªæœ‰ç³»çµ±ç®¡ç†å“¡å¯ä½¿ç”¨å¸³æˆ¶ç®¡ç†ï¼'); return; }
      hideAll(); document.getElementById('userManagementPage').classList.add('active');
      renderUsers();
    }

    function renderUsers(){
      const box=document.getElementById('userList');
      const users=Object.values(userAccounts);
      box.innerHTML = users.map(u=>{
        const roleMap={admin:'ç³»çµ±ç®¡ç†å“¡',supervisor:'ä¸»ç®¡',staff:'å“¡å·¥'};
        const roleColor = u.role==='admin'?'#e74c3c': (u.role==='supervisor'?'#f39c12':'#00b894');
        return `
          <div class="user-item">
            <div class="user-info">
              <div class="user-name">${u.name} (@${u.username})</div>
              <div class="user-role" style="color:${roleColor}">
                ğŸ‘¤ ${roleMap[u.role]||u.role}
                ${u.role==='staff' && u.grade? ` | ğŸ¥ è·ç´šï¼š${u.grade}`:''}
                ${u.staffId? ` | ğŸ†” StaffID: ${u.staffId}`:''}
                | ğŸ“§ ${u.email||'-'} | ğŸ“… ${u.createdDate||'-'}
              </div>
            </div>
            <div class="item-actions">
              ${u.role!=='admin'? `<button class="delete-btn" onclick="confirmDeleteUser('${u.username}','${u.name}')">ğŸ—‘ï¸ åˆªé™¤</button>`:''}
            </div>
          </div>
        `;
      }).join('');
    }

    function showAddUserModal(){
      if (currentUserRole!=='admin'){ alert('åƒ…ç³»çµ±ç®¡ç†å“¡å¯æ–°å¢'); return; }
      const dlg=document.createElement('div'); dlg.className='confirm-dialog';
      dlg.innerHTML = `
        <div class="confirm-content" style="max-width:620px">
          <div class="card-title">â• æ–°å¢ç”¨æˆ¶</div>
          <div class="form-group" style="margin:auto">
            <label>å§“å</label>
            <input id="newUserName" type="text" placeholder="å§“å">
          </div>
          <div class="form-group" style="margin:auto">
            <label>è§’è‰²</label>
            <select id="newUserRole">
              <option value="supervisor">ä¸»ç®¡</option>
              <option value="staff">å“¡å·¥</option>
            </select>
          </div>
          <div class="form-group" style="margin:auto" id="gradeRow">
            <label>è·ç´š</label>
            <select id="newUserGrade"></select>
          </div>
          <div class="form-group" style="margin:auto">
            <label>Login ID</label>
            <input id="newUserLogin" type="text" placeholder="ç™»å…¥ID">
          </div>
          <div class="form-group" style="margin:auto">
            <label>Password</label>
            <input id="newUserPassword" type="password" placeholder="å¯†ç¢¼">
          </div>
          <div class="confirm-buttons">
            <button class="confirm-btn confirm-no" onclick="closeAnyDialog()">å–æ¶ˆ</button>
            <button class="confirm-btn confirm-yes" onclick="addNewUser()">æ–°å¢</button>
          </div>
        </div>
      `;
      document.body.appendChild(dlg); window.currentConfirmDialog=dlg;

      const roleSel=dlg.querySelector('#newUserRole');
      const gradeSel=dlg.querySelector('#newUserGrade');
      function refreshGrades(){
        const role=roleSel.value;
        gradeSel.innerHTML='';
        if (role==='supervisor'){ ['RN','APN','WM'].forEach(g=>{ const opt=document.createElement('option'); opt.value=g; opt.textContent=g; gradeSel.appendChild(opt); }); }
        else { ['PCA1','PCA2','PCA3','OTA'].forEach(g=>{ const opt=document.createElement('option'); opt.value=g; opt.textContent=g; gradeSel.appendChild(opt); }); }
      }
      roleSel.addEventListener('change', refreshGrades); refreshGrades();
    }

    async function addNewUser(){
      const dlg = window.currentConfirmDialog;
      const name = dlg.querySelector('#newUserName').value.trim();
      const role = dlg.querySelector('#newUserRole').value;
      const grade= dlg.querySelector('#newUserGrade').value;
      const login= dlg.querySelector('#newUserLogin').value.trim();
      const pw   = dlg.querySelector('#newUserPassword').value.trim();

      if (!name || !role || !login || !pw){ alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™'); return; }
      if (userAccounts[login]){ alert('Login ID å·²å­˜åœ¨'); return; }

      const newUser = { username:login, password:pw, role, name, email:'', createdDate:getCurrentDate() };

      if (role==='staff'){
        const staffId = `${name.replace(/\s+/g,'_').toLowerCase()}_${Date.now().toString().slice(-4)}`;
        const newStaff = { name, employeeId:`${Math.floor(100000+Math.random()*900000)}`, grade, joinDate:getCurrentDate(), assessments:{}, trainingCategories:{} };
        assessmentConfig.forEach(a=>{ newStaff.assessments[a.type] = {passed:false, failed:false}; });
        staffData[staffId] = newStaff;
        if (!staffDatabase[grade]) staffDatabase[grade]=[];
        staffDatabase[grade].push({id:staffId, name});
        newUser.staffId = staffId;
        newUser.grade = grade;
        syncTemplatesToAllStaff();
        try{ if (window.saveStaffToFirebase) await window.saveStaffToFirebase(staffId,newStaff); }catch(e){ console.error(e); }
      }

      if (role==='supervisor'){ newUser.grade = grade; }

      userAccounts[login] = newUser;
      try{ if (window.saveUserToFirebase) await window.saveUserToFirebase(newUser); }catch(e){ console.error(e); }

      showToast('âœ…','å·²æ–°å¢ç”¨æˆ¶','#00b894');
      closeAnyDialog(); renderUsers();
    }

    function confirmDeleteUser(username, name){
      if (currentUserRole!=='admin'){ alert('åƒ…ç³»çµ±ç®¡ç†å“¡å¯åˆªé™¤'); return; }
      const dlg=document.createElement('div'); dlg.className='confirm-dialog';
      dlg.innerHTML = `
        <div class="confirm-content">
          <div class="confirm-title">åˆªé™¤ç”¨æˆ¶ç¢ºèª</div>
          <div class="confirm-message">ç¢ºå®šåˆªé™¤ç”¨æˆ¶ã€Œ${name} (@${username})ã€ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</div>
          <div class="confirm-buttons">
            <button class="confirm-btn confirm-no" onclick="closeAnyDialog()">å–æ¶ˆ</button>
            <button class="confirm-btn confirm-yes" onclick="deleteUser('${username}')">åˆªé™¤</button>
          </div>
        </div>
      `;
      document.body.appendChild(dlg); window.currentConfirmDialog=dlg;
    }

    async function deleteUser(username){
      const user=userAccounts[username];
      if (!user){ closeAnyDialog(); return; }
      if (user.role==='staff' && user.staffId && staffData[user.staffId]){
        const grade=staffData[user.staffId].grade;
        delete staffData[user.staffId];
        if (staffDatabase[grade]){
          const i=staffDatabase[grade].findIndex(s=>s.id===user.staffId);
          if (i>-1) staffDatabase[grade].splice(i,1);
        }
        try{ if (window.deleteStaffFromFirebase) await window.deleteStaffFromFirebase(user.staffId); }catch(e){ console.error(e); }
      }
      delete userAccounts[username];
      try{ if (window.deleteUserFromFirebase) await window.deleteUserFromFirebase(username); }catch(e){ console.error(e); }
      showToast('ğŸ—‘ï¸','ç”¨æˆ¶å·²åˆªé™¤','#e74c3c');
      closeAnyDialog(); renderUsers();
    }

    function exportUserData(){
      const data = Object.values(userAccounts);
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='users.json'; a.click();
      URL.revokeObjectURL(url);
    }

    // ä½”ä½å‡½æ•¸ï¼Œæœƒåœ¨ Firebase module è¼‰å…¥å¾Œè¦†è“‹
    window.saveAssessmentConfigToFirebase = async function(){ console.warn('Firebase å°šæœªè¼‰å…¥'); };
    window.deleteAssessmentConfigFromFirebase = async function(){ console.warn('Firebase å°šæœªè¼‰å…¥'); };
    window.saveTrainingTemplateToFirebase = async function(){ console.warn('Firebase å°šæœªè¼‰å…¥'); };
    window.deleteTrainingTemplateFromFirebase = async function(){ console.warn('Firebase å°šæœªè¼‰å…¥'); };
    window.saveTemplateRecordToFirebase = async function(){ console.warn('Firebase å°šæœªè¼‰å…¥'); };
    window.saveStaffToFirebase = async function(){ console.warn('Firebase å°šæœªè¼‰å…¥'); };
    window.deleteStaffFromFirebase = async function(){ console.warn('Firebase å°šæœªè¼‰å…¥'); };
    window.saveUserToFirebase = async function(){ console.warn('Firebase å°šæœªè¼‰å…¥'); };
    window.deleteUserFromFirebase = async function(){ console.warn('Firebase å°šæœªè¼‰å…¥'); };
    window.saveTrainingProgressToFirebase = async function(){ console.warn('Firebase å°šæœªè¼‰å…¥'); };

    document.addEventListener('keypress', e=>{
      if (e.key==='Enter' && document.getElementById('loginPage').classList.contains('active')) handleLogin();
    });

    syncTemplatesToAllStaff();
  </script>

  <!-- Firebase CRUD æ¨¡å¼ -->
<script type="module">
  // ========== Import Firebase SDKs ==========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { 
    getFirestore, 
    collection, 
    doc, 
    getDoc, 
    getDocs, 
    setDoc, 
    deleteDoc 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ========== Firebase Configuration ==========
  const firebaseConfig = {
    apiKey: "AIzaSyBlLQdM2xL9U0uczsi4eJjyBU56_U9qGUE",
    authDomain: "tkoh-otidss-training.firebaseapp.com",
    projectId: "tkoh-otidss-training",
    storageBucket: "tkoh-otidss-training.firebasestorage.app",
    messagingSenderId: "362761345155",
    appId: "1:362761345155:web:729b2534075b29db01a3b6"
  };

  let app, db;

  // ========== åˆå§‹åŒ– Firebase ==========
  async function initFirebase() {
    try {
      console.log('ğŸ”§ æ­£åœ¨åˆå§‹åŒ– Firebase...');
      
      // Initialize Firebase App
      app = initializeApp(firebaseConfig);
      
      // Initialize Firestore
      db = getFirestore(app);
      
      // Make globally accessible
      window.db = db;
      window.firebaseApp = app;
      
      console.log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
      console.log('ğŸ“¦ Firestore instance:', db);
      
      return true; // âœ… æ­£ç¢ºï¼šreturn å–º function å…¥é¢
      
    } catch (error) {
      console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', error);
      alert('âš ï¸ è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼\n\néŒ¯èª¤ï¼š' + error.message);
      return false; // âœ… æ­£ç¢ºï¼šreturn å–º function å…¥é¢
    }
  }

  // ========== Test Firestore Connection ==========
  async function testFirestoreConnection() {
    try {
      console.log('ğŸ” æ¸¬è©¦ Firestore é€£ç·š...');
      
      const testRef = collection(db, 'staff');
      const snapshot = await getDocs(testRef);
      
      console.log('âœ… Firestore é€£ç·šæ­£å¸¸');
      console.log(`ğŸ“Š æ‰¾åˆ° ${snapshot.size} ç­†å“¡å·¥è³‡æ–™`);
      
      return true;
    } catch (error) {
      console.error('âŒ Firestore é€£ç·šæ¸¬è©¦å¤±æ•—:', error);
      return false;
    }
  }

  // ========== CRUD å‡½æ•¸ ==========
  window.saveTrainingProgressToFirebase = async function(staffId, categoryKey = null, recordIndex = null, completed = null, failed = null){
  console.log('ğŸ’¾ é–‹å§‹å„²å­˜:', { staffId, categoryKey, recordIndex, completed, failed }); // âœ… åŠ å‘¢è¡Œ
  
  if (!db) {
    console.error('âŒ Firebase æœªåˆå§‹åŒ–');
    alert('âŒ è³‡æ–™åº«æœªé€£ç·šï¼'); // âœ… åŠ å‘¢è¡Œ
    return;
  }
  
  try {
    const staff = window.staffData[staffId];
    if (!staff) {
      throw new Error('æ‰¾ä¸åˆ°å“¡å·¥è³‡æ–™: ' + staffId);
    }
    
    console.log('ğŸ“ æ›´æ–°å‰è³‡æ–™:', JSON.parse(JSON.stringify(staff))); // âœ… åŠ å‘¢è¡Œ
    
    if (categoryKey && recordIndex !== null && categoryKey in staff.trainingCategories) {
      const cat = staff.trainingCategories[categoryKey];
      if (cat.records[recordIndex]) {
        if (completed !== null) cat.records[recordIndex].completed = completed;
        if (failed !== null) cat.records[recordIndex].failed = failed;
        cat.completed = cat.records.filter(r => r.completed && !r.failed).length;
      }
    }
    
    console.log('ğŸ“ æ›´æ–°å¾Œè³‡æ–™:', JSON.parse(JSON.stringify(staff))); // âœ… åŠ å‘¢è¡Œ
    
    // é–‹å§‹å¯«å…¥ Firestore
    console.log('â¬†ï¸ æ­£åœ¨å¯«å…¥ Firestore...'); // âœ… åŠ å‘¢è¡Œ
    
    await setDoc(doc(db, 'staff', staffId), { 
      staffId, 
      staffData: staff,
      lastUpdated: new Date().toISOString()
    }, { merge: true });
    
    console.log('âœ… Firestore å„²å­˜æˆåŠŸ:', staffId); // âœ… åŠ å‘¢è¡Œ
    alert('âœ… å„²å­˜æˆåŠŸï¼'); // âœ… åŠ å‘¢è¡Œï¼ˆæ¸¬è©¦ç”¨ï¼‰
    
  } catch (error) {
    console.error('âŒ å„²å­˜å¤±æ•—:', error);
    console.error('éŒ¯èª¤è©³æƒ…:', error.code, error.message); // âœ… åŠ å‘¢è¡Œ
    alert('âŒ å„²å­˜å¤±æ•—ï¼\n\n' + error.message); // âœ… åŠ å‘¢è¡Œ
    throw error;
  }
};

  window.saveAssessmentConfigToFirebase = async function(assessment){
    if (!db) return; // âœ… æ­£ç¢º
    const ref = doc(db, 'assessment-config', assessment.id);
    await setDoc(ref, assessment, { merge: true });
  };
  
  window.deleteAssessmentConfigFromFirebase = async function(assessmentId){
    if (!db) return; // âœ… æ­£ç¢º
    await deleteDoc(doc(db, 'assessment-config', assessmentId));
  };

  window.saveTrainingTemplateToFirebase = async function(key, template){
    if (!db) return; // âœ… æ­£ç¢º
    await setDoc(doc(db, 'training-templates', key), { key, ...template }, { merge: true });
  };
  
  window.deleteTrainingTemplateFromFirebase = async function(key){
    if (!db) return; // âœ… æ­£ç¢º
    await deleteDoc(doc(db, 'training-templates', key));
  };
  
  window.saveTemplateRecordToFirebase = async function(templateKey, record){
    if (!db) return; // âœ… æ­£ç¢º
    const ref = doc(db, 'training-templates', templateKey);
    const snap = await getDoc(ref);
    const data = snap.exists() ? snap.data() : { key: templateKey, recordsTemplate: [] };
    const list = Array.isArray(data.recordsTemplate) ? data.recordsTemplate : [];
    if (!list.find(r => r.name === record.name)){
      list.push(record);
      await setDoc(ref, { recordsTemplate: list }, { merge: true });
    }
  };

  window.saveUserToFirebase = async function(user){
    if (!db) return; // âœ… æ­£ç¢º
    await setDoc(doc(db, 'users', user.username), user, { merge: true });
  };
  
  window.deleteUserFromFirebase = async function(username){
    if (!db) return; // âœ… æ­£ç¢º
    await deleteDoc(doc(db, 'users', username));
  };

  window.saveStaffToFirebase = async function(staffId, data){
    if (!db) return; // âœ… æ­£ç¢º
    await setDoc(doc(db, 'staff', staffId), { 
      staffId, 
      staffData: data,
      lastUpdated: new Date().toISOString()
    }, { merge: true });
  };
  
  window.deleteStaffFromFirebase = async function(staffId){
    if (!db) return; // âœ… æ­£ç¢º
    await deleteDoc(doc(db, 'staff', staffId));
  };

  // ========== è¼‰å…¥è³‡æ–™ ==========
  async function loadAllFromFirebase(){
    if (!db) {
      console.error('âŒ ç„¡æ³•è¼‰å…¥ï¼šFirebase æœªåˆå§‹åŒ–');
      return false;
    }
    
    try {
      console.log('â³ é–‹å§‹è¼‰å…¥è³‡æ–™...');
      
      // è©•ä¼°é …ç›®
      const assSnap = await getDocs(collection(db, 'assessment-config'));
      window.assessmentConfig = [];
      assSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data?.id) window.assessmentConfig.push(data);
      });
      console.log('âœ… è©•ä¼°é …ç›®:', window.assessmentConfig.length);

      // åŸ¹è¨“æ¨¡æ¿
      const tplSnap = await getDocs(collection(db, 'training-templates'));
      window.trainingTemplates = {};
      tplSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data?.key) {
          window.trainingTemplates[data.key] = {
            name: data.name || 'æœªå‘½å',
            icon: data.icon || 'ğŸ“š',
            target: data.target || { pca: true, ota: false },
            recordsTemplate: Array.isArray(data.recordsTemplate) ? data.recordsTemplate : []
          };
        }
      });
      console.log('âœ… åŸ¹è¨“æ¨¡æ¿:', Object.keys(window.trainingTemplates).length);

      // ç”¨æˆ¶
      const usersSnap = await getDocs(collection(db, 'users'));
      window.userAccounts = window.userAccounts || {};
      usersSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data?.username) window.userAccounts[data.username] = data;
      });
      console.log('âœ… ç”¨æˆ¶æ•¸é‡:', Object.keys(window.userAccounts).length);

      // å“¡å·¥
      const staffSnap = await getDocs(collection(db, 'staff'));
      window.staffDatabase = { PCA1: [], PCA2: [], PCA3: [], OTA: [] };
      window.staffData = window.staffData || {};
      
      staffSnap.forEach(docSnap => {
        const data = docSnap.data();
        const staffId = data?.staffId;
        const staffData = data?.staffData;
        
        if (staffId && staffData) {
          window.staffData[staffId] = staffData;
          const grade = staffData.grade;
          
          if (window.staffDatabase[grade]) {
            if (!window.staffDatabase[grade].some(s => s.id === staffId)) {
              window.staffDatabase[grade].push({ 
                id: staffId, 
                name: staffData.name 
              });
            }
          }
        }
      });
      console.log('âœ… å“¡å·¥æ•¸é‡:', Object.keys(window.staffData).length);

      // Sync templates
      if (typeof window.syncTemplatesToAllStaff === 'function') {
        window.syncTemplatesToAllStaff();
      }

      console.log('ğŸ‰ è³‡æ–™è¼‰å…¥å®Œæˆï¼');
      return true;
      
    } catch (error) {
      console.error('âŒ è³‡æ–™è¼‰å…¥å¤±æ•—:', error);
      alert('âš ï¸ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼\n\n' + error.message);
      return false;
    }
  }

  // ========== å•Ÿå‹•ç³»çµ± ==========
  window.addEventListener('load', async () => {
    console.log('ğŸš€ ç³»çµ±å•Ÿå‹•ä¸­...');
    
    // Step 1: Initialize Firebase
    const firebaseOK = await initFirebase();
    if (!firebaseOK) {
      console.error('âŒ ç³»çµ±å•Ÿå‹•å¤±æ•—ï¼šFirebase åˆå§‹åŒ–å¤±æ•—');
      window.firebaseReady = false;
      return; // âœ… æ­£ç¢ºï¼šreturn å–º event handler å…¥é¢
    }
    
    // Step 2: Test connection
    const connectionOK = await testFirestoreConnection();
    if (!connectionOK) {
      console.error('âŒ ç³»çµ±å•Ÿå‹•å¤±æ•—ï¼šFirestore é€£ç·šå¤±æ•—');
      window.firebaseReady = false;
      return; // âœ… æ­£ç¢º
    }
    
    // Step 3: Load data
    const dataOK = await loadAllFromFirebase();
    if (!dataOK) {
      console.error('âŒ ç³»çµ±å•Ÿå‹•å¤±æ•—ï¼šè³‡æ–™è¼‰å…¥å¤±æ•—');
      window.firebaseReady = false;
      return; // âœ… æ­£ç¢º
    }
    
    // Step 4: System ready
    window.firebaseReady = true;
    console.log('âœ… ç³»çµ±å®Œå…¨å°±ç·’ï¼');
    
    // Auto-focus login field
    const loginEl = document.getElementById('loginId');
    if (loginEl) loginEl.focus();
  });
</script>
