<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>TKOH A&OT/IDSS E-training System</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; display:flex; align-items:center; justify-content:center;
            padding:20px; font-size:18px;
        }
        .container {
            background:#fff; padding:60px; border-radius:20px; box-shadow:0 15px 35px rgba(0,0,0,0.2);
            max-width:1300px; width:100%; min-height:700px;
        }
        .title { color:#2c3e50; font-size:42px; font-weight:bold; margin-bottom:25px; text-align:center; }
        .subtitle { color:#7f8c8d; font-size:24px; margin-bottom:50px; text-align:center; }

        .login-page { text-align:center; }
        .form-group { margin-bottom:30px; text-align:left; max-width:450px; margin-left:auto; margin-right:auto; }
        .form-group label { display:block; margin-bottom:12px; font-weight:bold; color:#2c3e50; font-size:20px; }
        .form-group input { width:100%; padding:18px; border:2px solid #ecf0f1; border-radius:12px; font-size:20px; transition:border-color .3s; }
        .form-group input:focus { outline:none; border-color:#3498db; }
        .login-btn, .btn {
            padding:22px 45px; background: linear-gradient(135deg, #3498db, #2980b9); color:#fff; border:none; border-radius:12px;
            font-size:22px; font-weight:bold; cursor:pointer; transition:transform .2s; margin:12px;
        }
        .login-btn:hover, .btn:hover { transform: translateY(-2px); }
        .error-msg { color:#e74c3c; font-size:18px; margin-top:15px; }

        .main-menu { text-align:center; }
        .grade-buttons { display:flex; gap:35px; justify-content:center; flex-wrap:wrap; margin-bottom:50px; }
        .grade-btn {
            padding:50px 60px; background: linear-gradient(135deg, #00b894, #00a085); color:#fff; border:none; border-radius:18px; font-size:28px; font-weight:bold; cursor:pointer; transition:all .3s; min-width:200px; box-shadow:0 6px 20px rgba(0,0,0,0.1);
        }
        .grade-btn:hover { transform: translateY(-5px); box-shadow:0 10px 30px rgba(0,0,0,0.2); }

        .staff-list { text-align:center; }
        .staff-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(350px, 1fr)); gap:30px; margin-bottom:50px; }
        .staff-btn {
            padding:45px; background: linear-gradient(135deg, #fd79a8, #e84393); color:#fff; border:none; border-radius:18px; font-size:26px; font-weight:bold; cursor:pointer; transition:all .3s; box-shadow:0 6px 20px rgba(0,0,0,0.1);
        }
        .staff-btn:hover { transform: translateY(-5px); box-shadow:0 10px 30px rgba(0,0,0,0.2); }

        .staff-details { text-align:center; }
        .staff-info { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding:40px; border-radius:18px; margin-bottom:50px; border-left:8px solid #00b894; }
        .info-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(350px, 1fr)); gap:25px; text-align:left; }
        .info-item { display:flex; align-items:center; margin-bottom:18px; }
        .info-label { font-weight:bold; color:#2c3e50; width:160px; font-size:22px; }
        .info-value { color:#34495e; font-size:22px; flex:1; }

        .assessment-section { background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding:35px; border-radius:18px; margin-bottom:50px; border-left:8px solid #f39c12; }
        .assessment-title { color:#e67e22; font-size:28px; font-weight:bold; margin-bottom:25px; text-align:center; display:flex; align-items:center; justify-content:center; gap:20px; }
        .assessment-grid { display:grid; gap:20px; }
        .assessment-item {
            background:#fff; padding:25px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1);
            display:flex; align-items:center; justify-content:space-between; transition:all .3s; position:relative;
        }
        .assessment-item:hover { transform: translateY(-3px); box-shadow:0 8px 25px rgba(0,0,0,0.15); }
        .assessment-item.overdue { border-left:6px solid #e74c3c; background: linear-gradient(135deg, #ffebee, #ffcdd2); }
        .assessment-item.due-soon { border-left:6px solid #f39c12; background: linear-gradient(135deg, #fff8e1, #ffecb3); }
        .assessment-item.completed { border-left:6px solid #00b894; background: linear-gradient(135deg, #e8f5e8, #c8e6c9); }
        .assessment-info { flex:1; }
        .assessment-name { font-size:20px; font-weight:bold; color:#2c3e50; margin-bottom:8px; }
        .assessment-deadline { font-size:16px; color:#7f8c8d; }
        .assessment-status { display:flex; align-items:center; gap:15px; }
        .status-badge { padding:8px 15px; border-radius:20px; font-size:14px; font-weight:bold; white-space:nowrap; }
        .status-overdue { background:#e74c3c; color:#fff; }
        .status-due-soon { background:#f39c12; color:#fff; }
        .status-completed { background:#00b894; color:#fff; }
        .status-pending { background:#95a5a6; color:#fff; }

        .assessment-item.assessment-failed { border-left:6px solid #e74c3c; background: linear-gradient(135deg, #ffebee, #ffcdd2) !important; border:2px solid #e74c3c !important; }
        .assessment-item.assessment-failed .assessment-name { color:#c62828 !important; }
        .assessment-item.assessment-failed .assessment-deadline { color:#d32f2f !important; }

        .checkbox-group { display:flex; gap:15px; align-items:center; }
        .assessment-action-btn:hover { transform: translateY(-2px); box-shadow:0 4px 15px rgba(0,0,0,0.2); }
        .assessment-action-btn.active-pass:hover { background:#00a085 !important; }
        .assessment-action-btn.active-fail:hover { background:#d63031 !important; }

        .training-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:35px; margin-bottom:50px; }
        .training-card {
            background:#fff; border-radius:22px; padding:35px; text-align:center; box-shadow:0 8px 25px rgba(0,0,0,0.1);
            transition:all .3s; cursor:pointer; border:3px solid transparent; position:relative;
        }
        .training-card:hover { transform: translateY(-8px); box-shadow:0 15px 40px rgba(0,0,0,0.15); border-color:#00b894; }
        .training-card.completed { background: linear-gradient(135deg, #00b894, #00a085); color:#fff; }
        .training-icon { font-size:48px; margin-bottom:18px; display:block; }
        .training-name { font-size:24px; font-weight:bold; color:#2c3e50; margin-bottom:25px; }
        .training-card.completed .training-name { color:#fff; }
        .progress-circle { position:relative; width:140px; height:140px; margin:0 auto 18px; }
        .progress-text { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:24px; font-weight:bold; color:#2c3e50; }
        .training-card.completed .progress-text { color:#fff; }
        .progress-info { font-size:18px; color:#7f8c8d; margin-top:12px; }
        .training-card.completed .progress-info { color:rgba(255,255,255,0.9); }
        .completed-badge { position:absolute; top:18px; right:18px; background:#00b894; color:#fff; padding:10px 15px; border-radius:22px; font-size:14px; font-weight:bold; }

        .training-details { text-align:center; }
        .category-header { display:flex; align-items:center; justify-content:center; gap:18px; margin-bottom:25px; }
        .category-icon { font-size:56px; }
        .category-name { font-size:32px; font-weight:bold; color:#2c3e50; }
        .progress-summary { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding:35px; border-radius:18px; margin-bottom:50px; }
        .progress-circle-large { position:relative; width:170px; height:170px; margin:0 auto 25px; }
        .progress-text-large { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:32px; font-weight:bold; color:#2c3e50; }
        .progress-stats { display:flex; justify-content:center; gap:50px; margin-top:25px; flex-wrap:wrap; }
        .stat-item { text-align:center; }
        .stat-number { font-size:28px; font-weight:bold; color:#2c3e50; }
        .stat-label { font-size:16px; color:#7f8c8d; margin-top:8px; }

        .records-grid { display:grid; gap:25px; text-align:left; }
        .record-item { background:#fff; border:2px solid #ecf0f1; border-radius:15px; padding:30px; transition:all .3s; position:relative; cursor:pointer; }
        .record-item:hover { transform: translateY(-3px); box-shadow:0 8px 25px rgba(0,0,0,0.1); }
        .record-item.completed { border-color:#00b894; background: linear-gradient(135deg, #00b894, #00a085); color:#fff; }
        .record-item.pending { border-color:#ffeaa7; background: linear-gradient(135deg, #ffeaa7, #fdcb6e); }
        .record-item.failed { border-color:#e74c3c; background: linear-gradient(135deg, #ffebee, #ffcdd2); color:#c62828; }
        .record-status { position:absolute; top:18px; right:50px; padding:10px 18px; border-radius:22px; font-size:14px; font-weight:bold; }
        .record-status.completed { background: rgba(255,255,255,0.2); color:#fff; }
        .record-status.pending { background: rgba(0,0,0,0.1); color:#2c3e50; }
        .record-status.failed { background:#e74c3c; color:#fff; }
        .record-name { font-size:24px; font-weight:bold; margin-bottom:12px; padding-right:120px; }
        .record-date { font-size:18px; opacity:.8; }

        .assessment-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center; }
        .assessment-content { background:#fff; border-radius:20px; padding:40px; max-width:700px; width:90%; max-height:80vh; overflow-y:auto; }
        .assessment-header { text-align:center; margin-bottom:30px; }
        .assessment-items { margin-bottom:30px; }
        .assessment-item-row { display:flex; align-items:center; padding:15px; margin-bottom:15px; border:2px solid #ecf0f1; border-radius:10px; transition:all .3s; }
        .assessment-item-row.passed { background: linear-gradient(135deg, #d4edda, #c3e6cb); border-color:#00b894; }
        .assessment-item-row.failed { background: linear-gradient(135deg, #f8d7da, #f5c6cb); border-color:#e74c3c; }
        .assessment-item-text { flex:1; font-size:16px; margin-right:15px; padding-right:15px; }
        .assessment-controls { display:flex; gap:10px; align-items:center; }
        .assessment-btn { padding:8px 15px; border:none; border-radius:8px; font-size:14px; font-weight:bold; cursor:pointer; transition:all .3s; }
        .pass-btn { background:#00b894; color:#fff; }
        .fail-btn { background:#e74c3c; color:#fff; }
        .reset-btn { background:#95a5a6; color:#fff; }
        .assessment-progress { text-align:center; margin:20px 0; font-size:18px; font-weight:bold; color:#2c3e50; }

        .back-btn { padding:22px 45px; background:#636e72; color:#fff; border:none; border-radius:15px; font-size:22px; cursor:pointer; transition:background .3s; margin-top:25px; }
        .back-btn:hover { background:#2d3436; }
        .logout-btn { background:#e17055; }
        .logout-btn:hover { background:#d63031; }

        .page { display:none; }
        .page.active { display:block; }

        .section-title { color:#2c3e50; font-size:32px; font-weight:bold; margin-bottom:35px; border-bottom:4px solid #ecf0f1; padding-bottom:18px; }
        .click-hint { color:#7f8c8d; font-size:18px; margin-bottom:35px; font-style:italic; }

        .delete-btn-corner {
            position:absolute; bottom:10px; right:10px; width:35px; height:35px; background:#e74c3c; color:#fff;
            border:none; border-radius:50%; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; opacity:0; transition:all .3s; z-index:10;
        }
        .training-card:hover .delete-btn-corner,
        .record-item:hover .delete-btn-corner,
        .assessment-item:hover .delete-btn-corner { opacity:1; }
        .delete-btn-corner:hover { background:#c0392b; transform: scale(1.1); }

        .add-staff-btn { border:3px dashed #74b9ff; background: linear-gradient(135deg, #f8f9fa, #e9ecef); color:#74b9ff; }
        .add-staff-btn:hover { background: linear-gradient(135deg, #e3f2fd, #bbdefb); }

        @media (max-width: 768px) {
            .container { padding:40px 25px; }
            .title { font-size:32px; }
            .grade-buttons { flex-direction:column; align-items:center; }
            .grade-btn { width:100%; max-width:350px; }
            .training-grid, .staff-grid { grid-template-columns:1fr; }
            .progress-stats { gap:25px; }
            .assessment-item { flex-direction:column; gap:15px; text-align:center; }
            .checkbox-group { justify-content:center; flex-direction:column; gap:10px; }
        }

        /* 帳戶管理樣式 */
        .user-management-page { text-align:center; }
        .user-list { display:grid; gap:20px; margin-bottom:30px; }
        .user-item { background:#fff; border:2px solid #ecf0f1; border-radius:15px; padding:25px; display:flex; align-items:center; justify-content:space-between; transition:all .3s; }
        .user-item:hover { box-shadow:0 8px 25px rgba(0,0,0,0.1); }
        .user-info { flex:1; text-align:left; }
        .user-name { font-size:20px; font-weight:bold; color:#2c3e50; margin-bottom:5px; }
        .user-role { font-size:16px; color:#7f8c8d; }
        .delete-btn { padding:12px 25px; background:#e74c3c; color:#fff; border:none; border-radius:10px; font-size:16px; font-weight:bold; cursor:pointer; transition:all .3s; margin-left:15px; }
        .delete-btn:hover { background:#c0392b; transform: translateY(-2px); }
        .admin-controls { background: linear-gradient(135deg, #74b9ff, #0984e3); color:#fff; padding:30px; border-radius:15px; margin-bottom:40px; }
        .admin-title { font-size:24px; font-weight:bold; margin-bottom:20px; }
        .admin-buttons { display:flex; gap:20px; justify-content:center; flex-wrap:wrap; }
        .admin-btn { padding:15px 30px; background: rgba(255,255,255,0.2); color:#fff; border:2px solid rgba(255,255,255,0.3); border-radius:10px; font-size:16px; font-weight:bold; cursor:pointer; transition:all .3s; }
        .admin-btn:hover { background: rgba(255,255,255,0.3); border-color:#fff; }
        .item-actions { display:flex; gap:10px; align-items:center; }
        .edit-btn { padding:8px 15px; background:#f39c12; color:#fff; border:none; border-radius:8px; font-size:14px; cursor:pointer; transition:all .3s; }
        .edit-btn:hover { background:#e67e22; }

        .confirm-dialog { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center; }
        .confirm-content { background:#fff; border-radius:20px; padding:40px; max-width:500px; width:90%; text-align:center; }
        .confirm-title { font-size:24px; font-weight:bold; color:#e74c3c; margin-bottom:20px; }
        .confirm-message { font-size:18px; color:#2c3e50; margin-bottom:30px; line-height:1.5; }
        .confirm-buttons { display:flex; gap:15px; justify-content:center; }
        .confirm-btn { padding:15px 30px; border:none; border-radius:10px; font-size:16px; font-weight:bold; cursor:pointer; transition:all .3s; }
        .confirm-yes { background:#e74c3c; color:#fff; }
        .confirm-no { background:#95a5a6; color:#fff; }

        /* Role-based hide helper */
        .hidden { display:none !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 登入頁面 -->
        <div id="loginPage" class="page active login-page">
            <div class="title">🏥 TKOH A&OT/IDSS<br/>E-training System</div>
            <div class="subtitle">培訓管理系統</div>

            <div class="form-group">
                <label>Login ID</label>
                <input type="text" id="loginId" placeholder="請輸入登入ID"/>
            </div>

            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="請輸入密碼"/>
            </div>

            <button class="login-btn" onclick="handleLogin()">登入系統</button>

            <div class="error-msg" id="errorMsg" style="display:none;"></div>

            <div style="text-align:center; margin-top:20px; font-size:14px; color:#95a5a6;">
                Created by Leung Nok Man Jeffrey (10/2025)
            </div>
        </div>

        <!-- 主選單（僅系統管理員與主管使用） -->
        <div id="mainMenu" class="page main-menu">
            <div class="title">🏥 TKOH A&OT/IDSS E-training System</div>
            <div class="subtitle">歡迎使用培訓管理系統 👋</div>

            <div class="section-title">👥 選擇員工職級</div>
            <div class="grade-buttons">
                <button class="grade-btn" onclick="showStaffList('PCA1')">🩺<br/>PCA1</button>
                <button class="grade-btn" onclick="showStaffList('PCA2')">🏥<br/>PCA2</button>
                <button class="grade-btn" onclick="showStaffList('PCA3')">⚕️<br/>PCA3</button>
                <button class="grade-btn" onclick="showStaffList('OTA')" style="background: linear-gradient(135deg, #a29bfe, #6c5ce7);">🔧<br/>OTA</button>
            </div>

            <!-- 帳戶管理：僅系統管理員可見 -->
            <button id="btnUserMgmt" class="btn" onclick="showUserManagement()" style="background: linear-gradient(135deg, #74b9ff, #0984e3);">
                👥 帳戶管理
            </button>

            <button class="btn logout-btn" onclick="logout()">🚪 登出系統</button>
        </div>

        <!-- 員工列表（不再出現新增/刪除員工功能） -->
        <div id="staffListPage" class="page staff-list">
            <div class="title">👥 員工列表</div>
            <div class="subtitle" id="gradeInfo"></div>
            <div id="staffCount" class="click-hint"></div>
            <div class="staff-grid" id="staffGrid"></div>
            <button class="back-btn" onclick="showMainMenu()">← 返回主選單</button>
        </div>

        <!-- 員工詳情 -->
        <div id="staffDetailsPage" class="page staff-details">
            <div class="title">📋 員工培訓記錄</div>
            <div class="staff-info" id="staffInfoSection"></div>

            <!-- 評估時間表：新增/刪除按鈕僅系統管理員可見 -->
            <div class="assessment-section" id="assessmentSection">
                <div class="assessment-title">
                    📅 各評估時間表
                    <button id="btnAddAssessment" onclick="showAddAssessmentModal()" style="padding:10px 20px; background:#f39c12; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer; margin-left:20px;">
                        ➕ 新增評估項目
                    </button>
                </div>
                <div class="assessment-grid" id="assessmentGrid"></div>
            </div>

            <div class="section-title">🎓 培訓項目進度</div>
            <div class="click-hint">💡 點擊培訓項目查看詳細記錄</div>
            <div class="training-grid" id="trainingGrid"></div>

            <button class="back-btn" onclick="goBackToStaffList()">← 返回員工列表</button>
        </div>

        <!-- 帳戶管理頁面（僅系統管理員） -->
        <div id="userManagementPage" class="page user-management-page">
            <div class="title">👥 帳戶管理系統</div>
            <div class="subtitle">管理用戶帳戶和權限</div>

            <div class="admin-controls">
                <div class="admin-title">📊 管理員控制台</div>
                <div class="admin-buttons">
                    <button class="admin-btn" onclick="showAddUserModal()">➕ 新增用戶</button>
                    <button class="admin-btn" onclick="exportUserData()">📤 導出用戶資料</button>
                    <button class="admin-btn" onclick="showSystemSettings()">⚙️ 系統設定</button>
                </div>
            </div>

            <div class="section-title">👤 現有用戶列表</div>
            <div class="user-list" id="userList"></div>

            <button class="back-btn" onclick="showMainMenu()">← 返回主選單</button>
        </div>

        <!-- 培訓詳情 -->
        <div id="trainingDetailsPage" class="page training-details">
            <div class="title">📚 培訓詳情</div>
            <div id="trainingDetailContent"></div>
            <button class="back-btn" onclick="goBackToStaffDetails()">← 返回員工記錄</button>
        </div>
    </div>

    <script>
        // 基礎資料與函數

        function validateAssessmentItems(record) {
            if (!record.assessmentItems) return;
            record.assessmentItems.forEach((item, index) => {
                if (item.isCritical === undefined || item.isCritical === null) item.isCritical = false;
                if (item.passed === undefined || item.passed === null) item.passed = false;
                if (item.failed === undefined || item.failed === null) item.failed = false;
                if (!item.name || item.name === undefined) item.name = `評核項目 ${index + 1}`;
                item.isCritical = Boolean(item.isCritical);
                item.passed = Boolean(item.passed);
                item.failed = Boolean(item.failed);
                item.name = String(item.name);
            });
        }

        // 資料庫
        const staffDatabase = {
            'PCA1': [
                {id: 'leung_noah', name: '梁諾文'},
                {id: 'chan_david', name: '陳大衛'},
                {id: 'wong_mary', name: '黃美麗'},
                {id: 'li_peter', name: '李彼得'}
            ],
            'PCA2': [
                {id: 'tam_susan', name: '譚素珊'},
                {id: 'lau_john', name: '劉約翰'},
                {id: 'ng_linda', name: '吳琳達'}
            ],
            'PCA3': [
                {id: 'ho_michael', name: '何米高'},
                {id: 'cheung_anna', name: '張安娜'},
                {id: 'yip_thomas', name: '葉湯馬士'}
            ],
            'OTA': [
                {id: 'chu_kevin', name: '朱凱文'},
                {id: 'lee_sammy', name: '李森美'}
            ]
        };

        let assessmentConfig = [
            { name:'職安健簡介及測試', weeksDeadline:1, type:'safety', id:'safety_001' },
            { name:'筆試', weeksDeadline:20, type:'written', id:'written_001' },
            { name:'完成培訓項目', weeksDeadline:24, type:'training', id:'training_001' }
        ];

        const staffData = {
            'leung_noah': {
                name: '梁諾文', employeeId:'224813', grade:'PCA1', joinDate:'08/10/2025',
                assessments: { safety:{passed:false,failed:false}, written:{passed:false,failed:false}, training:{passed:false,failed:false} },
                trainingCategories: {
                    'Decontamination': {
                        name:'Decontamination', icon:'🧽', completed:2, total:4,
                        records:[
                            {name:'Basic Cleaning Procedures', completed:true, date:'01/10/2024'},
                            {name:'Chemical Safety Training', completed:true, date:'15/10/2024'},
                            {name:'Equipment Maintenance', completed:false, date:null},
                            {name:'Quality Control Standards', completed:false, date:null}
                        ]
                    },
                    'Sterilization': {
                        name:'Sterilization', icon:'🔥', completed:5, total:5,
                        records:[
                            {name:'Steam Sterilization', completed:true, date:'20/09/2024'},
                            {name:'ETO Sterilization', completed:true, date:'25/09/2024'},
                            {name:'Low Temperature Sterilization', completed:true, date:'05/10/2024'},
                            {name:'Biological Indicators', completed:true, date:'12/10/2024'},
                            {name:'Load Documentation', completed:true, date:'18/10/2024'}
                        ]
                    },
                    'Endoscope': {
                        name:'Endoscope', icon:'🔬', completed:1, total:4,
                        records:[
                            {name:'Pre-cleaning Procedures', completed:true, date:'10/10/2024'},
                            {name:'Manual Cleaning', completed:false, date:null},
                            {name:'Automated Reprocessing', completed:false, date:null},
                            {name:'Leak Testing', completed:false, date:null}
                        ]
                    },
                    'Robotic Instrument': {
                        name:'Robotic Instrument', icon:'🤖', completed:2, total:3,
                        records:[
                            {name:'Da Vinci System Overview', completed:true, date:'30/09/2024'},
                            {name:'Instrument Handling', completed:true, date:'08/10/2024'},
                            {name:'Troubleshooting', completed:false, date:null}
                        ]
                    },
                    'Picking List': {
                        name:'Picking List', icon:'📋', completed:1, total:4,
                        records:[
                            {name:'Inventory Management', completed:true, date:'12/10/2024'},
                            {name:'Order Processing', completed:false, date:null},
                            {name:'Quality Checking', completed:false, date:null},
                            {name:'Documentation Standards', completed:false, date:null}
                        ]
                    }
                }
            },
            'chan_david': {
                name:'陳大衛', employeeId:'224814', grade:'PCA1', joinDate:'15/09/2025',
                assessments:{ safety:{passed:true,failed:false}, written:{passed:false,failed:false}, training:{passed:false,failed:false} },
                trainingCategories:{
                    'Decontamination': {
                        name:'Decontamination', icon:'🧽', completed:4, total:4,
                        records:[
                            {name:'Basic Cleaning Procedures', completed:true, date:'20/09/2024'},
                            {name:'Chemical Safety Training', completed:true, date:'25/09/2024'},
                            {name:'Equipment Maintenance', completed:true, date:'01/10/2024'},
                            {name:'Quality Control Standards', completed:true, date:'08/10/2024'}
                        ]
                    },
                    'Sterilization': {
                        name:'Sterilization', icon:'🔥', completed:3, total:5,
                        records:[
                            {name:'Steam Sterilization', completed:true, date:'18/09/2024'},
                            {name:'ETO Sterilization', completed:true, date:'22/09/2024'},
                            {name:'Low Temperature Sterilization', completed:true, date:'28/09/2024'},
                            {name:'Biological Indicators', completed:false, date:null},
                            {name:'Load Documentation', completed:false, date:null}
                        ]
                    }
                }
            },
            'wong_mary': {
                name:'黃美麗', employeeId:'224815', grade:'PCA1', joinDate:'22/08/2025',
                assessments:{ safety:{passed:true,failed:false}, written:{passed:true,failed:false}, training:{passed:false,failed:false} },
                trainingCategories:{
                    'Decontamination': {
                        name:'Decontamination', icon:'🧽', completed:3, total:4,
                        records:[
                            {name:'Basic Cleaning Procedures', completed:true, date:'15/09/2024'},
                            {name:'Chemical Safety Training', completed:true, date:'20/09/2024'},
                            {name:'Equipment Maintenance', completed:true, date:'28/09/2024'},
                            {name:'Quality Control Standards', completed:false, date:null}
                        ]
                    }
                }
            },
            'chu_kevin': { name:'朱凱文', employeeId:'224816', grade:'OTA', joinDate:'01/09/2025',
                assessments:{ safety:{passed:false,failed:false}, written:{passed:false,failed:false}, training:{passed:false,failed:false} },
                trainingCategories:{} },
            'lee_sammy': { name:'李森美', employeeId:'224817', grade:'OTA', joinDate:'15/09/2025',
                assessments:{ safety:{passed:true,failed:false}, written:{passed:false,failed:false}, training:{passed:false,failed:false} },
                trainingCategories:{} }
        };

        // 用戶帳戶系統
        // 角色: admin(系統管理員), supervisor(主管), staff(員工)
        const userAccounts = {
            // 系統管理員
            'tkohot': {
                username:'tkohot', password:'A123456*#', role:'admin', name:'系統管理員',
                email:'admin@tkoh.hk', createdDate:'01/01/2024'
            },
            // 主管
            'supervisor': {
                username:'supervisor', password:'sup123', role:'supervisor', name:'主管',
                email:'supervisor@tkoh.hk', createdDate:'15/01/2024'
            },
            // 員工（示例，每位員工應有對應 staffId 綁定）
            'leung_noah_user': {
                username:'leung_noah_user', password:'pw123', role:'staff', name:'梁諾文',
                email:'leung.noah@tkoh.hk', createdDate:'10/01/2025', staffId:'leung_noah'
            }
        };

        // 當前登入者
        let currentUser = null;
        let currentUserRole = null;

        // 導航狀態
        let currentGrade = '';
        let currentStaffId = '';
        let currentCategory = '';
        let currentRecordIndex = -1;

        // 日期工具
        function addWeeksToDate(dateStr, weeks) {
            const [day, month, year] = dateStr.split('/');
            const date = new Date(year, month - 1, day);
            date.setDate(date.getDate() + weeks * 7);
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }
        function daysBetweenDates(d1, d2) {
            const [a,b,c] = d1.split('/'); const [x,y,z] = d2.split('/');
            const date1 = new Date(c, b-1, a); const date2 = new Date(z, y-1, x);
            return Math.ceil((date2 - date1) / (1000*60*60*24));
        }
        function getCurrentDate() {
            const now = new Date();
            const d = String(now.getDate()).padStart(2,'0');
            const m = String(now.getMonth()+1).padStart(2,'0');
            const y = now.getFullYear();
            return `${d}/${m}/${y}`;
        }

        function calculateAssessmentStatus(joinDate, weeksDeadline, assessments, assessmentType) {
            const deadline = addWeeksToDate(joinDate, weeksDeadline);
            const currentDate = getCurrentDate();
            const daysToDeadline = daysBetweenDates(currentDate, deadline);
            if (!assessments || !assessments[assessmentType]) {
                if (!assessments) assessments = {};
                assessments[assessmentType] = { passed:false, failed:false };
            }
            if (assessments[assessmentType].passed) {
                return { status:'completed', deadline, daysToDeadline, badge:'✅ 合格' };
            }
            if (assessments[assessmentType].failed) {
                return { status:'completed', deadline, daysToDeadline, badge:'❌ 不合格' };
            }
            if (daysToDeadline < 0) {
                return { status:'overdue', deadline, daysToDeadline, badge:`⚠️ 逾期 ${Math.abs(daysToDeadline)} 天` };
            }
            if (daysToDeadline <= 7) {
                return { status:'due-soon', deadline, daysToDeadline, badge:`🔔 ${daysToDeadline} 天後到期` };
            }
            return { status:'pending', deadline, daysToDeadline, badge:`📅 ${daysToDeadline} 天後到期` };
        }

        function getAssessmentName(assessmentType) {
            const a = assessmentConfig.find(x => x.type === assessmentType);
            return a ? a.name : assessmentType;
        }

        function showSuccessMessage(icon, message, color) {
            const el = document.createElement('div');
            el.style.cssText = "position:fixed; top:20px; right:20px; z-index:9999; background:"+color+"; color:#fff; padding:15px 25px; border-radius:10px; font-weight:bold; box-shadow:0 4px 15px rgba(0,0,0,0.2); font-size:16px;";
            el.textContent = `${icon} ${message}`;
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 2500);
        }

        function hideAllPages() { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); }
        function clearLoginForm() { document.getElementById('loginId').value=''; document.getElementById('password').value=''; document.getElementById('errorMsg').style.display='none'; }
        function showError(msg){ const e=document.getElementById('errorMsg'); e.textContent=msg; e.style.display='block'; }

        // 角色控制：根據 currentUserRole 控制 UI 元素顯示/隱藏
        function applyRoleVisibility() {
            const isAdmin = currentUserRole === 'admin';
            const isSupervisor = currentUserRole === 'supervisor';
            const isStaff = currentUserRole === 'staff';

            // 主選單：帳戶管理按鈕僅 admin 顯示
            const btnUserMgmt = document.getElementById('btnUserMgmt');
            if (btnUserMgmt) btnUserMgmt.classList.toggle('hidden', !isAdmin);

            // 在員工詳情：新增評估按鈕僅 admin 顯示
            const btnAddAssessment = document.getElementById('btnAddAssessment');
            if (btnAddAssessment) btnAddAssessment.classList.toggle('hidden', !isAdmin);
        }

        // 登入流程與導向規則
        async function handleLogin() {
            const loginId = document.getElementById('loginId').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!loginId || !password) { showError('請輸入Login ID和Password'); return; }
            await login();
        }

        async function login() {
            const loginId = document.getElementById('loginId').value.trim();
            const password = document.getElementById('password').value.trim();
            const user = userAccounts[loginId];

            if (!user || user.password !== password) { showError('Login ID或Password錯誤'); return; }

            currentUser = user;
            currentUserRole = user.role;

            // 導向規則
            hideAllPages();

            if (currentUserRole === 'admin') {
                // 管理員可使用全系統，落地至主選單
                document.getElementById('mainMenu').classList.add('active');
            } else if (currentUserRole === 'supervisor') {
                // 主管直接進入選擇員工職級頁面（主選單）
                document.getElementById('mainMenu').classList.add('active');
            } else if (currentUserRole === 'staff') {
                // 員工只可看自己的記錄，直接進入自己的詳情
                if (currentUser.staffId && staffData[currentUser.staffId]) {
                    showStaffDetails(currentUser.staffId);
                } else {
                    showError('找不到您的員工資料，請聯絡系統管理員');
                    hideAllPages();
                    document.getElementById('loginPage').classList.add('active');
                    return;
                }
            }

            // 成功訊息
            const successMsg = document.createElement('div');
            successMsg.style.cssText = "position:fixed; top:20px; right:20px; z-index:9999; background:#00b894; color:#fff; padding:15px 25px; border-radius:10px; font-weight:bold; box-shadow:0 4px 15px rgba(0,0,0,0.2);";
            successMsg.textContent = `✅ 歡迎，${user.name}！`;
            document.body.appendChild(successMsg);
            setTimeout(()=>successMsg.remove(), 3000);

            clearLoginForm();
            applyRoleVisibility();
        }

        function logout() {
            if (confirm('確定要登出系統嗎？')) {
                currentUser = null; currentUserRole = null;
                hideAllPages();
                document.getElementById('loginPage').classList.add('active');
                clearLoginForm();
            }
        }

        // 主選單
        function showMainMenu() {
            if (!currentUserRole) return;
            if (currentUserRole === 'staff') {
                // 員工不允許進入主選單
                if (currentUser?.staffId) {
                    showStaffDetails(currentUser.staffId);
                }
                return;
            }
            hideAllPages();
            document.getElementById('mainMenu').classList.add('active');
            applyRoleVisibility();
        }

        // 員工列表（無新增/刪除功能）
        function showStaffList(grade) {
            if (currentUserRole !== 'admin' && currentUserRole !== 'supervisor') {
                alert('❌ 權限不足！'); return;
            }
            currentGrade = grade;
            hideAllPages();
            document.getElementById('staffListPage').classList.add('active');
            document.getElementById('gradeInfo').textContent = `職級：${grade}`;
            const staffList = staffDatabase[grade] || [];
            document.getElementById('staffCount').textContent = `共 ${staffList.length} 位員工`;

            const staffGrid = document.getElementById('staffGrid');
            let html = '';
            staffList.forEach(staff => {
                html += `
                    <div style="position:relative; display:inline-block;">
                        <button class="staff-btn" onclick="showStaffDetails('${staff.id}')">👤 ${staff.name}</button>
                    </div>
                `;
            });
            staffGrid.innerHTML = html;
        }

        // 顯示員工詳情
        function showStaffDetails(staffId) {
            currentStaffId = staffId;
            const staff = staffData[staffId];
            if (!staff) { alert('找不到員工資料'); return; }

            // 確保評估資料結構存在
            if (!staff.assessments) {
                staff.assessments = { safety:{passed:false,failed:false}, written:{passed:false,failed:false}, training:{passed:false,failed:false} };
            }
            assessmentConfig.forEach(a => { if (!staff.assessments[a.type]) staff.assessments[a.type] = {passed:false, failed:false}; });

            hideAllPages();
            document.getElementById('staffDetailsPage').classList.add('active');

            // 基本資料
            const staffInfoSection = document.getElementById('staffInfoSection');
            staffInfoSection.innerHTML = `
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">👤 姓名：</div><div class="info-value">${staff.name}</div></div>
                    <div class="info-item"><div class="info-label">🆔 員工編號：</div><div class="info-value">${staff.employeeId}</div></div>
                    <div class="info-item"><div class="info-label">🏥 職級：</div><div class="info-value">${staff.grade}</div></div>
                    <div class="info-item"><div class="info-label">📅 入職日期：</div><div class="info-value">${staff.joinDate}</div></div>
                </div>
            `;

            // 評估時間表
            displayAssessments(staffId);

            // 培訓項目列表
            const trainingGrid = document.getElementById('trainingGrid');
            let html = '';

            // 新增培訓項目卡片：僅系統管理員顯示
            if (currentUserRole === 'admin') {
                html += `
                    <div class="training-card add-new-card" onclick="showAddTrainingModal()" style="border:3px dashed #74b9ff; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                        <div class="training-icon" style="font-size:48px; color:#74b9ff;">➕</div>
                        <div class="training-name" style="color:#74b9ff;">新增培訓項目</div>
                        <div class="progress-info" style="color:#74b9ff;">點擊新增自訂培訓項目</div>
                    </div>
                `;
            }

            if (staff.trainingCategories) {
                Object.keys(staff.trainingCategories).forEach(categoryKey => {
                    const category = staff.trainingCategories[categoryKey];
                    const percentage = category.total > 0 ? Math.round((category.completed / category.total) * 100) : 0;
                    const isCompleted = percentage === 100;
                    html += `
                        <div class="training-card ${isCompleted ? 'completed':''}" onclick="showTrainingDetails('${categoryKey}')">
                            ${currentUserRole === 'admin' ? `<button class="delete-btn-corner" onclick="event.stopPropagation(); deleteTrainingCategory('${categoryKey}')" title="刪除培訓項目">🗑️</button>`:''}
                            ${isCompleted ? '<div class="completed-badge">✅ 完成</div>' : ''}
                            <div class="training-icon">${category.icon}</div>
                            <div class="training-name">${category.name}</div>
                            <div class="progress-circle">
                                <svg width="140" height="140" viewBox="0 0 140 140">
                                    <circle cx="70" cy="70" r="60" fill="none" stroke="${isCompleted ? 'rgba(255,255,255,0.3)':'#ecf0f1'}" stroke-width="12"></circle>
                                    <circle cx="70" cy="70" r="60" fill="none" stroke="${isCompleted ? 'white' : (percentage>0 ? '#74b9ff' : '#ecf0f1')}"
                                        stroke-width="12" stroke-dasharray="${2 * Math.PI * 60}"
                                        stroke-dashoffset="${2 * Math.PI * 60 * (1 - percentage/100)}"
                                        transform="rotate(-90 70 70)" stroke-linecap="round"></circle>
                                </svg>
                                <div class="progress-text">${percentage}%</div>
                            </div>
                            <div class="progress-info">${category.completed}/${category.total} 項目完成 ${isCompleted ? '<br/>🎉 全部完成！':''}</div>
                        </div>
                    `;
                });
            }
            trainingGrid.innerHTML = html;

            applyRoleVisibility();
        }

        // 顯示評估時間表（合格/不合格切換按鈕：員工不可用）
        function displayAssessments(staffId) {
            const staff = staffData[staffId];
            const assessmentGrid = document.getElementById('assessmentGrid');
            let html = '';

            assessmentConfig.forEach(assessment => {
                if (!staff.assessments[assessment.type]) {
                    staff.assessments[assessment.type] = {passed:false, failed:false};
                }
                const status = calculateAssessmentStatus(staff.joinDate, assessment.weeksDeadline, staff.assessments, assessment.type);
                const isFailed = staff.assessments[assessment.type].failed;
                const roleCanToggle = (currentUserRole === 'admin' || currentUserRole === 'supervisor');
                const itemClass = isFailed ? 'assessment-failed' : status.status;

                html += `
                    <div class="assessment-item ${itemClass}">
                        ${currentUserRole === 'admin' ? `<button class="delete-btn-corner" onclick="deleteAssessmentItem('${assessment.id}')" title="刪除評估項目">🗑️</button>`:''}
                        <div class="assessment-info">
                            <div class="assessment-name">${assessment.name}</div>
                            <div class="assessment-deadline">截止日期：${status.deadline}
                                ${status.daysToDeadline >= 0 ? ` (入職後 ${assessment.weeksDeadline} 週)` : ` (已逾期 ${Math.abs(status.daysToDeadline)} 天)`}
                            </div>
                        </div>
                        <div class="assessment-status">
                            <div class="status-badge status-${status.status}">${status.badge}</div>
                            <div class="checkbox-group">
                                <button class="assessment-action-btn ${staff.assessments[assessment.type].passed ? 'active-pass':''}"
                                    ${roleCanToggle ? `onclick="saveAssessmentResult('${staffId}','${assessment.type}','pass')"` : 'disabled'}
                                    style="padding:10px 20px; border:2px solid #00b894; border-radius:8px; background:${staff.assessments[assessment.type].passed ? '#00b894':'white'}; color:${staff.assessments[assessment.type].passed ? 'white':'#00b894'}; font-weight:bold; cursor:${roleCanToggle ? 'pointer':'not-allowed'}; transition:all .3s; margin-right:10px;">
                                    ${staff.assessments[assessment.type].passed ? '✅ 已合格 (點擊取消)':'⭕ 標記合格'}
                                </button>
                                <button class="assessment-action-btn ${staff.assessments[assessment.type].failed ? 'active-fail':''}"
                                    ${roleCanToggle ? `onclick="saveAssessmentResult('${staffId}','${assessment.type}','fail')"` : 'disabled'}
                                    style="padding:10px 20px; border:2px solid #e74c3c; border-radius:8px; background:${staff.assessments[assessment.type].failed ? '#e74c3c':'white'}; color:${staff.assessments[assessment.type].failed ? 'white':'#e74c3c'}; font-weight:bold; cursor:${roleCanToggle ? 'pointer':'not-allowed'}; transition:all .3s;">
                                    ${staff.assessments[assessment.type].failed ? '❌ 不合格 (點擊取消)':'⭕ 標記不合格'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            assessmentGrid.innerHTML = html;
        }

        async function saveAssessmentResult(staffId, assessmentType, result) {
            // 僅 admin/supervisor
            if (!(currentUserRole === 'admin' || currentUserRole === 'supervisor')) return;

            if (staffData[staffId] && staffData[staffId].assessments) {
                const currentAssessment = staffData[staffId].assessments[assessmentType];
                if (result === 'pass') {
                    if (currentAssessment.passed) {
                        currentAssessment.passed = false; currentAssessment.failed = false;
                        showSuccessMessage('⏳', `「${getAssessmentName(assessmentType)}」已取消合格狀態！`, '#f39c12');
                    } else {
                        currentAssessment.passed = true; currentAssessment.failed = false;
                        showSuccessMessage('✅', `「${getAssessmentName(assessmentType)}」已標記為合格！`, '#00b894');
                    }
                } else if (result === 'fail') {
                    if (currentAssessment.failed) {
                        currentAssessment.passed = false; currentAssessment.failed = false;
                        showSuccessMessage('⏳', `「${getAssessmentName(assessmentType)}」已取消不合格狀態！`, '#f39c12');
                    } else {
                        currentAssessment.passed = false; currentAssessment.failed = true;
                        showSuccessMessage('❌', `「${getAssessmentName(assessmentType)}」已標記為不合格！`, '#e74c3c');
                    }
                }
                if (window.saveAssessmentResultToFirebase) {
                    await window.saveAssessmentResultToFirebase(staffId, assessmentType, result);
                }
                displayAssessments(staffId);
            }
        }

        // 新增評估項目（僅 admin）
        function showAddAssessmentModal() {
            if (currentUserRole !== 'admin') return;
            const modal = document.createElement('div');
            modal.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;";
            modal.innerHTML = `
                <div style="background:#fff; border-radius:20px; padding:40px; max-width:600px; width:90%;">
                    <h3 style="text-align:center; margin-bottom:30px; font-size:24px; color:#2c3e50;">📅 新增評估項目</h3>
                    <div style="margin-bottom:25px;">
                        <label style="display:block; margin-bottom:10px; font-weight:bold; color:#2c3e50;">📋 評估項目名稱：</label>
                        <input type="text" id="newAssessmentName" style="width:100%; padding:15px; border:2px solid #ecf0f1; border-radius:10px; font-size:16px;" placeholder="例如：實習期評估"/>
                    </div>
                    <div style="margin-bottom:25px;">
                        <label style="display:block; margin-bottom:10px; font-weight:bold; color:#2c3e50;">⏰ 時間限制（週數）：</label>
                        <input type="number" id="assessmentWeeks" min="1" max="52" value="4" style="width:100%; padding:15px; border:2px solid #ecf0f1; border-radius:10px; font-size:16px;" placeholder="請輸入週數"/>
                        <div style="font-size:14px; color:#7f8c8d; margin-top:5px;">💡 系統將從員工入職日期開始自動計算截止日期</div>
                    </div>
                    <div style="display:flex; gap:15px; justify-content:center; margin-top:30px;">
                        <button onclick="closeAssessmentModal()" style="padding:15px 30px; background:#95a5a6; color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer;">❌ 取消</button>
                        <button onclick="addNewAssessment()" style="padding:15px 30px; background:#f39c12; color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer;">✅ 新增評估</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentAssessmentModal = modal;
        }
        function closeAssessmentModal() {
            if (window.currentAssessmentModal) {
                document.body.removeChild(window.currentAssessmentModal);
                window.currentAssessmentModal = null;
            }
        }
        async function addNewAssessment() {
            if (currentUserRole !== 'admin') return;
            const name = document.getElementById('newAssessmentName').value.trim();
            const weeks = parseInt(document.getElementById('assessmentWeeks').value);
            if (!name) { alert('❌ 請輸入評估項目名稱！'); return; }
            if (!weeks || weeks < 1) { alert('❌ 請輸入有效的週數！'); return; }

            const newAssessment = { name, weeksDeadline: weeks, type:`custom_${Date.now()}`, id:`assessment_${Date.now()}` };
            assessmentConfig.push(newAssessment);

            // 初始化到所有員工
            Object.keys(staffData).forEach(staffId => {
                if (!staffData[staffId].assessments[newAssessment.type]) {
                    staffData[staffId].assessments[newAssessment.type] = {passed:false, failed:false};
                }
            });

            try {
                if (window.saveAssessmentConfigToFirebase) await window.saveAssessmentConfigToFirebase(newAssessment);
                showSuccessMessage('✅', `新評估項目「${name}」已成功新增！`, '#f39c12');
            } catch(e) { console.error(e); }
            closeAssessmentModal();
            displayAssessments(currentStaffId);
        }
        async function deleteAssessmentItem(assessmentId) {
            if (currentUserRole !== 'admin') return;
            const assessment = assessmentConfig.find(a=>a.id===assessmentId);
            if (!assessment) return;
            if (confirm(`⚠️ 確定要刪除評估項目「${assessment.name}」嗎？\n\n此操作會影響所有員工，且無法復原！`)) {
                try {
                    if (window.addDoc && window.collection && window.db) {
                        await window.addDoc(window.collection(window.db,"deleted-assessments"), {
                            assessmentId, assessmentName:assessment.name, assessmentType:assessment.type,
                            deletedBy: currentUser ? currentUser.name : "admin",
                            timestamp:new Date(), action:"delete"
                        });
                    }
                    const idx = assessmentConfig.findIndex(a=>a.id===assessmentId);
                    if (idx>-1) assessmentConfig.splice(idx,1);
                    Object.keys(staffData).forEach(staffId=>{
                        if (staffData[staffId].assessments[assessment.type]) {
                            delete staffData[staffId].assessments[assessment.type];
                        }
                    });
                    showSuccessMessage('🗑️', `評估項目「${assessment.name}」已刪除！`, '#e74c3c');
                    displayAssessments(currentStaffId);
                } catch(e){ console.error(e); showSuccessMessage('❌','刪除失敗，請重試','#e74c3c'); }
            }
        }

        // 培訓類別 新增/刪除（新增/刪除僅 admin）
        function showAddTrainingModal() {
            if (currentUserRole !== 'admin') return;
            const modal = document.createElement('div');
            modal.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;";
            modal.innerHTML = `
                <div style="background:#fff; border-radius:20px; padding:40px; max-width:500px; width:90%;">
                    <h3 style="text-align:center; margin-bottom:30px; font-size:24px; color:#2c3e50;">🆕 新增培訓項目</h3>
                    <div style="margin-bottom:25px;">
                        <label style="display:block; margin-bottom:10px; font-weight:bold; color:#2c3e50;">📚 項目名稱：</label>
                        <input type="text" id="newTrainingName" style="width:100%; padding:15px; border:2px solid #ecf0f1; border-radius:10px; font-size:16px;" placeholder="例如：Advanced Cleaning Procedures"/>
                    </div>
                    <div style="margin-bottom:25px;">
                        <label style="display:block; margin-bottom:10px; font-weight:bold; color:#2c3e50;">🎯 選擇圖標：</label>
                        <div style="display:grid; grid-template-columns: repeat(6, 1fr); gap:10px;">
                            <button class="icon-btn" data-icon="🧽" style="padding:10px; border:2px solid #ecf0f1; border-radius:8px; font-size:24px; cursor:pointer; background:#fff;">🧽</button>
                            <button class="icon-btn" data-icon="🔥" style="padding:10px; border:2px solid #ecf0f1; border-radius:8px; font-size:24px; cursor:pointer; background:#fff;">🔥</button>
                            <button class="icon-btn" data-icon="🔬" style="padding:10px; border:2px solid #ecf0f1; border-radius:8px; font-size:24px; cursor:pointer; background:#fff;">🔬</button>
                            <button class="icon-btn" data-icon="🤖" style="padding:10px; border:2px solid #ecf0f1; border-radius:8px; font-size:24px; cursor:pointer; background:#fff;">🤖</button>
                            <button class="icon-btn" data-icon="📋" style="padding:10px; border:2px solid #ecf0f1; border-radius:8px; font-size:24px; cursor:pointer; background:#fff;">📋</button>
                            <button class="icon-btn" data-icon="⚕️" style="padding:10px; border:2px solid #ecf0f1; border-radius:8px; font-size:24px; cursor:pointer; background:#fff;">⚕️</button>
                        </div>
                        <input type="hidden" id="selectedIcon" value="🧽"/>
                    </div>
                    <div style="display:flex; gap:15px; justify-content:center; margin-top:30px;">
                        <button onclick="closeModal()" style="padding:15px 30px; background:#95a5a6; color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer;">❌ 取消</button>
                        <button onclick="addNewTrainingCategory()" style="padding:15px 30px; background:#00b894; color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer;">✅ 新增項目</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelectorAll('.icon-btn').forEach(btn=>{
                btn.addEventListener('click', function(){
                    modal.querySelectorAll('.icon-btn').forEach(b=>b.style.background='#fff');
                    this.style.background='#74b9ff';
                    document.getElementById('selectedIcon').value = this.dataset.icon;
                });
            });
            window.currentModal = modal;
        }
        function closeModal(){ if (window.currentModal){ document.body.removeChild(window.currentModal); window.currentModal = null; } }
        async function addNewTrainingCategory() {
            if (currentUserRole !== 'admin') return;
            const name = document.getElementById('newTrainingName').value.trim();
            const icon = document.getElementById('selectedIcon').value;
            if (!name) { alert('❌ 請輸入項目名稱！'); return; }
            const categoryKey = `${name.replace(/\s+/g,'_').toLowerCase()}_${Date.now()}`;
            const newCategoryData = { name, icon, completed:0, total:0, records:[] };
            staffData[currentStaffId].trainingCategories[categoryKey] = newCategoryData;
            try {
                if (window.saveTrainingCategoryToFirebase) await window.saveTrainingCategoryToFirebase(currentStaffId, categoryKey, newCategoryData);
                showSuccessMessage('✅', `新培訓項目「${name}」已成功新增！`, '#00b894');
            } catch(e){
                delete staffData[currentStaffId].trainingCategories[categoryKey];
                showSuccessMessage('❌','儲存失敗，請重試','#e74c3c');
            }
            closeModal();
            showStaffDetails(currentStaffId);
        }
        async function deleteTrainingCategory(categoryKey) {
            if (currentUserRole !== 'admin') return;
            const staff = staffData[currentStaffId];
            const category = staff.trainingCategories[categoryKey];
            if (confirm(`⚠️ 確定要刪除培訓項目「${category.name}」嗎？\n\n此操作無法復原！`)) {
                try {
                    if (window.addDoc && window.collection && window.db) {
                        await window.addDoc(window.collection(window.db,"deleted-training-categories"), {
                            staffId: currentStaffId, staffName: staff.name, categoryKey, categoryName: category.name,
                            deletedBy: currentUser ? currentUser.name : "admin", timestamp:new Date(), action:"delete"
                        });
                    }
                    delete staff.trainingCategories[categoryKey];
                    showSuccessMessage('🗑️', `培訓項目「${category.name}」已刪除！`, '#e74c3c');
                    showStaffDetails(currentStaffId);
                } catch(e){ console.error(e); showSuccessMessage('❌','刪除失敗，請重試','#e74c3c'); }
            }
        }

        // 培訓詳情
        function showTrainingDetails(categoryKey) {
            currentCategory = categoryKey;
            const staff = staffData[currentStaffId];
            const category = staff.trainingCategories[categoryKey];
            if (!category) { alert('找不到培訓資料'); return; }

            hideAllPages();
            document.getElementById('trainingDetailsPage').classList.add('active');

            const percentage = category.total>0 ? Math.round((category.completed/category.total)*100) : 0;
            const isCompleted = percentage === 100;
            const progressColor = isCompleted ? '#00b894' : '#74b9ff';

            const content = document.getElementById('trainingDetailContent');
            content.innerHTML = `
                <div class="staff-info" style="margin-bottom:25px;">👤 ${staff.name} (${staff.employeeId})</div>
                <div class="category-header">
                    <div class="category-icon">${category.icon}</div>
                    <div class="category-name">${category.name}</div>
                </div>
                <div class="progress-summary">
                    <div class="progress-circle-large">
                        <svg width="170" height="170" viewBox="0 0 170 170">
                            <circle cx="85" cy="85" r="75" fill="none" stroke="#ecf0f1" stroke-width="14"></circle>
                            <circle cx="85" cy="85" r="75" fill="none" stroke="${progressColor}"
                                    stroke-width="14" stroke-dasharray="${2*Math.PI*75}"
                                    stroke-dashoffset="${2*Math.PI*75*(1 - percentage/100)}"
                                    transform="rotate(-90 85 85)" stroke-linecap="round"></circle>
                        </svg>
                        <div class="progress-text-large">${percentage}%</div>
                    </div>
                    <div class="progress-stats">
                        <div class="stat-item"><div class="stat-number" style="color:#00b894;">${category.completed}</div><div class="stat-label">已完成</div></div>
                        <div class="stat-item"><div class="stat-number" style="color:#fd79a8;">${category.total - category.completed}</div><div class="stat-label">待完成</div></div>
                        <div class="stat-item"><div class="stat-number" style="color:#2c3e50;">${category.total}</div><div class="stat-label">總項目</div></div>
                    </div>
                    ${isCompleted ? '<div style="margin-top:25px; font-size:24px; color:#00b894; font-weight:bold;">🎉 恭喜！所有培訓項目已完成</div>':''}
                </div>
                <div style="margin-top:50px;">
                    <div class="section-title">📋 培訓記錄明細</div>
                    <div class="click-hint">💡 點擊培訓記錄${(currentUserRole==='admin' || currentUserRole==='supervisor') ? '進行評核或':''}查看詳情</div>
                    <div class="records-grid" id="recordsGrid"></div>
                    ${currentUserRole === 'admin' ? `
                        <div class="training-card add-new-record" onclick="showAddRecordModal()" style="border:3px dashed #fd79a8; background: linear-gradient(135deg, #fff5f5, #ffe6e6); margin-top:25px;">
                            <div class="training-icon" style="font-size:36px; color:#fd79a8;">➕</div>
                            <div class="training-name" style="color:#fd79a8; font-size:18px;">新增培訓記錄</div>
                            <div class="progress-info" style="color:#fd79a8;">點擊新增培訓明細項目</div>
                        </div>
                    `:''}
                </div>
            `;

            const grid = document.getElementById('recordsGrid');
            let rhtml = '';
            category.records.forEach((record, index) => {
                let statusClass, statusText, dateText;
                if (record.failed) { statusClass='failed'; statusText='❌ 不合格需重做'; dateText = `評核日期：${record.date} | 狀態：需要重新評核`; }
                else if (record.completed) { statusClass='completed'; statusText='✅ 已完成'; dateText = `完成日期：${record.date}`; }
                else { statusClass='pending'; statusText='⏳ 待完成'; dateText='尚未完成'; }
                rhtml += `
                    <div class="record-item ${statusClass}" onclick="openTrainingRecord(${index})">
                        ${currentUserRole === 'admin' ? `<button class="delete-btn-corner" onclick="event.stopPropagation(); deleteTrainingRecord(${index})" title="刪除培訓記錄">🗑️</button>`:''}
                        <div class="record-status ${statusClass}">${statusText}</div>
                        <div class="record-name">${record.name}</div>
                        <div class="record-date">${dateText}</div>
                        ${(record.type==='assessment' || record.type==='checklist') ? `
                            <div style="margin-top:10px; font-size:14px; opacity:.8;">
                                📋 ${record.type==='assessment' ? '評核項目':'檢查清單'}
                                ${record.assessmentItems ? `(${record.completedItems||0}/${record.totalItems} 通過${record.failedItems ? `, ${record.failedItems} 不合格` : ''})` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            grid.innerHTML = rhtml;

            applyRoleVisibility();
        }

        function openTrainingRecord(recordIndex) {
            currentRecordIndex = recordIndex;
            const staff = staffData[currentStaffId];
            const category = staff.trainingCategories[currentCategory];
            const record = category.records[recordIndex];

            // 員工帳號不能切換簡單記錄，也不能在評核內按通過/不合格/重設
            if (record.type === 'assessment' || record.type === 'checklist') {
                showAssessmentModal(record);
            } else {
                if (currentUserRole === 'admin' || currentUserRole === 'supervisor') {
                    toggleSimpleRecord(recordIndex);
                } else {
                    // 只能查看，不改動
                    alert('此記錄為簡單記錄，您沒有權限更改完成狀態。');
                }
            }
        }

        async function toggleSimpleRecord(recordIndex) {
            if (!(currentUserRole === 'admin' || currentUserRole === 'supervisor')) return;
            const staff = staffData[currentStaffId];
            const category = staff.trainingCategories[currentCategory];
            const record = category.records[recordIndex];

            if (record.completed) { record.completed = false; record.date = null; category.completed--; }
            else { record.completed = true; record.date = getCurrentDate(); category.completed++; }

            if (window.saveTrainingProgressToFirebase) await window.saveTrainingProgressToFirebase(currentStaffId, currentCategory, recordIndex, record.completed);
            showTrainingDetails(currentCategory);
            showSuccessMessage(record.completed ? '✅':'⏳', `「${record.name}」已${record.completed ? '完成':'取消完成'}！`, record.completed ? '#00b894' : '#f39c12');
        }

        // 評核彈窗（員工角色按鈕禁用）
        function showAssessmentModal(record) {
            validateAssessmentItems(record);
            const roleCanGrade = (currentUserRole === 'admin' || currentUserRole === 'supervisor');
            const modal = document.createElement('div');
            modal.className = 'assessment-modal';

            const completedItems = record.assessmentItems ? record.assessmentItems.filter(i=>i.passed).length : 0;
            const totalItems = record.assessmentItems ? record.assessmentItems.length : 0;
            const progressPercentage = totalItems>0 ? Math.round((completedItems/totalItems)*100) : 0;

            modal.innerHTML = `
                <div class="assessment-content">
                    <div class="assessment-header">
                        <h3 style="color:#2c3e50; margin-bottom:10px;">📋 ${record.name}</h3>
                        <div class="assessment-progress">
                            進度：${completedItems}/${totalItems} (${progressPercentage}%)
                            ${record.criticalItems ? ` | Critical Items: ${record.assessmentItems ? record.assessmentItems.filter(item => item.isCritical && item.passed).length : 0}/${record.criticalItems}` : ''}
                            ${record.passMark ? ` | 合格分數: ${record.passMark}/100` : ''}
                        </div>
                    </div>
                    <div class="assessment-items">
                        ${record.assessmentItems ? record.assessmentItems.map((item, index) => `
                            <div class="assessment-item-row ${item.passed ? 'passed' : (item.failed ? 'failed':'')}" id="assessmentItem${index}">
                                <div class="assessment-item-text">
                                    ${item.isCritical ? '<span style="color:#e74c3c; font-weight:bold;">[CRITICAL] </span>':''}
                                    ${item.name}
                                </div>
                                <div class="assessment-controls">
                                    <button class="assessment-btn pass-btn" ${roleCanGrade ? `onclick="setAssessmentItemResult(${index}, 'pass')"`:'disabled'}>${roleCanGrade?'✅ 通過':'🔒 無權限'}</button>
                                    <button class="assessment-btn fail-btn" ${roleCanGrade ? `onclick="setAssessmentItemResult(${index}, 'fail')"`:'disabled'}>${roleCanGrade?'❌ 不合格':'🔒 無權限'}</button>
                                    <button class="assessment-btn reset-btn" ${roleCanGrade ? `onclick="setAssessmentItemResult(${index}, 'reset')"`:'disabled'}>${roleCanGrade?'🔄 重設':'🔒 無權限'}</button>
                                </div>
                            </div>
                        `).join('') : '<p>此記錄沒有評核項目</p>'}
                    </div>
                    <div style="display:flex; gap:15px; justify-content:center; margin-top:30px;">
                        <button onclick="closeAssessmentModal()" style="padding:15px 30px; background:#95a5a6; color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer;">❌ 關閉</button>
                        ${roleCanGrade ? `<button onclick="finishAssessment()" style="padding:15px 30px; background:#00b894; color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer;">✅ 完成評核</button>`:''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentAssessmentModal = modal;
        }
        function closeAssessmentModal(){ if (window.currentAssessmentModal){ document.body.removeChild(window.currentAssessmentModal); window.currentAssessmentModal=null; } }

        async function setAssessmentItemResult(itemIndex, result) {
            if (!(currentUserRole === 'admin' || currentUserRole === 'supervisor')) return;
            const staff = staffData[currentStaffId];
            const category = staff.trainingCategories[currentCategory];
            const record = category.records[currentRecordIndex];
            const item = record.assessmentItems[itemIndex];

            if (!item.hasOwnProperty('isCritical')) item.isCritical = false;
            item.passed = false; item.failed = false;
            if (result==='pass') item.passed = true;
            else if (result==='fail') item.failed = true;

            const row = document.getElementById(`assessmentItem${itemIndex}`);
            if (row) row.className = `assessment-item-row ${result==='pass'?'passed':(result==='fail'?'failed':'')}`;

            const passedItems = record.assessmentItems.filter(i=>i.passed).length;
            const failedItems = record.assessmentItems.filter(i=>i.failed).length;
            const totalItems = record.assessmentItems.length;
            const progressPercentage = Math.round((passedItems/totalItems)*100);
            const criticalPassed = record.assessmentItems.filter(i=>i.isCritical && i.passed).length;
            const totalCritical = record.criticalItems || 0;
            const progressText = `進度：${passedItems}/${totalItems} 通過 (${progressPercentage}%)${failedItems>0?` | ${failedItems} 項失敗`:''}${totalCritical>0?` | Critical: ${criticalPassed}/${totalCritical}`:''}${record.passMark?` | 合格分數: ${record.passMark}/100`:''}`;
            const el = document.querySelector('.assessment-progress'); if (el) el.textContent = progressText;

            record.completedItems = passedItems; record.failedItems = failedItems;

            try {
                if (window.addDoc && window.collection && window.db) {
                    const firebaseData = {
                        staffId:String(currentStaffId||'unknown'),
                        staffName:String(staff?.name||'未知員工'),
                        categoryKey:String(currentCategory||'unknown'),
                        recordIndex:Number(currentRecordIndex)||0,
                        recordName:String(record?.name||'未知記錄'),
                        itemIndex:Number(itemIndex)||0,
                        itemName:String(item?.name||'未知項目'),
                        result:String(result||'unknown'),
                        passed:Boolean(item?.passed),
                        failed:Boolean(item?.failed),
                        isCritical:Boolean(item?.isCritical),
                        timestamp:new Date(),
                        updatedBy:String(currentUser?.name||'admin')
                    };
                    await window.addDoc(window.collection(window.db,'assessment-item-results'), firebaseData);
                }
            } catch(e){ console.error(e); showSuccessMessage('❌', `儲存失敗: ${e.message}`, '#e74c3c'); }
        }

        async function finishAssessment() {
            if (!(currentUserRole === 'admin' || currentUserRole === 'supervisor')) return;
            const staff = staffData[currentStaffId];
            const category = staff.trainingCategories[currentCategory];
            const record = category.records[currentRecordIndex];

            const passedItems = record.assessmentItems ? record.assessmentItems.filter(i=>i.passed).length : 0;
            const failedItems = record.assessmentItems ? record.assessmentItems.filter(i=>i.failed).length : 0;
            const totalItems = record.assessmentItems ? record.assessmentItems.length : 0;

            const hasAnyResults = record.assessmentItems ? record.assessmentItems.some(i=>i.passed || i.failed) : false;
            if (!hasAnyResults || (passedItems===0 && failedItems===0)) {
                record.completed=false; record.failed=false; record.date=null; record.status='pending';
                category.completed = category.records.filter(r=>r.completed && !r.failed).length;
                if (window.saveTrainingProgressToFirebase) await window.saveTrainingProgressToFirebase(currentStaffId, currentCategory, currentRecordIndex, false, false);
                showSuccessMessage('⏳', `「${record.name}」已重設為待完成狀態`, '#f39c12');
                closeAssessmentModal(); showTrainingDetails(currentCategory); return;
            }

            const criticalItems = record.assessmentItems ? record.assessmentItems.filter(i=>i.isCritical) : [];
            const passedCritical = criticalItems.filter(i=>i.passed).length;
            const totalCritical = criticalItems.length;

            const score = totalItems>0 ? Math.round((passedItems/totalItems)*100) : 0;
            const passMark = record.passMark || 50;

            const criticalPassed = totalCritical===0 || (passedCritical===totalCritical);
            const scorePassed = score>=passMark;

            if (!criticalPassed) {
                record.completed=false; record.failed=true; record.date=getCurrentDate(); record.status='failed';
                category.completed = category.records.filter(r=>r.completed && !r.failed).length;
                showSuccessMessage('❌', `「${record.name}」評核不合格！Critical Items 未全部通過 (${passedCritical}/${totalCritical})`, '#e74c3c');
            } else if (!scorePassed) {
                record.completed=false; record.failed=true; record.date=getCurrentDate(); record.status='failed';
                category.completed = category.records.filter(r=>r.completed && !r.failed).length;
                showSuccessMessage('❌', `「${record.name}」評核不合格！分數未達標準 (${score}/${passMark})`, '#e74c3c');
            } else {
                record.completed=true; record.failed=false; record.date=getCurrentDate(); record.status='completed';
                category.completed = category.records.filter(r=>r.completed && !r.failed).length;
                showSuccessMessage('🎉', `恭喜！「${record.name}」評核已完成！分數：${score}/100`, '#00b894');
            }

            if (window.saveTrainingProgressToFirebase) await window.saveTrainingProgressToFirebase(currentStaffId, currentCategory, currentRecordIndex, record.completed, record.failed);
            closeAssessmentModal(); showTrainingDetails(currentCategory);
        }

        async function deleteTrainingRecord(recordIndex) {
            if (currentUserRole !== 'admin') return;
            const staff = staffData[currentStaffId];
            const category = staff.trainingCategories[currentCategory];
            const record = category.records[recordIndex];
            if (confirm(`⚠️ 確定要刪除培訓記錄「${record.name}」嗎？\n\n此操作無法復原！`)) {
                try {
                    if (window.addDoc && window.collection && window.db) {
                        await window.addDoc(window.collection(window.db,"deleted-training-records"), {
                            staffId: currentStaffId, staffName: staff.name, categoryKey: currentCategory,
                            recordIndex, recordName: record.name, recordId:`${currentStaffId}_${currentCategory}_${record.name}_${Date.now()}`,
                            deletedBy: currentUser ? currentUser.name : "admin", timestamp:new Date(), action:"delete"
                        });
                    }
                    category.records.splice(recordIndex,1);
                    category.total = category.records.length;
                    category.completed = category.records.filter(r=>r.completed && !r.failed).length;
                    showSuccessMessage('🗑️', `培訓記錄「${record.name}」已刪除！`, '#e74c3c');
                    showTrainingDetails(currentCategory);
                } catch(e){ console.error(e); showSuccessMessage('❌','刪除失敗，請重試','#e74c3c'); }
            }
        }

        function goBackToStaffList(){ showStaffList(currentGrade); }
        function goBackToStaffDetails(){ showStaffDetails(currentStaffId); }

        // 帳戶管理（僅系統管理員）
        function showUserManagement() {
            if (currentUserRole !== 'admin') { alert('❌ 權限不足！只有系統管理員可以訪問帳戶管理！'); return; }
            hideAllPages();
            document.getElementById('userManagementPage').classList.add('active');
            displayUserList();
        }

        function displayUserList() {
            const userList = document.getElementById('userList');
            let html = '';
            Object.values(userAccounts).forEach(user => {
                const roleColor = user.role === 'admin' ? '#e74c3c' : user.role === 'supervisor' ? '#f39c12' : '#00b894';
                html += `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-name">${user.name} (@${user.username})</div>
                            <div class="user-role" style="color:${roleColor};">
                                👤 ${user.role === 'admin' ? '系統管理員' : user.role === 'supervisor' ? '主管' : '員工'}
                                ${user.staffId ? ` | 🆔 StaffID: ${user.staffId}` : ''}
                                ${user.grade ? ` | 🏥 職級: ${user.grade}` : ''}
                                | 📧 ${user.email || '-'} | 📅 ${user.createdDate || '-'}
                            </div>
                        </div>
                        <div class="item-actions">
                            ${user.role !== 'admin' ? `<button class="delete-btn" onclick="confirmDeleteUser('${user.username}','${user.name}')">🗑️ 刪除</button>`:''}
                        </div>
                    </div>
                `;
            });
            userList.innerHTML = html;
        }

        // 新增用戶（fields: 姓名、職級、Login ID、Password；角色只能是主管、員工）
        function showAddUserModal() {
            if (currentUserRole !== 'admin') return;
            const modal = document.createElement('div');
            modal.className = 'confirm-dialog';
            modal.innerHTML = `
                <div class="confirm-content" style="max-width:620px;">
                    <div class="admin-title" style="color:#2c3e50;">➕ 新增用戶</div>
                    <div style="text-align:left;">
                        <label>姓名：</label>
                        <input id="newUserName" type="text" style="width:100%; padding:12px; border:2px solid #ecf0f1; border-radius:10px; margin:8px 0 15px;"/>
                        <label>用戶角色：</label>
                        <select id="newUserRole" style="width:100%; padding:12px; border:2px solid #ecf0f1; border-radius:10px; margin:8px 0 15px;">
                            <option value="supervisor">主管</option>
                            <option value="staff">員工</option>
                        </select>
                        <div id="gradeRow" style="display:block;">
                            <label>職級（員工必填）：</label>
                            <select id="newUserGrade" style="width:100%; padding:12px; border:2px solid #ecf0f1; border-radius:10px; margin:8px 0 15px;">
                                <option value="PCA1">PCA1</option>
                                <option value="PCA2">PCA2</option>
                                <option value="PCA3">PCA3</option>
                                <option value="OTA">OTA</option>
                            </select>
                        </div>
                        <label>Login ID：</label>
                        <input id="newUserLogin" type="text" style="width:100%; padding:12px; border:2px solid #ecf0f1; border-radius:10px; margin:8px 0 15px;"/>
                        <label>Password：</label>
                        <input id="newUserPassword" type="password" style="width:100%; padding:12px; border:2px solid #ecf0f1; border-radius:10px; margin:8px 0 15px;"/>
                        <div style="font-size:14px; color:#7f8c8d; margin:6px 0 14px;">提示：員工帳號將被自動分類至選定職級列表；只有系統管理員可更改員工職級。</div>
                    </div>
                    <div class="confirm-buttons" style="margin-top:10px;">
                        <button class="confirm-btn confirm-no" onclick="closeAnyDialog()">取消</button>
                        <button class="confirm-btn confirm-yes" onclick="addNewUser()">新增</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // 切換角色顯示職級
            const roleSel = modal.querySelector('#newUserRole');
            const gradeRow = modal.querySelector('#gradeRow');
            roleSel.addEventListener('change', function(){
                gradeRow.style.display = this.value === 'staff' ? 'block' : 'none';
            });
            window.currentConfirmDialog = modal;
        }

        function closeAnyDialog() {
            if (window.currentConfirmDialog) {
                document.body.removeChild(window.currentConfirmDialog);
                window.currentConfirmDialog = null;
            }
        }

        async function addNewUser() {
            if (currentUserRole !== 'admin') return;
            const name = document.getElementById('newUserName').value.trim();
            const role = document.getElementById('newUserRole').value;
            const grade = document.getElementById('newUserGrade').value;
            const login = document.getElementById('newUserLogin').value.trim();
            const pw = document.getElementById('newUserPassword').value.trim();

            if (!name || !role || !login || !pw) { alert('請填寫完整資料'); return; }
            if (userAccounts[login]) { alert('Login ID 已存在'); return; }
            if (role === 'staff' && !grade) { alert('員工必須選擇職級'); return; }

            const newUser = {
                username: login, password: pw, role, name,
                email:'', createdDate: getCurrentDate()
            };

            // 若為員工，需建立 staff 資料並綁定 staffId
            if (role === 'staff') {
                // 產生 staffId
                const staffId = `${name.replace(/\s+/g,'_').toLowerCase()}_${Date.now().toString().slice(-4)}`;
                const newStaff = {
                    name, employeeId: `${Math.floor(100000 + Math.random()*900000)}`, grade,
                    joinDate: getCurrentDate(),
                    assessments:{}, trainingCategories:{}
                };
                // 初始化所有評估項目
                assessmentConfig.forEach(ass => { newStaff.assessments[ass.type] = {passed:false, failed:false}; });

                staffData[staffId] = newStaff;
                if (!staffDatabase[grade]) staffDatabase[grade] = [];
                staffDatabase[grade].push({id: staffId, name});

                newUser.staffId = staffId;
                newUser.grade = grade;

                try {
                    if (window.saveStaffToFirebase) await window.saveStaffToFirebase(staffId, newStaff);
                } catch(e){ console.error(e); }
            }

            userAccounts[login] = newUser;

            try {
                if (window.saveUserToFirebase) await window.saveUserToFirebase(newUser);
            } catch(e){ console.error(e); }

            showSuccessMessage('✅', `已新增用戶「${name}」`, '#00b894');
            closeAnyDialog();
            displayUserList();
        }

        function confirmDeleteUser(username, name) {
            if (currentUserRole !== 'admin') return;
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            dialog.innerHTML = `
                <div class="confirm-content">
                    <div class="confirm-title">⚠️ 刪除用戶確認</div>
                    <div class="confirm-message">確定要刪除用戶「${name} (@${username})」嗎？此操作無法復原！</div>
                    <div class="confirm-buttons">
                        <button class="confirm-btn confirm-no" onclick="closeAnyDialog()">取消</button>
                        <button class="confirm-btn confirm-yes" onclick="deleteUser('${username}')">刪除</button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
            window.currentConfirmDialog = dialog;
        }

        async function deleteUser(username) {
            if (currentUserRole !== 'admin') return;
            const user = userAccounts[username];
            if (!user) { closeAnyDialog(); return; }

            // 若為員工，同步刪除 staff 與列表
            if (user.role === 'staff' && user.staffId && staffData[user.staffId]) {
                const staffName = staffData[user.staffId].name;
                const grade = staffData[user.staffId].grade;

                // 記錄刪除
                try {
                    if (window.addDoc && window.collection && window.db) {
                        await window.addDoc(window.collection(window.db,"deleted-staff"), {
                            staffId: user.staffId, staffName,
                            staffData: staffData[user.staffId],
                            deletedBy: currentUser ? currentUser.name : "admin",
                            timestamp:new Date(), action:"delete"
                        });
                    }
                } catch(e){ console.error(e); }

                delete staffData[user.staffId];
                if (staffDatabase[grade]) {
                    const idx = staffDatabase[grade].findIndex(s=>s.id===user.staffId);
                    if (idx>-1) staffDatabase[grade].splice(idx,1);
                }
            }

            // 刪除用戶
            delete userAccounts[username];

            try {
                if (window.deleteUserFromFirebase) await window.deleteUserFromFirebase(username);
            } catch(e){ console.error(e); }

            showSuccessMessage('🗑️', `用戶「${user.name}」已刪除！`, '#e74c3c');
            closeAnyDialog();
            displayUserList();
        }

        function exportUserData(){ alert('匯出功能開發中...'); }
        function showSystemSettings(){ alert('系統設定開發中...'); }

        // Enter鍵登入
        document.addEventListener('keypress', function(e){
            if (e.key === 'Enter' && document.getElementById('loginPage').classList.contains('active')) handleLogin();
        });

        // Firebase 儲存占位（若未載入 Firebase）
        window.saveTrainingCategoryToFirebase = async function(){ console.log("Firebase 離線占位: saveTrainingCategory"); };
        window.saveTrainingRecordToFirebase = async function(){ console.log("Firebase 離線占位: saveTrainingRecord"); };
        window.saveStaffToFirebase = async function(){ console.log("Firebase 離線占位: saveStaff"); };
        window.saveAssessmentConfigToFirebase = async function(){ console.log("Firebase 離線占位: saveAssessmentConfig"); };
        window.saveAssessmentResultToFirebase = async function(){ console.log("Firebase 離線占位: saveAssessmentResult"); };
        window.saveTrainingProgressToFirebase = async function(){ console.log("Firebase 離線占位: saveTrainingProgress"); };
        window.saveUserToFirebase = async function(){ console.log("Firebase 離線占位: saveUser"); };
        window.deleteUserFromFirebase = async function(){ console.log("Firebase 離線占位: deleteUser"); };
        window.firebaseReady = false;
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBUCakw1zrm4atg5TQ6lFHgGJ88Gofm6G0",
            authDomain: "tkoh-training-system-74b07.firebaseapp.com",
            projectId: "tkoh-training-system-74b07",
            storageBucket: "tkoh-training-system-74b07.firebasestorage.app",
            messagingSenderId: "1044004131681",
            appId: "1:1044004131681:web:8004fbf63324b98dc3eb20"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.orderBy = orderBy;
        window.doc = doc;
        window.deleteDoc = deleteDoc;

        console.log("🔥 Firebase 已成功連接！");

        // 將用戶、新增/刪除/修改動作寫入 Firebase（以便所有帳號即時反映）
        window.saveAssessmentResultToFirebase = async function(staffId, assessmentType, result) {
            try {
                await addDoc(collection(db,"assessments"), {
                    staffId, staffName: window.staffData[staffId].name,
                    assessmentType, result,
                    passed: result==='pass', failed: result==='fail',
                    timestamp: new Date(), date: (()=>{ const d=new Date(); return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear(); })(),
                    updatedBy: window.currentUser ? window.currentUser.name : 'admin'
                });
                console.log("✅ 評估結果已儲存到 Firebase");
            } catch (e) { console.error("❌ 評估結果儲存失敗: ", e); }
        };

        window.saveTrainingProgressToFirebase = async function(staffId, categoryKey, recordIndex, completed, failed=false) {
            try {
                const staff = window.staffData[staffId];
                const category = staff.trainingCategories[categoryKey];
                const record = category.records[recordIndex];
                await addDoc(collection(db,"training-progress"), {
                    staffId, staffName: staff.name, categoryKey, recordIndex, recordName: record.name,
                    completed, failed, date: (completed||failed) ? (()=>{
                        const d=new Date(); return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear();
                    })(): null,
                    timestamp:new Date(), updatedBy: window.currentUser ? window.currentUser.name : 'admin'
                });
                console.log("✅ 培訓進度已儲存到 Firebase");
            } catch(e){ console.error("❌ 培訓進度儲存失敗: ", e); }
        };

        window.saveTrainingCategoryToFirebase = async function(staffId, categoryKey, categoryData) {
            try {
                await addDoc(collection(db,"training-categories"), {
                    staffId, staffName: window.staffData[staffId].name, categoryKey, categoryData,
                    timestamp:new Date(), createdBy: window.currentUser ? window.currentUser.name : 'admin'
                });
                console.log("✅ 新培訓項目已儲存到 Firebase");
            } catch(e){ console.error("❌ 培訓項目儲存失敗: ", e); }
        };

        window.saveTrainingRecordToFirebase = async function(staffId, categoryKey, recordData) {
            try {
                await addDoc(collection(db,"training-record-details"), {
                    staffId, staffName: window.staffData[staffId].name, categoryKey, recordData,
                    timestamp:new Date(), createdBy: window.currentUser ? window.currentUser.name : 'admin'
                });
                console.log("✅ 新培訓記錄已儲存到 Firebase");
            } catch(e){ console.error("❌ 培訓記錄儲存失敗: ", e); }
        };

        window.saveStaffToFirebase = async function(staffId, staffData) {
            try {
                await addDoc(collection(db,"staff"), {
                    staffId, staffData,
                    timestamp:new Date(), createdBy: window.currentUser ? window.currentUser.name : 'admin'
                });
                console.log("✅ 新員工已儲存到 Firebase");
            } catch(e){ console.error("❌ 員工儲存失敗: ", e); }
        };

        window.saveAssessmentConfigToFirebase = async function(assessmentData) {
            try {
                await addDoc(collection(db,"assessment-config"), {
                    ...assessmentData, timestamp:new Date(), createdBy: window.currentUser ? window.currentUser.name : 'admin'
                });
                console.log("✅ 評估配置已儲存到 Firebase");
            } catch(e){ console.error("❌ 評估配置儲存失敗: ", e); }
        };

        // 用戶新增/刪除（僅系統管理員）
        window.saveUserToFirebase = async function(userData) {
            try {
                await addDoc(collection(db,"users"), {
                    ...userData, timestamp:new Date(), createdBy: window.currentUser ? window.currentUser.name : 'admin'
                });
                console.log("✅ 用戶已儲存到 Firebase");
            } catch(e){ console.error("❌ 用戶儲存失敗: ", e); }
        };
        window.deleteUserFromFirebase = async function(username) {
            // 可改為記錄刪除事件
            try {
                await addDoc(collection(db,"deleted-users"), {
                    username, deletedBy: window.currentUser ? window.currentUser.name : 'admin',
                    timestamp:new Date(), action:'delete'
                });
                console.log("✅ 用戶刪除已記錄到 Firebase");
            } catch(e){ console.error("❌ 刪除用戶事件寫入失敗: ", e); }
        };

        // 載入 Firebase 資料（即時反映全體變更）
        window.loadStaffDataFromFirebase = async function() {
            try {
                // 新員工
                const staffSnapshot = await getDocs(query(collection(db,"staff"), orderBy("timestamp","desc")));
                staffSnapshot.forEach(docSnap=>{
                    const data=docSnap.data();
                    const { staffId, staffData:newStaff } = data;
                    window.staffData[staffId] = { ...window.staffData[staffId], ...newStaff };
                    if (!window.staffDatabase[newStaff.grade]) window.staffDatabase[newStaff.grade] = [];
                    const exists = window.staffDatabase[newStaff.grade].find(s=>s.id===staffId);
                    if (!exists) window.staffDatabase[newStaff.grade].push({id: staffId, name: newStaff.name});
                });

                // 評估配置
                const acSnap = await getDocs(query(collection(db,"assessment-config"), orderBy("timestamp","desc")));
                acSnap.forEach(docSnap=>{
                    const data=docSnap.data();
                    const exists = window.assessmentConfig.find(a=>a.id===data.id);
                    if (!exists) window.assessmentConfig.push(data);
                });

                // 培訓類別
                const catSnap = await getDocs(query(collection(db,"training-categories"), orderBy("timestamp","desc")));
                catSnap.forEach(docSnap=>{
                    const data=docSnap.data();
                    const { staffId, categoryKey, categoryData } = data;
                    if (window.staffData[staffId]) {
                        if (!window.staffData[staffId].trainingCategories) window.staffData[staffId].trainingCategories = {};
                        window.staffData[staffId].trainingCategories[categoryKey] = {
                            ...categoryData,
                            records: window.staffData[staffId].trainingCategories[categoryKey]?.records || categoryData.records || [],
                            completed: window.staffData[staffId].trainingCategories[categoryKey]?.completed || categoryData.completed || 0,
                            total: window.staffData[staffId].trainingCategories[categoryKey]?.total || categoryData.total || 0
                        };
                    }
                });

                // 培訓記錄
                const recSnap = await getDocs(query(collection(db,"training-record-details"), orderBy("timestamp","desc")));
                // 清理避免重覆
                Object.keys(window.staffData).forEach(staffId=>{
                    const sd = window.staffData[staffId];
                    if (sd.trainingCategories) {
                        Object.keys(sd.trainingCategories).forEach(k=>{
                            const c = sd.trainingCategories[k];
                            if (!c.records.some(r=>r.fromFirebase)) c.records = c.records.filter(r=>!r.fromFirebase);
                        });
                    }
                });
                recSnap.forEach(docSnap=>{
                    const data=docSnap.data();
                    const { staffId, categoryKey, recordData } = data;
                    if (window.staffData[staffId] && window.staffData[staffId].trainingCategories && window.staffData[staffId].trainingCategories[categoryKey]) {
                        const category = window.staffData[staffId].trainingCategories[categoryKey];
                        recordData.fromFirebase = true;
                        const exists = category.records.find(r=>r.name===recordData.name);
                        if (!exists) category.records.push(recordData);
                    }
                });

                // 重新統計
                Object.keys(window.staffData).forEach(staffId=>{
                    const sd = window.staffData[staffId];
                    if (sd.trainingCategories) {
                        Object.keys(sd.trainingCategories).forEach(k=>{
                            const c = sd.trainingCategories[k];
                            c.total = c.records.length;
                            c.completed = c.records.filter(r=>r.completed && !r.failed).length;
                        });
                    }
                });

                // 評估結果
                const assessSnap = await getDocs(query(collection(db,"assessments"), orderBy("timestamp","desc")));
                const latestAssess = {};
                assessSnap.forEach(docSnap=>{
                    const data=docSnap.data();
                    const key = `${data.staffId}-${data.assessmentType}`;
                    if (!latestAssess[key] || latestAssess[key].timestamp < data.timestamp) latestAssess[key] = data;
                });
                Object.values(latestAssess).forEach(a=>{
                    if (window.staffData[a.staffId]) {
                        if (!window.staffData[a.staffId].assessments) window.staffData[a.staffId].assessments = {};
                        if (!window.staffData[a.staffId].assessments[a.assessmentType]) window.staffData[a.staffId].assessments[a.assessmentType] = {passed:false, failed:false};
                        window.staffData[a.staffId].assessments[a.assessmentType] = { passed: !!a.passed, failed: !!a.failed };
                    }
                });

                // 培訓進度
                const progSnap = await getDocs(query(collection(db,"training-progress"), orderBy("timestamp","desc")));
                const latestProg = {};
                progSnap.forEach(docSnap=>{
                    const data=docSnap.data();
                    const key = `${data.staffId}-${data.categoryKey}-${data.recordIndex}`;
                    if (!latestProg[key]) latestProg[key] = data;
                });
                Object.values(latestProg).forEach(p=>{
                    if (window.staffData[p.staffId] && window.staffData[p.staffId].trainingCategories && window.staffData[p.staffId].trainingCategories[p.categoryKey] && window.staffData[p.staffId].trainingCategories[p.categoryKey].records[p.recordIndex]) {
                        const r = window.staffData[p.staffId].trainingCategories[p.categoryKey].records[p.recordIndex];
                        r.completed = p.completed; r.failed = p.failed; r.date = p.date;
                    }
                });

                // 刪除操作應用
                try {
                    const delAssessSnap = await getDocs(query(collection(db,"deleted-assessments"), orderBy("timestamp","desc")));
                    delAssessSnap.forEach(docSnap=>{
                        const d=docSnap.data();
                        const idx = window.assessmentConfig.findIndex(a=>a.id===d.assessmentId);
                        if (idx>-1) window.assessmentConfig.splice(idx,1);
                        Object.keys(window.staffData).forEach(sid=>{
                            if (window.staffData[sid].assessments && window.staffData[sid].assessments[d.assessmentType]) {
                                delete window.staffData[sid].assessments[d.assessmentType];
                            }
                        });
                    });

                    const delCatSnap = await getDocs(query(collection(db,"deleted-training-categories"), orderBy("timestamp","desc")));
                    delCatSnap.forEach(docSnap=>{
                        const d = docSnap.data();
                        if (window.staffData[d.staffId] && window.staffData[d.staffId].trainingCategories && window.staffData[d.staffId].trainingCategories[d.categoryKey]) {
                            delete window.staffData[d.staffId].trainingCategories[d.categoryKey];
                        }
                    });

                    const delRecSnap = await getDocs(query(collection(db,"deleted-training-records"), orderBy("timestamp","desc")));
                    delRecSnap.forEach(docSnap=>{
                        const d = docSnap.data();
                        if (window.staffData[d.staffId] && window.staffData[d.staffId].trainingCategories && window.staffData[d.staffId].trainingCategories[d.categoryKey]) {
                            const cat = window.staffData[d.staffId].trainingCategories[d.categoryKey];
                            const idx = cat.records.findIndex(r=>r.name===d.recordName);
                            if (idx>-1) {
                                cat.records.splice(idx,1);
                                cat.total = cat.records.length;
                                cat.completed = cat.records.filter(r=>r.completed && !r.failed).length;
                            }
                        }
                    });

                    const delStaffSnap = await getDocs(query(collection(db,"deleted-staff"), orderBy("timestamp","desc")));
                    delStaffSnap.forEach(docSnap=>{
                        const d = docSnap.data();
                        if (window.staffData[d.staffId]) delete window.staffData[d.staffId];
                        Object.keys(window.staffDatabase).forEach(g=>{
                            const idx = window.staffDatabase[g].findIndex(s=>s.id===d.staffId);
                            if (idx>-1) window.staffDatabase[g].splice(idx,1);
                        });
                    });
                } catch(e){ console.error("載入刪除記錄失敗: ", e); }

                // 評核項目結果
                try {
                    const itemSnap = await getDocs(query(collection(db,"assessment-item-results"), orderBy("timestamp","desc")));
                    const latestItem = {};
                    itemSnap.forEach(docSnap=>{
                        const d=docSnap.data();
                        const key = `${d.staffId}-${d.categoryKey}-${d.recordIndex}-${d.itemIndex}`;
                        if (!latestItem[key] || latestItem[key].timestamp < d.timestamp) latestItem[key] = d;
                    });
                    Object.values(latestItem).forEach(ir=>{
                        if (window.staffData[ir.staffId] &&
                            window.staffData[ir.staffId].trainingCategories &&
                            window.staffData[ir.staffId].trainingCategories[ir.categoryKey] &&
                            window.staffData[ir.staffId].trainingCategories[ir.categoryKey].records[ir.recordIndex] &&
                            window.staffData[ir.staffId].trainingCategories[ir.categoryKey].records[ir.recordIndex].assessmentItems &&
                            window.staffData[ir.staffId].trainingCategories[ir.categoryKey].records[ir.recordIndex].assessmentItems[ir.itemIndex]) {
                                const item = window.staffData[ir.staffId].trainingCategories[ir.categoryKey].records[ir.recordIndex].assessmentItems[ir.itemIndex];
                                item.passed = ir.passed; item.failed = ir.failed;
                        }
                    });
                    // 重新計算
                    Object.keys(window.staffData).forEach(staffId=>{
                        const sd = window.staffData[staffId];
                        if (sd.trainingCategories) {
                            Object.keys(sd.trainingCategories).forEach(k=>{
                                const c = sd.trainingCategories[k];
                                c.records.forEach(r=>{
                                    if (r.assessmentItems) {
                                        r.completedItems = r.assessmentItems.filter(i=>i.passed).length;
                                        r.failedItems = r.assessmentItems.filter(i=>i.failed).length;
                                    }
                                });
                            });
                        }
                    });
                } catch(e){ console.error("❌ 載入評核項目結果失敗: ", e); }

                console.log("🎉 Firebase 資料載入完成！");
                return true;
            } catch(e){ console.error("❌ 載入 Firebase 資料失敗: ", e); return false; }
        };

        window.addEventListener('load', async function(){
            window.staffData = window.staffData || {}; // 已在上方定義
            window.assessmentConfig = window.assessmentConfig || [];
            window.staffDatabase = window.staffDatabase || {};
            await window.loadStaffDataFromFirebase();
            document.getElementById('loginId').focus();
            window.firebaseReady = true;
            console.log("✅ 系統準備就緒！");
        });
    </script>
</body>
</html>
