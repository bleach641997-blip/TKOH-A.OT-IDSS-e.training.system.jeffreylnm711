<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKOH åŸ¹è¨“ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
        }

        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #ff3838;
            transform: translateY(-2px);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .nav-tab:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .content-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #ff4757;
        }

        .btn-danger:hover {
            background: #ff3838;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .category-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .category-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .category-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .category-actions button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .category-actions button:hover {
            background: rgba(255,255,255,0.4);
        }

        .items-list {
            margin-top: 20px;
        }

        .item-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
        }

        .item-card:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .checklist-container {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .checklist-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .checklist-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .checklist-item.critical {
            border-left: 4px solid #ff4757;
        }

        .checklist-item.completed {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .checklist-item.failed {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-critical {
            background: #ff4757;
            color: white;
        }

        .step-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            margin-left: 5px;
        }

        .step-btn-pass {
            background: #2ed573;
            color: white;
        }

        .step-btn-fail {
            background: #ff4757;
            color: white;
        }

        .step-btn-reset {
            background: #ffa502;
            color: white;
        }

        .step-btn:hover {
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-modal {
            background: #ff4757;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: #ff3838;
            transform: rotate(90deg);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        .toast.active {
            display: flex;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 5px solid #2ed573;
        }

        .toast.error {
            border-left: 5px solid #ff4757;
        }

        .toast.warning {
            border-left: 5px solid #ffa502;
        }

        .progress-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .progress-bar-container {
            background: #e0e0e0;
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .staff-select-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .staff-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }

        .staff-card:hover {
            background: #e9ecef;
            transform: translateY(-3px);
        }

        .staff-card.selected {
            border-color: #667eea;
            background: #e7eaff;
        }

        .staff-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .staff-role {
            font-size: 0.9em;
            color: #666;
        }

        .checklist-step-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checklist-step-input input {
            flex: 1;
        }

        .checklist-step-input button {
            padding: 8px 15px;
        }

        .checklist-steps-list {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .checklist-step-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-container h2 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        /* åŸ¹è¨“é …ç›®é¤…åœ–è¨­è¨ˆ */
        .item-pie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-pie-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .item-pie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .item-pie-card.status-pending {
            border: 3px solid #ffa502;
        }

        .item-pie-card.status-pass {
            border: 3px solid #2ed573;
        }

        .item-pie-card.status-fail {
            border: 3px solid #ff4757;
        }

        .pie-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .pie-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .pie-status {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
            margin-top: 5px;
        }

        .pie-status.pending {
            background: #ffa502;
            color: white;
        }

        .pie-status.pass {
            background: #2ed573;
            color: white;
        }

        .pie-status.fail {
            background: #ff4757;
            color: white;
        }

        /* å±•é–‹çš„è©•æ ¸ä»‹é¢ */
        .item-evaluation-expanded {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .evaluation-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }

        /* é‡è¦è©•æ ¸æ™‚é–“è¡¨ */
        .important-timeline {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .timeline-header {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timeline-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .timeline-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .timeline-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .timeline-item.overdue {
            border-left-color: #ff4757;
            background: #fff5f5;
        }

        .timeline-item.completed {
            border-left-color: #2ed573;
            background: #f0fff4;
        }

        .timeline-item-info {
            flex: 1;
        }

        .timeline-item-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .timeline-item-deadline {
            font-size: 0.9em;
            color: #666;
        }

        .timeline-item-status {
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .deadline-calculator {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .deadline-calculator input,
        .deadline-calculator select {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
        }

        .position-selector {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .position-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .position-option:hover {
            background: #f8f9fa;
        }

        .position-option.selected {
            border-color: #667eea;
            background: #e7eaff;
        }

        .position-option input[type="checkbox"] {
            margin-right: 8px;
        }

        .checklist-step-name {
            flex: 1;
        }

        .checklist-step-actions {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div id="loginPage">
        <div class="login-container">
            <h2>ğŸ¥ TKOH åŸ¹è¨“ç³»çµ±</h2>
            <div class="form-group">
                <label>å“¡å·¥ç·¨è™Ÿ</label>
                <input type="text" id="loginStaffId" placeholder="è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ">
            </div>
            <div class="form-group">
                <label>å¯†ç¢¼</label>
                <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
            <button class="btn" onclick="login()" style="width: 100%;">ç™»å…¥</button>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="container">
            <div class="header">
                <h1>ğŸ¥ TKOH åŸ¹è¨“ç³»çµ±</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName" style="font-weight: bold;"></div>
                        <div id="userRole" style="font-size: 0.9em; color: #666;"></div>
                    </div>
                    <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>

            <div class="nav-tabs" id="navTabs"></div>

            <!-- åŸ¹è¨“é€²åº¦é é¢ -->
            <div id="progressPage" class="page">
                <!-- é‡è¦è©•æ ¸æ™‚é–“è¡¨ -->
                <div class="important-timeline">
                    <div class="timeline-header">
                        â° é‡è¦è©•æ ¸æ™‚é–“è¡¨
                    </div>
                    <div class="timeline-list" id="importantTimeline">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="staff-select-container" id="staffSelectContainer" style="display: none;">
                    <h3>é¸æ“‡å“¡å·¥</h3>
                    <div class="staff-grid" id="staffGrid"></div>
                </div>

                <div id="progressContent"></div>
            </div>

            <!-- åˆ†é¡ç®¡ç†é é¢ -->
            <div id="categoryPage" class="page">
                <div class="content-box">
                    <button class="btn" onclick="openAddCategoryModal()">â• æ–°å¢åŸ¹è¨“åˆ†é¡</button>
                    <div class="category-grid" id="categoryGrid"></div>
                </div>
            </div>

            <!-- åŸ¹è¨“é …ç›®ç®¡ç†é é¢ -->
            <div id="itemsPage" class="page">
                <div class="content-box">
                    <button class="btn btn-secondary" onclick="showPage('categoryPage')">â† è¿”å›åˆ†é¡</button>
                    <h2 id="itemsCategoryTitle"></h2>
                    <button class="btn" onclick="openAddItemModal()">â• æ–°å¢åŸ¹è¨“é …ç›®</button>
                    <div class="items-list" id="itemsList"></div>
                </div>
            </div>

            <!-- è©•æ ¸é é¢ -->
            <div id="itemEvaluationPage" class="page">
                <div class="content-box">
                    <button class="btn btn-secondary" onclick="backToProgress()">â† è¿”å›</button>
                    <h2 id="evaluationCategoryTitle"></h2>
                    <div id="evaluationContent"></div>
                    <div id="expandedEvaluation"></div>
                </div>
            </div>

            <!-- å“¡å·¥ç®¡ç†é é¢ -->
            <div id="staffPage" class="page">
                <div class="content-box">
                    <button class="btn" onclick="openAddStaffModal()">â• æ–°å¢å“¡å·¥</button>
                    <div id="staffList" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢åˆ†é¡ Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°å¢åŸ¹è¨“åˆ†é¡</h2>
                <button class="close-modal" onclick="closeModal('addCategoryModal')">Ã—</button>
            </div>
            <div class="form-group">
                <label>åœ–ç¤º Emoji</label>
                <input type="text" id="categoryEmoji" placeholder="ä¾‹å¦‚: ğŸ“š">
            </div>
            <div class="form-group">
                <label>åˆ†é¡åç¨±</label>
                <input type="text" id="categoryName" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨±">
            </div>
            <button class="btn" onclick="addCategory()">æ–°å¢</button>
        </div>
    </div>

    <!-- ç·¨è¼¯åˆ†é¡ Modal -->
    <div id="editCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç·¨è¼¯åŸ¹è¨“åˆ†é¡</h2>
                <button class="close-modal" onclick="closeModal('editCategoryModal')">Ã—</button>
            </div>
            <div class="form-group">
                <label>åœ–ç¤º Emoji</label>
                <input type="text" id="editCategoryEmoji">
            </div>
            <div class="form-group">
                <label>åˆ†é¡åç¨±</label>
                <input type="text" id="editCategoryName">
            </div>
            <button class="btn" onclick="updateCategory()">æ›´æ–°</button>
        </div>
    </div>

    <!-- æ–°å¢åŸ¹è¨“é …ç›® Modal -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°å¢åŸ¹è¨“é …ç›®</h2>
                <button class="close-modal" onclick="closeModal('addItemModal')">Ã—</button>
            </div>
            <div class="form-group">
                <label>é …ç›®åç¨±</label>
                <input type="text" id="itemName" placeholder="è«‹è¼¸å…¥é …ç›®åç¨±">
            </div>
            <div class="form-group">
                <label>é …ç›®èªªæ˜</label>
                <textarea id="itemDescription" rows="3" placeholder="è«‹è¼¸å…¥é …ç›®èªªæ˜"></textarea>
            </div>

            <!-- æˆªæ­¢æ—¥æœŸè¨ˆç®—åŠŸèƒ½ -->
            <div class="form-group">
                <label>â° æˆªæ­¢æ—¥æœŸè¨ˆç®—</label>
                <div class="deadline-calculator">
                    <span>å…¥è·å¾Œ</span>
                    <input type="number" id="deadlineValue" placeholder="æ•¸é‡" min="1" style="width: 80px;">
                    <select id="deadlineUnit">
                        <option value="day">æ—¥</option>
                        <option value="week">å‘¨</option>
                        <option value="month">æœˆ</option>
                    </select>
                    <span>å…§å®Œæˆ</span>
                </div>
            </div>

            <!-- é¸æ“‡è·ä½åŠŸèƒ½ -->
            <div class="form-group">
                <label>ğŸ“‹ é©ç”¨è·ä½</label>
                <div class="position-selector">
                    <div class="position-option" onclick="togglePosition('PCA')">
                        <input type="checkbox" id="positionPCA" onclick="event.stopPropagation()">
                        <label for="positionPCA">PCA</label>
                    </div>
                    <div class="position-option" onclick="togglePosition('OTA')">
                        <input type="checkbox" id="positionOTA" onclick="event.stopPropagation()">
                        <label for="positionOTA">OTA</label>
                    </div>
                </div>
            </div>

            <!-- åŠ å…¥é‡è¦è©•æ ¸æ™‚é–“è¡¨ -->
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="addToImportantTimeline">
                    <label for="addToImportantTimeline">â­ åŠ å…¥é‡è¦è©•æ ¸æ™‚é–“è¡¨</label>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="itemHasChecklist" onchange="toggleChecklistInput()">
                    <label for="itemHasChecklist">æ­¤é …ç›®éœ€è¦è©•æ ¸æ­¥é©Ÿ (Checklist)</label>
                </div>
            </div>
            <div id="checklistInputArea" style="display: none;">
                <div class="form-group">
                    <label>è©•æ ¸æ­¥é©Ÿ</label>
                    <div class="checklist-step-input">
                        <input type="text" id="newChecklistStep" placeholder="è¼¸å…¥è©•æ ¸æ­¥é©Ÿ">
                        <div class="checkbox-group">
                            <input type="checkbox" id="newStepCritical">
                            <label for="newStepCritical">Critical</label>
                        </div>
                        <button class="btn btn-small" onclick="addChecklistStep()">â• æ–°å¢æ­¥é©Ÿ</button>
                    </div>
                    <div class="checklist-steps-list" id="checklistStepsList"></div>
                </div>
            </div>
            <button class="btn" onclick="addTrainingItem()">æ–°å¢é …ç›®</button>
        </div>
    </div>

    <!-- ç·¨è¼¯åŸ¹è¨“é …ç›® Modal -->
    <div id="editItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç·¨è¼¯åŸ¹è¨“é …ç›®</h2>
                <button class="close-modal" onclick="closeModal('editItemModal')">Ã—</button>
            </div>
            <div class="form-group">
                <label>é …ç›®åç¨±</label>
                <input type="text" id="editItemName">
            </div>
            <div class="form-group">
                <label>é …ç›®èªªæ˜</label>
                <textarea id="editItemDescription" rows="3"></textarea>
            </div>

            <!-- ç·¨è¼¯æˆªæ­¢æ—¥æœŸè¨ˆç®—åŠŸèƒ½ -->
            <div class="form-group">
                <label>â° æˆªæ­¢æ—¥æœŸè¨ˆç®—</label>
                <div class="deadline-calculator">
                    <span>å…¥è·å¾Œ</span>
                    <input type="number" id="editDeadlineValue" placeholder="æ•¸é‡" min="1" style="width: 80px;">
                    <select id="editDeadlineUnit">
                        <option value="day">æ—¥</option>
                        <option value="week">å‘¨</option>
                        <option value="month">æœˆ</option>
                    </select>
                    <span>å…§å®Œæˆ</span>
                </div>
            </div>

            <!-- ç·¨è¼¯é¸æ“‡è·ä½åŠŸèƒ½ -->
            <div class="form-group">
                <label>ğŸ“‹ é©ç”¨è·ä½</label>
                <div class="position-selector">
                    <div class="position-option" onclick="toggleEditPosition('PCA')">
                        <input type="checkbox" id="editPositionPCA" onclick="event.stopPropagation()">
                        <label for="editPositionPCA">PCA</label>
                    </div>
                    <div class="position-option" onclick="toggleEditPosition('OTA')">
                        <input type="checkbox" id="editPositionOTA" onclick="event.stopPropagation()">
                        <label for="editPositionOTA">OTA</label>
                    </div>
                </div>
            </div>

            <!-- ç·¨è¼¯åŠ å…¥é‡è¦è©•æ ¸æ™‚é–“è¡¨ -->
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="editAddToImportantTimeline">
                    <label for="editAddToImportantTimeline">â­ åŠ å…¥é‡è¦è©•æ ¸æ™‚é–“è¡¨</label>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="editItemHasChecklist" onchange="toggleEditChecklistInput()">
                    <label for="editItemHasChecklist">æ­¤é …ç›®éœ€è¦è©•æ ¸æ­¥é©Ÿ (Checklist)</label>
                </div>
            </div>
            <div id="editChecklistInputArea" style="display: none;">
                <div class="form-group">
                    <label>è©•æ ¸æ­¥é©Ÿ</label>
                    <div class="checklist-step-input">
                        <input type="text" id="editNewChecklistStep" placeholder="è¼¸å…¥è©•æ ¸æ­¥é©Ÿ">
                        <div class="checkbox-group">
                            <input type="checkbox" id="editNewStepCritical">
                            <label for="editNewStepCritical">Critical</label>
                        </div>
                        <button class="btn btn-small" onclick="addEditChecklistStep()">â• æ–°å¢æ­¥é©Ÿ</button>
                    </div>
                    <div class="checklist-steps-list" id="editChecklistStepsList"></div>
                </div>
            </div>
            <button class="btn" onclick="updateTrainingItem()">æ›´æ–°é …ç›®</button>
        </div>
    </div>

    <!-- æ–°å¢å“¡å·¥ Modal -->
    <div id="addStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°å¢å“¡å·¥</h2>
                <button class="close-modal" onclick="closeModal('addStaffModal')">Ã—</button>
            </div>
            <div class="form-group">
                <label>å“¡å·¥ç·¨è™Ÿ</label>
                <input type="text" id="newStaffId" placeholder="è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ">
            </div>
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="newStaffName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="form-group">
                <label>è·ä½</label>
                <select id="newStaffPosition">
                    <option value="PCA">PCA</option>
                    <option value="OTA">OTA</option>
                </select>
            </div>
            <div class="form-group">
                <label>å…¥è·æ—¥æœŸ</label>
                <input type="date" id="newStaffJoinDate">
            </div>
            <div class="form-group">
                <label>è§’è‰²</label>
                <select id="newStaffRole">
                    <option value="staff">å“¡å·¥</option>
                    <option value="supervisor">ä¸»ç®¡</option>
                    <option value="admin">ç®¡ç†å“¡</option>
                </select>
            </div>
            <div class="form-group">
                <label>å¯†ç¢¼</label>
                <input type="password" id="newStaffPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
            <button class="btn" onclick="addStaff()">æ–°å¢å“¡å·¥</button>
        </div>
    </div>

    <!-- ç·¨è¼¯å“¡å·¥ Modal -->
    <div id="editStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç·¨è¼¯å“¡å·¥</h2>
                <button class="close-modal" onclick="closeModal('editStaffModal')">Ã—</button>
            </div>
            <div class="form-group">
                <label>å“¡å·¥ç·¨è™Ÿ</label>
                <input type="text" id="editStaffId" disabled>
            </div>
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="editStaffName">
            </div>
            <div class="form-group">
                <label>è·ä½</label>
                <select id="editStaffPosition">
                    <option value="PCA">PCA</option>
                    <option value="OTA">OTA</option>
                </select>
            </div>
            <div class="form-group">
                <label>å…¥è·æ—¥æœŸ</label>
                <input type="date" id="editStaffJoinDate">
            </div>
            <div class="form-group">
                <label>è§’è‰²</label>
                <select id="editStaffRole">
                    <option value="staff">å“¡å·¥</option>
                    <option value="supervisor">ä¸»ç®¡</option>
                    <option value="admin">ç®¡ç†å“¡</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ–°å¯†ç¢¼ï¼ˆç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹ï¼‰</label>
                <input type="password" id="editStaffPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
            </div>
            <button class="btn" onclick="updateStaff()">æ›´æ–°å“¡å·¥</button>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBnocao757Ø¯Ø§Ø¹Bu7pm37250J8cJIBrs",
            authDomain: "tkoh-a-ot-idss-e-training.firebaseapp.com",
            projectId: "tkoh-a-ot-idss-e-training",
            storageBucket: "tkoh-a-ot-idss-e-training.firebasestorage.app",
            messagingSenderId: "185074093048",
            appId: "1:185074093048:web:711fcc3f17bdf7eb3e4c46"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // å…¨å±€è®Šæ•¸
        let currentUser = null;
        let currentCategoryId = null;
        let currentItemId = null;
        let currentStaffId = null;
        let tempChecklist = [];
        let tempEditChecklist = [];

        // ==================== ç™»å…¥ç™»å‡º ====================
        async function login() {
            const staffId = document.getElementById('loginStaffId').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!staffId || !password) {
                showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡æ–™', 'warning');
                return;
            }

            try {
                const usersSnapshot = await db.collection('users')
                    .where('staffId', '==', staffId)
                    .where('password', '==', password)
                    .limit(1)
                    .get();

                if (usersSnapshot.empty) {
                    showToast('âŒ å“¡å·¥ç·¨è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤', 'error');
                    return;
                }

                const userDoc = usersSnapshot.docs[0];
                currentUser = { docId: userDoc.id, ...userDoc.data() };
                currentStaffId = currentUser.staffId;

                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';

                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userRole').textContent = getRoleText(currentUser.role);
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);

                initializeNavigation();
                showPage('progressPage');
                loadProgress();

                showToast('âœ… ç™»å…¥æˆåŠŸ', 'success');
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                showToast('âŒ ç™»å…¥å¤±æ•—', 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentStaffId = null;
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('loginStaffId').value = '';
            document.getElementById('loginPassword').value = '';
            showToast('âœ… å·²ç™»å‡º', 'success');
        }

        function getRoleText(role) {
            const roles = {
                'admin': 'ç®¡ç†å“¡',
                'supervisor': 'ä¸»ç®¡',
                'staff': 'å“¡å·¥'
            };
            return roles[role] || 'å“¡å·¥';
        }

        // ==================== å°èˆªç³»çµ± ====================
        function initializeNavigation() {
            const tabs = [
                { id: 'progressPage', name: 'ğŸ“Š åŸ¹è¨“é€²åº¦', roles: ['admin', 'supervisor', 'staff'] },
                { id: 'categoryPage', name: 'ğŸ“š åˆ†é¡ç®¡ç†', roles: ['admin'] },
                { id: 'staffPage', name: 'ğŸ‘¥ å“¡å·¥ç®¡ç†', roles: ['admin'] }
            ];

            const navHtml = tabs
                .filter(tab => tab.roles.includes(currentUser.role))
                .map(tab => `<button class="nav-tab" onclick="showPage('${tab.id}')">${tab.name}</button>`)
                .join('');

            document.getElementById('navTabs').innerHTML = navHtml;
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            document.getElementById(pageId).classList.add('active');

            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                if (tab.textContent.includes(getPageName(pageId))) {
                    tab.classList.add('active');
                }
            });

            if (pageId === 'progressPage') {
                loadProgress();
            } else if (pageId === 'categoryPage') {
                loadCategories();
            } else if (pageId === 'staffPage') {
                loadStaffList();
            }
        }

        function getPageName(pageId) {
            const names = {
                'progressPage': 'åŸ¹è¨“é€²åº¦',
                'categoryPage': 'åˆ†é¡ç®¡ç†',
                'staffPage': 'å“¡å·¥ç®¡ç†'
            };
            return names[pageId] || '';
        }

        // ==================== åŸ¹è¨“é€²åº¦ ====================
        async function loadProgress() {
            try {
                // è¼‰å…¥é‡è¦è©•æ ¸æ™‚é–“è¡¨
                await loadImportantTimeline();

                if (currentUser.role === 'admin' || currentUser.role === 'supervisor') {
                    document.getElementById('staffSelectContainer').style.display = 'block';
                    await loadStaffGrid();
                } else {
                    document.getElementById('staffSelectContainer').style.display = 'none';
                    await displayProgress(currentStaffId);
                }
            } catch (error) {
                console.error('è¼‰å…¥é€²åº¦å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
            }
        }

        // ==================== é‡è¦è©•æ ¸æ™‚é–“è¡¨ ====================
        async function loadImportantTimeline() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.docId).get();
                const userData = userDoc.data();
                const joinDate = userData.joinDate ? new Date(userData.joinDate) : new Date();

                // ç²å–æ‰€æœ‰åŠ å…¥é‡è¦æ™‚é–“è¡¨çš„åŸ¹è¨“é …ç›®
                const itemsSnapshot = await db.collection('trainingItems')
                    .where('isImportant', '==', true)
                    .get();

                // ç²å–è©²å“¡å·¥çš„è©•æ ¸è¨˜éŒ„
                const recordsSnapshot = await db.collection('trainingRecords')
                    .where('userId', '==', currentStaffId)
                    .get();

                const records = {};
                recordsSnapshot.forEach(doc => {
                    const record = doc.data();
                    records[record.itemId] = record;
                });

                const timelineItems = [];
                const today = new Date();

                for (const doc of itemsSnapshot.docs) {
                    const item = doc.data();
                    
                    // æª¢æŸ¥è·ä½æ˜¯å¦ç¬¦åˆ
                    if (item.positions && item.positions.length > 0) {
                        if (!item.positions.includes(userData.position)) {
                            continue; // è·³éä¸é©ç”¨çš„è·ä½
                        }
                    }

                    // è¨ˆç®—æˆªæ­¢æ—¥æœŸ
                    let deadline = null;
                    if (item.deadlineValue && item.deadlineUnit) {
                        deadline = new Date(joinDate);
                        if (item.deadlineUnit === 'day') {
                            deadline.setDate(deadline.getDate() + item.deadlineValue);
                        } else if (item.deadlineUnit === 'week') {
                            deadline.setDate(deadline.getDate() + (item.deadlineValue * 7));
                        } else if (item.deadlineUnit === 'month') {
                            deadline.setMonth(deadline.getMonth() + item.deadlineValue);
                        }
                    }

                    // åˆ¤æ–·ç‹€æ…‹
                    let status = 'pending';
                    let statusText = 'â³ å¾…å®Œæˆ';
                    let statusClass = '';

                    const record = records[doc.id];
                    if (item.hasChecklist && record?.checklistStatus) {
                        const allCriticalPassed = item.checklist.every((step, index) => {
                            if (!step.critical) return true;
                            return record.checklistStatus[index] === 'pass';
                        });

                        const hasCriticalFailed = item.checklist.some((step, index) => {
                            if (!step.critical) return false;
                            return record.checklistStatus[index] === 'fail';
                        });

                        if (allCriticalPassed) {
                            status = 'completed';
                            statusText = 'âœ… å·²å®Œæˆ';
                            statusClass = 'completed';
                        } else if (hasCriticalFailed) {
                            status = 'failed';
                            statusText = 'âŒ ä¸åˆæ ¼';
                            statusClass = 'overdue';
                        }
                    }

                    // æª¢æŸ¥æ˜¯å¦é€¾æœŸ
                    if (deadline && status === 'pending' && today > deadline) {
                        statusClass = 'overdue';
                        statusText = 'âš ï¸ å·²é€¾æœŸ';
                    }

                    timelineItems.push({
                        name: item.name,
                        deadline: deadline,
                        status: status,
                        statusText: statusText,
                        statusClass: statusClass,
                        categoryId: item.categoryId
                    });
                }

                // æŒ‰æˆªæ­¢æ—¥æœŸæ’åº
                timelineItems.sort((a, b) => {
                    if (!a.deadline) return 1;
                    if (!b.deadline) return -1;
                    return a.deadline - b.deadline;
                });

                // é¡¯ç¤ºæ™‚é–“è¡¨
                const timelineHtml = timelineItems.length > 0 ? timelineItems.map(item => {
                    const deadlineStr = item.deadline ? 
                        `æˆªæ­¢æ—¥æœŸ: ${item.deadline.toLocaleDateString('zh-HK')}` : 
                        'ç„¡æˆªæ­¢æ—¥æœŸ';

                    return `
                        <div class="timeline-item ${item.statusClass}">
                            <div class="timeline-item-info">
                                <div class="timeline-item-name">${item.name}</div>
                                <div class="timeline-item-deadline">${deadlineStr}</div>
                            </div>
                            <div class="timeline-item-status" style="background: ${getStatusColor(item.status)}; color: white;">
                                ${item.statusText}
                            </div>
                        </div>
                    `;
                }).join('') : '<div style="text-align: center; color: #999; padding: 20px;">æš«ç„¡é‡è¦è©•æ ¸é …ç›®</div>';

                document.getElementById('importantTimeline').innerHTML = timelineHtml;

            } catch (error) {
                console.error('è¼‰å…¥é‡è¦è©•æ ¸æ™‚é–“è¡¨å¤±æ•—:', error);
            }
        }

        function getStatusColor(status) {
            const colors = {
                'completed': '#2ed573',
                'failed': '#ff4757',
                'pending': '#ffa502'
            };
            return colors[status] || '#999';
        }

        async function loadStaffGrid() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const users = [];
                usersSnapshot.forEach(doc => {
                    users.push({ docId: doc.id, ...doc.data() });
                });

                const gridHtml = users.map(user => `
                    <div class="staff-card ${user.staffId === currentStaffId ? 'selected' : ''}" 
                         onclick="selectStaff('${user.staffId}')">
                        <div class="staff-name">${user.name}</div>
                        <div class="staff-role">${user.staffId}</div>
                        <div class="staff-role">${user.position || ''}</div>
                    </div>
                `).join('');

                document.getElementById('staffGrid').innerHTML = gridHtml;
            } catch (error) {
                console.error('è¼‰å…¥å“¡å·¥æ¸…å–®å¤±æ•—:', error);
            }
        }

        async function selectStaff(staffId) {
            currentStaffId = staffId;
            document.querySelectorAll('.staff-card').forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            await displayProgress(staffId);
            await loadImportantTimeline(); // é‡æ–°è¼‰å…¥æ™‚é–“è¡¨
        }

        async function displayProgress(staffId) {
            try {
                const categoriesSnapshot = await db.collection('trainingCategories').get();
                const categories = [];
                categoriesSnapshot.forEach(doc => {
                    categories.push({ docId: doc.id, ...doc.data() });
                });
                categories.sort((a, b) => (a.order || 0) - (b.order || 0));

                let progressHtml = '';

                for (const category of categories) {
                    const itemsSnapshot = await db.collection('trainingItems')
                        .where('categoryId', '==', category.docId)
                        .get();

                    const items = [];
                    itemsSnapshot.forEach(doc => {
                        items.push({ docId: doc.id, ...doc.data() });
                    });

                    const recordsSnapshot = await db.collection('trainingRecords')
                        .where('userId', '==', staffId)
                        .get();

                    const records = {};
                    recordsSnapshot.forEach(doc => {
                        const record = doc.data();
                        records[record.itemId] = record;
                    });

                    let completedCount = 0;
                    items.forEach(item => {
                        if (item.hasChecklist) {
                            const record = records[item.docId];
                            if (record?.checklistStatus) {
                                const allCriticalPassed = item.checklist.every((step, index) => {
                                    if (!step.critical) return true;
                                    return record.checklistStatus[index] === 'pass';
                                });
                                if (allCriticalPassed) completedCount++;
                            }
                        } else {
                            if (records[item.docId]?.status === 'completed') completedCount++;
                        }
                    });

                    const totalCount = items.length;
                    const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

                    progressHtml += `
                        <div class="progress-card">
                            <h3 style="color: #667eea; margin-bottom: 15px;">
                                ${category.emoji} ${category.name}
                            </h3>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>é€²åº¦: ${completedCount} / ${totalCount}</span>
                                <span style="font-weight: bold; color: #667eea;">${percentage}%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${percentage}%">${percentage}%</div>
                            </div>
                            <button class="btn btn-small" style="margin-top: 15px;" 
                                    onclick="showCategoryEvaluation('${category.docId}')">
                                ğŸ“ é€²å…¥è©•æ ¸
                            </button>
                        </div>
                    `;
                }

                document.getElementById('progressContent').innerHTML = progressHtml;
            } catch (error) {
                console.error('é¡¯ç¤ºé€²åº¦å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
            }
        }

        // ==================== é¡¯ç¤ºåˆ†é¡è©•æ ¸ï¼ˆé¤…åœ–è¨­è¨ˆï¼‰====================
        async function showCategoryEvaluation(categoryId) {
            currentCategoryId = categoryId;
            showPage('itemEvaluationPage');

            try {
                const categoryDoc = await db.collection('trainingCategories').doc(categoryId).get();
                const category = categoryDoc.data();

                document.getElementById('evaluationCategoryTitle').textContent = `${category.emoji} ${category.name} - è©•æ ¸`;

                const itemsSnapshot = await db.collection('trainingItems')
                    .where('categoryId', '==', categoryId)
                    .get();

                const items = [];
                itemsSnapshot.forEach(doc => {
                    items.push({ docId: doc.id, ...doc.data() });
                });
                items.sort((a, b) => (a.order || 0) - (b.order || 0));

                const recordsSnapshot = await db.collection('trainingRecords')
                    .where('userId', '==', currentStaffId)
                    .get();

                const records = {};
                recordsSnapshot.forEach(doc => {
                    const record = doc.data();
                    records[record.itemId] = { docId: doc.id, ...record };
                });

                // é¤…åœ–é¡¯ç¤º
                const pieHtml = items.map(item => {
                    const record = records[item.docId];
                    let status = 'pending';
                    let statusText = 'â³ å¾…å®Œæˆ';
                    let statusClass = 'pending';

                    if (item.hasChecklist && record?.checklistStatus) {
                        const allCriticalPassed = item.checklist.every((step, index) => {
                            if (!step.critical) return true;
                            return record.checklistStatus[index] === 'pass';
                        });

                        const hasCriticalFailed = item.checklist.some((step, index) => {
                            if (!step.critical) return false;
                            return record.checklistStatus[index] === 'fail';
                        });

                        if (hasCriticalFailed) {
                            status = 'fail';
                            statusText = 'âŒ ä¸åˆæ ¼';
                            statusClass = 'fail';
                        } else if (allCriticalPassed) {
                            status = 'pass';
                            statusText = 'âœ… åˆæ ¼';
                            statusClass = 'pass';
                        }
                    }

                    return `
                        <div class="item-pie-card status-${statusClass}" onclick="expandItemEvaluation('${item.docId}')">
                            <div class="pie-icon">ğŸ“‹</div>
                            <div class="pie-title">${item.name}</div>
                            <div class="pie-status ${statusClass}">${statusText}</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('evaluationContent').innerHTML = `
                    <div class="item-pie-grid">
                        ${pieHtml}
                    </div>
                `;

            } catch (error) {
                console.error('è¼‰å…¥è©•æ ¸å…§å®¹å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
            }
        }

        // ==================== å±•é–‹åŸ¹è¨“é …ç›®è©•æ ¸ ====================
        async function expandItemEvaluation(itemId) {
            try {
                const itemDoc = await db.collection('trainingItems').doc(itemId).get();
                const item = itemDoc.data();

                const recordsSnapshot = await db.collection('trainingRecords')
                    .where('userId', '==', currentStaffId)
                    .where('itemId', '==', itemId)
                    .limit(1)
                    .get();

                const record = recordsSnapshot.empty ? null : recordsSnapshot.docs[0].data();
                const checklistStatus = record?.checklistStatus || {};

                if (!item.hasChecklist || !item.checklist) {
                    showToast('âš ï¸ æ­¤é …ç›®ç„¡è©•æ ¸æ­¥é©Ÿ', 'warning');
                    return;
                }

                const checklistHtml = item.checklist.map((step, index) => {
                    const status = checklistStatus[index] || 'pending';
                    let statusClass = '';
                    let statusText = '';

                    if (status === 'pass') {
                        statusClass = 'completed';
                        statusText = 'âœ… åˆæ ¼';
                    } else if (status === 'fail') {
                        statusClass = 'failed';
                        statusText = 'âŒ ä¸åˆæ ¼';
                    } else {
                        statusText = 'â³ å¾…è©•æ ¸';
                    }

                    const criticalBadge = step.critical ? '<span class="badge badge-critical">âš ï¸ Critical</span>' : '';

                    return `
                        <div class="checklist-item ${statusClass} ${step.critical ? 'critical' : ''}">
                            <div class="checklist-step-name">
                                ${step.step} ${criticalBadge} ${statusText}
                            </div>
                            ${currentUser.role === 'admin' || currentUser.role === 'supervisor' ? `
                                <div class="checklist-step-actions">
                                    <button class="step-btn step-btn-pass" onclick="updateChecklistStepStatus('${itemId}', ${index}, 'pass')">âœ… åˆæ ¼</button>
                                    <button class="step-btn step-btn-fail" onclick="updateChecklistStepStatus('${itemId}', ${index}, 'fail')">âŒ ä¸åˆæ ¼</button>
                                    <button class="step-btn step-btn-reset" onclick="updateChecklistStepStatus('${itemId}', ${index}, 'pending')">ğŸ”„ é‡è¨­</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                document.getElementById('expandedEvaluation').innerHTML = `
                    <div class="item-evaluation-expanded">
                        <div class="evaluation-header">
                            <div class="evaluation-title">ğŸ“‹ ${item.name}</div>
                            <button class="btn btn-secondary btn-small" onclick="closeExpandedEvaluation()">âŒ é—œé–‰</button>
                        </div>
                        <div class="checklist-container">
                            <div class="checklist-header">è©•æ ¸æ­¥é©Ÿ Checklist</div>
                            ${checklistHtml}
                        </div>
                    </div>
                `;

                // å¹³æ»‘æ»¾å‹•åˆ°å±•é–‹çš„å…§å®¹
                document.getElementById('expandedEvaluation').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } catch (error) {
                console.error('å±•é–‹è©•æ ¸å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
            }
        }

        // ==================== é—œé–‰å±•é–‹çš„è©•æ ¸ ====================
        function closeExpandedEvaluation() {
            document.getElementById('expandedEvaluation').innerHTML = '';
        }

        async function updateChecklistStepStatus(itemId, stepIndex, status) {
            try {
                const recordsSnapshot = await db.collection('trainingRecords')
                    .where('userId', '==', currentStaffId)
                    .where('itemId', '==', itemId)
                    .limit(1)
                    .get();

                let checklistStatus = {};

                if (!recordsSnapshot.empty) {
                    const recordDoc = recordsSnapshot.docs[0];
                    checklistStatus = recordDoc.data().checklistStatus || {};
                    checklistStatus[stepIndex] = status;

                    await db.collection('trainingRecords').doc(recordDoc.id).update({
                        checklistStatus: checklistStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.staffId
                    });
                } else {
                    checklistStatus[stepIndex] = status;
                    await db.collection('trainingRecords').add({
                        userId: currentStaffId,
                        itemId: itemId,
                        checklistStatus: checklistStatus,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.staffId
                    });
                }

                showToast('âœ… æ­¥é©Ÿè©•æ ¸å·²æ›´æ–°', 'success');
                closeExpandedEvaluation();
                showCategoryEvaluation(currentCategoryId);
                loadImportantTimeline(); // é‡æ–°è¼‰å…¥æ™‚é–“è¡¨

            } catch (error) {
                console.error('æ›´æ–°è©•æ ¸ç‹€æ…‹å¤±æ•—:', error);
                showToast('âŒ æ›´æ–°å¤±æ•—', 'error');
            }
        }

        function backToProgress() {
            showPage('progressPage');
            loadProgress();
        }

        // ==================== åˆ†é¡ç®¡ç† ====================
        async function loadCategories() {
            try {
                const snapshot = await db.collection('trainingCategories').get();
                const categories = [];
                snapshot.forEach(doc => {
                    categories.push({ docId: doc.id, ...doc.data() });
                });

                categories.sort((a, b) => (a.order || 0) - (b.order || 0));

                const html = categories.map(cat => `
                    <div class="category-card" onclick="showCategoryItems('${cat.docId}')">
                        <div class="category-actions">
                            <button onclick="event.stopPropagation(); openEditCategoryModal('${cat.docId}')">âœï¸</button>
                            <button onclick="event.stopPropagation(); deleteCategory('${cat.docId}')">ğŸ—‘ï¸</button>
                        </div>
                        <h3>${cat.emoji} ${cat.name}</h3>
                        <p style="opacity: 0.8; margin-top: 10px;">é»æ“ŠæŸ¥çœ‹åŸ¹è¨“é …ç›®</p>
                    </div>
                `).join('');

                document.getElementById('categoryGrid').innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥åˆ†é¡å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
            }
        }

        function openAddCategoryModal() {
            document.getElementById('categoryEmoji').value = '';
            document.getElementById('categoryName').value = '';
            openModal('addCategoryModal');
        }

        async function addCategory() {
            const emoji = document.getElementById('categoryEmoji').value.trim();
            const name = document.getElementById('categoryName').value.trim();

            if (!emoji || !name) {
                showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡æ–™', 'warning');
                return;
            }

            try {
                const snapshot = await db.collection('trainingCategories').get();
                const order = snapshot.size;

                await db.collection('trainingCategories').add({
                    emoji: emoji,
                    name: name,
                    order: order,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('âœ… åˆ†é¡æ–°å¢æˆåŠŸ', 'success');
                closeModal('addCategoryModal');
                loadCategories();
            } catch (error) {
                console.error('æ–°å¢åˆ†é¡å¤±æ•—:', error);
                showToast('âŒ æ–°å¢å¤±æ•—', 'error');
            }
        }

        async function openEditCategoryModal(categoryId) {
            try {
                const doc = await db.collection('trainingCategories').doc(categoryId).get();
                const category = doc.data();

                currentCategoryId = categoryId;
                document.getElementById('editCategoryEmoji').value = category.emoji;
                document.getElementById('editCategoryName').value = category.name;
                openModal('editCategoryModal');
            } catch (error) {
                console.error('è¼‰å…¥åˆ†é¡è³‡æ–™å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
            }
        }

        async function updateCategory() {
            const emoji = document.getElementById('editCategoryEmoji').value.trim();
            const name = document.getElementById('editCategoryName').value.trim();

            if (!emoji || !name) {
                showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡æ–™', 'warning');
                return;
            }

            try {
                await db.collection('trainingCategories').doc(currentCategoryId).update({
                    emoji: emoji,
                    name: name,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('âœ… åˆ†é¡æ›´æ–°æˆåŠŸ', 'success');
                closeModal('editCategoryModal');
                loadCategories();
            } catch (error) {
                console.error('æ›´æ–°åˆ†é¡å¤±æ•—:', error);
                showToast('âŒ æ›´æ–°å¤±æ•—', 'error');
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†é¡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

            try {
                await db.collection('trainingCategories').doc(categoryId).delete();
                showToast('âœ… åˆ†é¡å·²åˆªé™¤', 'success');
                loadCategories();
            } catch (error) {
                console.error('åˆªé™¤åˆ†é¡å¤±æ•—:', error);
                showToast('âŒ åˆªé™¤å¤±æ•—', 'error');
            }
        }

        // ==================== åŸ¹è¨“é …ç›®ç®¡ç† ====================
        async function showCategoryItems(categoryId) {
            currentCategoryId = categoryId;
            showPage('itemsPage');

            try {
                const categoryDoc = await db.collection('trainingCategories').doc(categoryId).get();
                const category = categoryDoc.data();

                document.getElementById('itemsCategoryTitle').textContent = `${category.emoji} ${category.name}`;

                const snapshot = await db.collection('trainingItems')
                    .where('categoryId', '==', categoryId)
                    .get();

                const items = [];
                snapshot.forEach(doc => {
                    items.push({ docId: doc.id, ...doc.data() });
                });

                items.sort((a, b) => (a.order || 0) - (b.order || 0));

                const html = items.map(item => {
                    const checklistHtml = item.hasChecklist && item.checklist ? 
                        `<div class="checklist-container">
                            <div class="checklist-header">ğŸ“‹ è©•æ ¸æ­¥é©Ÿ Checklist</div>
                            ${item.checklist.map(step => `
                                <div class="checklist-item ${step.critical ? 'critical' : ''}">
                                    ${step.step}
                                    ${step.critical ? '<span class="badge badge-critical">âš ï¸ Critical</span>' : ''}
                                </div>
                            `).join('')}
                        </div>` : '';

                    const deadlineInfo = item.deadlineValue && item.deadlineUnit ?
                        `<div style="margin-top: 10px; color: #666;">
                            â° æˆªæ­¢æ—¥æœŸ: å…¥è·å¾Œ ${item.deadlineValue} ${getUnitText(item.deadlineUnit)} å…§å®Œæˆ
                        </div>` : '';

                    const positionInfo = item.positions && item.positions.length > 0 ?
                        `<div style="margin-top: 5px; color: #666;">
                            ğŸ“‹ é©ç”¨è·ä½: ${item.positions.join(', ')}
                        </div>` : '';

                    const importantBadge = item.isImportant ?
                        '<span class="badge" style="background: #ffa502; color: white; margin-left: 10px;">â­ é‡è¦è©•æ ¸</span>' : '';

                    return `
                        <div class="item-card">
                            <div class="item-header">
                                <h3>${item.name}${importantBadge}</h3>
                                <div class="item-actions">
                                    <button class="btn btn-small" onclick="openEditItemModal('${item.docId}')">âœï¸ ç·¨è¼¯</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteTrainingItem('${item.docId}')">ğŸ—‘ï¸ åˆªé™¤</button>
                                </div>
                            </div>
                            <p style="color: #666; margin-top: 10px;">${item.description || ''}</p>
                            ${deadlineInfo}
                            ${positionInfo}
                            ${checklistHtml}
                        </div>
                    `;
                }).join('');

                document.getElementById('itemsList').innerHTML = html || '<p style="text-align: center; color: #999;">æš«ç„¡åŸ¹è¨“é …ç›®</p>';

            } catch (error) {
                console.error('è¼‰å…¥åŸ¹è¨“é …ç›®å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
            }
        }

        function getUnitText(unit) {
            const units = {
                'day': 'æ—¥',
                'week': 'å‘¨',
                'month': 'æœˆ'
            };
            return units[unit] || '';
        }

        function openAddItemModal() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemDescription').value = '';
            document.getElementById('deadlineValue').value = '';
            document.getElementById('deadlineUnit').value = 'day';
            document.getElementById('positionPCA').checked = false;
            document.getElementById('positionOTA').checked = false;
            document.getElementById('addToImportantTimeline').checked = false;
            document.getElementById('itemHasChecklist').checked = false;
            tempChecklist = [];
            toggleChecklistInput();
            updatePositionSelector();
            openModal('addItemModal');
        }

        function togglePosition(position) {
            const checkbox = document.getElementById(`position${position}`);
            checkbox.checked = !checkbox.checked;
            updatePositionSelector();
        }

        function toggleEditPosition(position) {
            const checkbox = document.getElementById(`editPosition${position}`);
            checkbox.checked = !checkbox.checked;
            updateEditPositionSelector();
        }

        function updatePositionSelector() {
            const pcaOption = document.querySelector('.position-option:has(#positionPCA)');
            const otaOption = document.querySelector('.position-option:has(#positionOTA)');
            
            pcaOption.classList.toggle('selected', document.getElementById('positionPCA').checked);
            otaOption.classList.toggle('selected', document.getElementById('positionOTA').checked);
        }

        function updateEditPositionSelector() {
            const pcaOption = document.querySelector('.position-option:has(#editPositionPCA)');
            const otaOption = document.querySelector('.position-option:has(#editPositionOTA)');
            
            pcaOption.classList.toggle('selected', document.getElementById('editPositionPCA').checked);
            otaOption.classList.toggle('selected', document.getElementById('editPositionOTA').checked);
        }

        function toggleChecklistInput() {
            const hasChecklist = document.getElementById('itemHasChecklist').checked;
            document.getElementById('checklistInputArea').style.display = hasChecklist ? 'block' : 'none';
            if (!hasChecklist) {
                tempChecklist = [];
                updateChecklistDisplay();
            }
        }

        function toggleEditChecklistInput() {
            const hasChecklist = document.getElementById('editItemHasChecklist').checked;
            document.getElementById('editChecklistInputArea').style.display = hasChecklist ? 'block' : 'none';
        }

        function addChecklistStep() {
            const stepInput = document.getElementById('newChecklistStep');
            const isCritical = document.getElementById('newStepCritical').checked;
            const stepText = stepInput.value.trim();

            if (!stepText) {
                showToast('âš ï¸ è«‹è¼¸å…¥è©•æ ¸æ­¥é©Ÿ', 'warning');
                return;
            }

            tempChecklist.push({
                step: stepText,
                critical: isCritical
            });

            stepInput.value = '';
            document.getElementById('newStepCritical').checked = false;
            updateChecklistDisplay();
        }

        function updateChecklistDisplay() {
            const html = tempChecklist.map((step, index) => `
                <div class="checklist-step-item">
                    <span>
                        ${step.step}
                        ${step.critical ? '<span class="badge badge-critical">âš ï¸ Critical</span>' : ''}
                    </span>
                    <button class="btn btn-danger btn-small" onclick="removeChecklistStep(${index})">ğŸ—‘ï¸</button>
                </div>
            `).join('');

            document.getElementById('checklistStepsList').innerHTML = html || '<p style="text-align: center; color: #999;">æš«ç„¡è©•æ ¸æ­¥é©Ÿ</p>';
        }

        function removeChecklistStep(index) {
            tempChecklist.splice(index, 1);
            updateChecklistDisplay();
        }

        async function addTrainingItem() {
            const name = document.getElementById('itemName').value.trim();
            const description = document.getElementById('itemDescription').value.trim();
            const deadlineValue = document.getElementById('deadlineValue').value;
            const deadlineUnit = document.getElementById('deadlineUnit').value;
            const hasChecklist = document.getElementById('itemHasChecklist').checked;
            const isImportant = document.getElementById('addToImportantTimeline').checked;

            const positions = [];
            if (document.getElementById('positionPCA').checked) positions.push('PCA');
            if (document.getElementById('positionOTA').checked) positions.push('OTA');

            if (!name) {
                showToast('âš ï¸ è«‹å¡«å¯«é …ç›®åç¨±', 'warning');
                return;
            }

            if (hasChecklist && tempChecklist.length === 0) {
                showToast('âš ï¸ è«‹è‡³å°‘æ–°å¢ä¸€å€‹è©•æ ¸æ­¥é©Ÿ', 'warning');
                return;
            }

            try {
                const snapshot = await db.collection('trainingItems')
                    .where('categoryId', '==', currentCategoryId)
                    .get();
                const order = snapshot.size;

                const itemData = {
                    categoryId: currentCategoryId,
                    name: name,
                    description: description,
                    order: order,
                    hasChecklist: hasChecklist,
                    isImportant: isImportant,
                    positions: positions,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (deadlineValue) {
                    itemData.deadlineValue = parseInt(deadlineValue);
                    itemData.deadlineUnit = deadlineUnit;
                }

                if (hasChecklist) {
                    itemData.checklist = tempChecklist;
                }

                await db.collection('trainingItems').add(itemData);

                showToast('âœ… åŸ¹è¨“é …ç›®æ–°å¢æˆåŠŸ', 'success');
                closeModal('addItemModal');
                showCategoryItems(currentCategoryId);
            } catch (error) {
                console.error('æ–°å¢åŸ¹è¨“é …ç›®å¤±æ•—:', error);
                showToast('âŒ æ–°å¢å¤±æ•—', 'error');
            }
        }

        async function openEditItemModal(itemId) {
            try {
                const doc = await db.collection('trainingItems').doc(itemId).get();
                const item = doc.data();

                currentItemId = itemId;
                document.getElementById('editItemName').value = item.name;
                document.getElementById('editItemDescription').value = item.description || '';
                document.getElementById('editDeadlineValue').value = item.deadlineValue || '';
                document.getElementById('editDeadlineUnit').value = item.deadlineUnit || 'day';
                document.getElementById('editItemHasChecklist').checked = item.hasChecklist || false;
                document.getElementById('editAddToImportantTimeline').checked = item.isImportant || false;

                // è¨­ç½®è·ä½é¸æ“‡
                document.getElementById('editPositionPCA').checked = item.positions?.includes('PCA') || false;
                document.getElementById('editPositionOTA').checked = item.positions?.includes('OTA') || false;
                updateEditPositionSelector();

                tempEditChecklist = item.checklist ? [...item.checklist] : [];

                toggleEditChecklistInput();
                updateEditChecklistDisplay();

                openModal('editItemModal');
            } catch (error) {
                console.error('è¼‰å…¥é …ç›®è³‡æ–™å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
            }
        }

        function addEditChecklistStep() {
            const stepInput = document.getElementById('editNewChecklistStep');
            const isCritical = document.getElementById('editNewStepCritical').checked;
            const stepText = stepInput.value.trim();

            if (!stepText) {
                showToast('âš ï¸ è«‹è¼¸å…¥è©•æ ¸æ­¥é©Ÿ', 'warning');
                return;
            }

            tempEditChecklist.push({
                step: stepText,
                critical: isCritical
            });

            stepInput.value = '';
            document.getElementById('editNewStepCritical').checked = false;
            updateEditChecklistDisplay();
        }

        function updateEditChecklistDisplay() {
            const html = tempEditChecklist.map((step, index) => `
                <div class="checklist-step-item">
                    <span>
                        ${step.step}
                        ${step.critical ? '<span class="badge badge-critical">âš ï¸ Critical</span>' : ''}
                    </span>
                    <button class="btn btn-danger btn-small" onclick="removeEditChecklistStep(${index})">ğŸ—‘ï¸</button>
                </div>
            `).join('');

            document.getElementById('editChecklistStepsList').innerHTML = html || '<p style="text-align: center; color: #999;">æš«ç„¡è©•æ ¸æ­¥é©Ÿ</p>';
        }

        function removeEditChecklistStep(index) {
            tempEditChecklist.splice(index, 1);
            updateEditChecklistDisplay();
        }

        async function updateTrainingItem() {
            const name = document.getElementById('editItemName').value.trim();
            const description = document.getElementById('editItemDescription').value.trim();
            const deadlineValue = document.getElementById('editDeadlineValue').value;
            const deadlineUnit = document.getElementById('editDeadlineUnit').value;
            const hasChecklist = document.getElementById('editItemHasChecklist').checked;
            const isImportant = document.getElementById('editAddToImportantTimeline').checked;

            const positions = [];
            if (document.getElementById('editPositionPCA').checked) positions.push('PCA');
            if (document.getElementById('editPositionOTA').checked) positions.push('OTA');

            if (!name) {
                showToast('âš ï¸ è«‹å¡«å¯«é …ç›®åç¨±', 'warning');
                return;
            }

            if (hasChecklist && tempEditChecklist.length === 0) {
                showToast('âš ï¸ è«‹è‡³å°‘æ–°å¢ä¸€å€‹è©•æ ¸æ­¥é©Ÿ', 'warning');
                return;
            }

            try {
                const updateData = {
                    name: name,
                    description: description,
                    hasChecklist: hasChecklist,
                    isImportant: isImportant,
                    positions: positions,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (deadlineValue) {
                    updateData.deadlineValue = parseInt(deadlineValue);
                    updateData.deadlineUnit = deadlineUnit;
                } else {
                    updateData.deadlineValue = firebase.firestore.FieldValue.delete();
                    updateData.deadlineUnit = firebase.firestore.FieldValue.delete();
                }

                if (hasChecklist) {
                    updateData.checklist = tempEditChecklist;
                } else {
                    updateData.checklist = firebase.firestore.FieldValue.delete();
                }

                await db.collection('trainingItems').doc(currentItemId).update(updateData);

                showToast('âœ… åŸ¹è¨“é …ç›®æ›´æ–°æˆåŠŸ', 'success');
                closeModal('editItemModal');
                showCategoryItems(currentCategoryId);
            } catch (error) {
                console.error('æ›´æ–°åŸ¹è¨“é …ç›®å¤±æ•—:', error);
                showToast('âŒ æ›´æ–°å¤±æ•—', 'error');
            }
        }

        async function deleteTrainingItem(itemId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åŸ¹è¨“é …ç›®å—ï¼Ÿ')) return;

            try {
                await db.collection('trainingItems').doc(itemId).delete();
                showToast('âœ… åŸ¹è¨“é …ç›®å·²åˆªé™¤', 'success');
                showCategoryItems(currentCategoryId);
            } catch (error) {
                console.error('åˆªé™¤åŸ¹è¨“é …ç›®å¤±æ•—:', error);
                showToast('âŒ åˆªé™¤å¤±æ•—', 'error');
            }
        }

        // ==================== å“¡å·¥ç®¡ç† ====================
        async function loadStaffList() {
            try {
                const snapshot = await db.collection('users').get();
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ docId: doc.id, ...doc.data() });
                });

                const html = users.map(user => `
                    <div class="item-card">
                        <div class="item-header">
                            <div>
                                <h3>${user.name}</h3>
                                <p style="color: #666; margin-top: 5px;">
                                    å“¡å·¥ç·¨è™Ÿ: ${user.staffId} | 
                                    è·ä½: ${user.position || '-'} | 
                                    è§’è‰²: ${getRoleText(user.role)} |
                                    å…¥è·æ—¥æœŸ: ${user.joinDate || '-'}
                                </p>
                            </div>
                            <div class="item-actions">
                                <button class="btn btn-small" onclick="openEditStaffModal('${user.docId}')">âœï¸ ç·¨è¼¯</button>
                                <button class="btn btn-danger btn-small" onclick="deleteStaff('${user.docId}')">ğŸ—‘ï¸ åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('staffList').innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥å“¡å·¥æ¸…å–®å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
            }
        }

        function openAddStaffModal() {
            document.getElementById('newStaffId').value = '';
            document.getElementById('newStaffName').value = '';
            document.getElementById('newStaffPosition').value = 'PCA';
            document.getElementById('newStaffJoinDate').value = '';
            document.getElementById('newStaffRole').value = 'staff';
            document.getElementById('newStaffPassword').value = '';
            openModal('addStaffModal');
        }

        async function addStaff() {
            const staffId = document.getElementById('newStaffId').value.trim();
            const name = document.getElementById('newStaffName').value.trim();
            const position = document.getElementById('newStaffPosition').value;
            const joinDate = document.getElementById('newStaffJoinDate').value;
            const role = document.getElementById('newStaffRole').value;
            const password = document.getElementById('newStaffPassword').value;

            if (!staffId || !name || !password || !joinDate) {
                showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡æ–™', 'warning');
                return;
            }

            try {
                const existingUser = await db.collection('users')
                    .where('staffId', '==', staffId)
                    .limit(1)
                    .get();

                if (!existingUser.empty) {
                    showToast('âŒ å“¡å·¥ç·¨è™Ÿå·²å­˜åœ¨', 'error');
                    return;
                }

                await db.collection('users').add({
                    staffId: staffId,
                    name: name,
                    position: position,
                    joinDate: joinDate,
                    role: role,
                    password: password,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('âœ… å“¡å·¥æ–°å¢æˆåŠŸ', 'success');
                closeModal('addStaffModal');
                loadStaffList();
            } catch (error) {
                console.error('æ–°å¢å“¡å·¥å¤±æ•—:', error);
                showToast('âŒ æ–°å¢å¤±æ•—', 'error');
            }
        }

        async function openEditStaffModal(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                const user = doc.data();

                currentItemId = userId;
                document.getElementById('editStaffId').value = user.staffId;
                document.getElementById('editStaffName').value = user.name;
                document.getElementById('editStaffPosition').value = user.position || 'PCA';
                document.getElementById('editStaffJoinDate').value = user.joinDate || '';
                document.getElementById('editStaffRole').value = user.role;
                document.getElementById('editStaffPassword').value = '';

                openModal('editStaffModal');
            } catch (error) {
                console.error('è¼‰å…¥å“¡å·¥è³‡æ–™å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
            }
        }

        async function updateStaff() {
            const name = document.getElementById('editStaffName').value.trim();
            const position = document.getElementById('editStaffPosition').value;
            const joinDate = document.getElementById('editStaffJoinDate').value;
            const role = document.getElementById('editStaffRole').value;
            const password = document.getElementById('editStaffPassword').value;

            if (!name || !joinDate) {
                showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡æ–™', 'warning');
                return;
            }

            try {
                const updateData = {
                    name: name,
                    position: position,
                    joinDate: joinDate,
                    role: role,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (password) {
                    updateData.password = password;
                }

                await db.collection('users').doc(currentItemId).update(updateData);

                showToast('âœ… å“¡å·¥è³‡æ–™æ›´æ–°æˆåŠŸ', 'success');
                closeModal('editStaffModal');
                loadStaffList();
            } catch (error) {
                console.error('æ›´æ–°å“¡å·¥è³‡æ–™å¤±æ•—:', error);
                showToast('âŒ æ›´æ–°å¤±æ•—', 'error');
            }
        }

        async function deleteStaff(userId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å“¡å·¥å—ï¼Ÿ')) return;

            try {
                await db.collection('users').doc(userId).delete();
                showToast('âœ… å“¡å·¥å·²åˆªé™¤', 'success');
                loadStaffList();
            } catch (error) {
                console.error('åˆªé™¤å“¡å·¥å¤±æ•—:', error);
                showToast('âŒ åˆªé™¤å¤±æ•—', 'error');
            }
        }

        // ==================== å·¥å…·å‡½æ•¸ ====================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;

            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // Enter éµç™»å…¥
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });
    </script>
</body>
</html>
